/*!ipacs4.0 - 1.0.0-2021-06-16 */
function getDPI(){var a=new Array;return void 0!=window.screen.deviceXDPI?(a[0]=window.screen.deviceXDPI,a[1]=window.screen.deviceYDPI):(a[0]=parseInt($("#dpi").width()),a[1]=parseInt($("#dpi").height())),a}function cm2px(a){var b=getDPI(),c=parseFloat(a)/25.4*b[0];return parseInt(c)}function mm2Px(a){var b=a/25.4,c=b*getDPI()[0];return Math.ceil(c)}function paperSizeMap(a){return[mm2Px(paperSizeMapStatic[a][0]),mm2Px(paperSizeMapStatic[a][1])]}function filmPaperSize(a,b){var c=$(".film-page-box").width(),d=$(".film-page-box").height(),e=Math.min(c/a[0],c/a[1],d/a[1],d/a[0]);return 1==parseInt(b)?(c=a[0]*e,d=a[1]*e):(c=a[1]*e,d=a[0]*e),[c,d]}function closeMarkTool(){$(".atom").each(function(){var a=$(this).get(0);"true"==$(this).attr("data-print-isFill")&&cornerstoneTools.textMarker.deactivate(a,1)})}function calcTextFont(a,b,c,d,e,f){var g=f/d,h=b*g;config.fontSize=.1*h,config.font=config.fontSize+"px  "+eSetting.film["default"].font}function selectedLength(a,b){var c=$(a).length;return b&&c<1&&pop_up({title:"提示",message:"请先选中有效单元格",yesName:"确定",noName:"取消"}),c}function changeMarkerText(){closeMarkTool(),$(".atom-check").each(function(){var a=$(this).get(0);if("true"==$(this).attr("data-print-isFill")){var b=cornerstoneTools.getElementToolStateManager(a);b.clear(a),cornerstone.updateImage(a),cornerstoneTools.textMarker.setConfiguration(config),cornerstoneTools.textMarker.activate(a,1)}})}function synAtomMagnify(a,b,c){var d=$("#"+b).get(0);$("#"+b).attr("data-print-imgId",c.imageId),$("#"+b).attr("data-print-seriesId",c.seriesId),d&&cornerstone.disable(d),cornerstone.enable(d),cornerstoneTools.mouseInput.enable(d),cornerstone.loadImage(c.imageId).then(function(b){cornerstone.displayImage(d,b),enableAllMeasureTools(d);var c=deepCopy1(cornerstone.getViewport(d)),e=$("#"+a).get(0),f=deepCopy1(cornerstone.getViewport(e));f.scale=c.scale,cornerstone.setViewport(d,f)})}function bindMagnifydblClick(a){var b={measureDivId:a};$("#openMeasure").click(function(){$(".atom-check").length>0&&"true"==$(".atom-check").attr("data-print-isFill")?(b.sourceId=$(".atom-check").attr("id"),b.imageId=$(".atom-check").attr("data-print-imgId"),b.seriesId=$(".atom-check").attr("data-print-seriesId"),setModeShow("print-magnify",!0),synAtomMagnify(b.sourceId,b.measureDivId,{imageId:b.imageId,seriesId:b.seriesId})):pop_up({title:"提示",message:"没有选中的图像，请先选择有效图像！",yesName:"确定",noName:"取消"})});var c={getTextCallback:getTextCallback,changeTextCallback:changeTextCallback,drawHandles:!1,drawHandlesOnHover:!0,arrowFirst:!0};$("#printLine").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.length.activate(a,1)}),$("#printArrows").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.arrowAnnotate.setConfiguration(c),cornerstoneTools.arrowAnnotate.activate(a,1),cornerstoneTools.arrowAnnotateTouch.activate(a)}),$("#printRect").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.rectangleRoi.activate(a,1)}),$("#printEllipse").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.ellipticalRoi.activate(a,1)}),$("#printAngle").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.angle.activate(a,1)}),$("#printWWWLmagnify").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstoneTools.mouseInput.enable(a),cornerstoneTools.mouseWheelInput.enable(a),cornerstoneTools.wwwc.activate(a,1)}),$("#printResetmagnify").click(function(){closeElementTools(b.measureDivId);var a=$("#"+b.measureDivId).get(0);cornerstone.reset(a)}),$("#printClear").click(function(){closeElementTools(b.measureDivId),clearElement($("#"+b.measureDivId).get(0))}),$("#closePrintMagnifyBox").click(function(){synAtomMagnify("imgMagnifyDiv",b.sourceId,{imageId:b.imageId,seriesId:b.seriesId}),closeElementTools("imgMagnifyDiv")})}function markReferLine(){synchronizer.destroy(),$(".atom").each(function(){if("true"==$(this).attr("data-print-isFill")){var a=$(this).get(0);synchronizer.add(a)}}),$(".atom-check").each(function(){if("true"==$(this).attr("data-print-isFill")){$(this).attr("data-print-referline",!0);var a=$(this).get(0);cornerstone.enable(a),cornerstoneTools.mouseInput.enable(a),cornerstoneTools.mouseWheelInput.enable(a),cornerstoneTools.referenceLines.tool.enable(a,synchronizer)}})}function cancleMarkReferLine(){synchronizer.destroy(),$(".atom-check").each(function(){if("true"==$(this).attr("data-print-isFill")){$(this).attr("data-print-referline",!1);var a=$(this).get(0);cornerstoneTools.referenceLines.tool.disable(a,synchronizer)}})}function printReferline(){synchronizer.destroy(),$(".atom").each(function(){if("true"==$(this).attr("data-print-isFill")){var a=$(this).get(0);synchronizer.add(a)}}),$(".atom-check").each(function(){if("true"==$(this).attr("data-print-isFill")){var a=$(this).get(0);"true"==$(this).attr("data-print-referline")?($(this).attr("data-print-referline",!1),cornerstoneTools.referenceLines.tool.disable(a,synchronizer)):($(this).attr("data-print-referline",!0),cornerstoneTools.referenceLines.tool.enable(a,synchronizer))}})}function printerShow(){com.getPrinter(callbacks.getPrinter)}function addLocalPrinter(a){var b=$(".printBoxSelect"),c="localPrinter",d=$("<option></option>").append(c);d.attr("data-id",0),d.attr("data-name",c),d.attr("data-printerType","local"),d.attr("data-ip","127.0.0.1"),d.attr("data-aet",c),d.attr("data-aetLocal",c),d.attr("data-port",c),d.attr("data-position",c),d.attr("data-type",c),d.attr("data-priority",c),d.attr("data-color",c),d.attr("data-magnifyType",c),a&&d.attr("selected",!0),b.append(d)}function reloadPrinter(a){200==a.status?printerShow():pop_up({title:"error提示",message:"请求失败，"+a.msg,yesName:"确定",noName:"取消"})}function addPrinter(a){com.addPrinter(a,reloadPrinter)}function modifyPrinter(a){com.updatePrinter(a,reloadPrinter)}function delePrinter(){var a=$(".printer-inner-check").attr("data-id");a&&com.delPrinter({id:a},reloadPrinter)}function emptyInfoScreenArr(){infoScreenArr.ltInfo.length=0,infoScreenArr.lbInfo.length=0,infoScreenArr.rtInfo.length=0,infoScreenArr.rbInfo.length=0}function tagShow(){function a(a){if(200==a.status){var b=JSON.parse(a.data.tagsData),c=$(".selectBox"),d=$("#ltTags"),e=$("#lbTags"),f=$("#rtTags"),g=$("#rbTags");c.empty(),d.empty(),e.empty(),f.empty(),g.empty(),b.forEach(function(a){var b=$('<div class="clearfix pull-right"><a class="moveUpBtn" href="javascript:;"  ><img src="../img/common/up.png"></a>&nbsp;<a class="moveDownBtn" href="javascript:;"  ><img src="../img/common/down.png"></a>&nbsp;<a class="deleteBtn" href="javascript:;"  ><img src="../img/common/delete.png"></a></div>'),c=$('<span class="pull-left"></span>').append(a.title),h=$('<li class="courseList"></li>');if(h.append(c,b),"data"in a)if(""==a.data){var h=$('<li class="tag-item"></li>');h.append(a.title),$(".selectBox").append(h)}else"lt"==a.data?d.append(h):"lb"==a.data?e.append(h):"rt"==a.data?f.append(h):"rb"==a.data&&g.append(h);else{var h=$('<li class="tag-item"></li>');h.append(a.title),$(".selectBox").append(h)}})}else pop_up({title:"error提示",message:"请求失败，"+a.msg,yesName:"确定",noName:"取消"})}com.getTags(a)}function addTag(){var a=$('<div class="clearfix pull-right"><a class="moveUpBtn" href="javascript:;"><span class="delTit">上移</span></a>&nbsp;<a class="moveDownBtn" href="javascript:;"><span class="delTit">下移</span></a>&nbsp;<a class="deleteBtn" href="javascript:;"><span class="delTit">删除</span></a></div>'),b=$('<span class="pull-left"></span>').append($(".tag-item-check").text()),c=$('<li class="courseList"></li>');c.append(b,a),$(".fontDiv ul").hasClass("activeUl")?($(".activeUl").append(c),$(".tag-item-check").remove()):pop_up({title:"提示",message:"请选中添加位置",yesName:"确定",noName:"取消"})}function getTagSet(){emptyInfoScreenArr();var a={ltTagset:[],lbTagset:[],rtTagset:[],rbTagset:[]};return $("#ltTags").find(".pull-left").each(function(){var b=$(this).text();a.ltTagset.push(b),infoScreenArr.ltInfo.push(infoDic[b])}),$("#rtTags").find(".pull-left").each(function(){var b=$(this).text();a.rtTagset.push(b),infoScreenArr.rtInfo.push(infoDic[b])}),$("#lbTags").find(".pull-left").each(function(){var b=$(this).text();a.lbTagset.push(b),infoScreenArr.lbInfo.push(infoDic[b])}),$("#rbTags").find(".pull-left").each(function(){var b=$(this).text();a.rbTagset.push(b),infoScreenArr.rbInfo.push(infoDic[b])}),a}function tagSetSave(){var a=getTagSet(),b=[];$(".tag-item").each(function(){b.push($(this).text())});for(var c=new Array,d=0,e=b.length;d<e;d++){var f={visible:!1,title:b[d],order:0,data:""};c.push(f)}for(var d=0,e=a.ltTagset.length;d<e;d++){var f={visible:!0,title:a.ltTagset[d],order:d,data:"lt"};c.push(f)}for(var d=0,e=a.lbTagset.length;d<e;d++){var f={visible:!0,title:a.lbTagset[d],order:d,data:"lb"};c.push(f)}for(var d=0,e=a.rtTagset.length;d<e;d++){var f={visible:!0,title:a.rtTagset[d],order:d,data:"rt"};c.push(f)}for(var d=0,e=a.rbTagset.length;d<e;d++){var f={visible:!0,title:a.rbTagset[d],order:d,data:"rb"};c.push(f)}var g={tagsData:c};com.updateTag(g,function(a){200==a.status?pop_up({title:"提示",message:"保存成功",yesName:"确定",noName:"取消"}):pop_up({title:"error提示",message:"请求失败，"+a.msg,yesName:"确定",noName:"取消"})})}function fillImage(a,b,c){c?$("#"+a).find(".info-show").remove():$("#"+a).find(".atomNum").remove();var d=$("#"+a).get(0);$("#"+a).attr("data-print-imgId",b.imageId),$("#"+a).attr("data-studyId",b.studyId),$("#"+a).attr("data-print-seriesId",b.seriesId),$("#"+a).attr("data-print-isFill","true"),cornerstone.disable(d),cornerstone.enable(d),cornerstoneTools.mouseInput.enable(d),cornerstone.loadImage(b.imageId).then(function(c){cornerstone.displayImage(d,c),cornerstoneTools.overlayTool.enable(d),cornerstoneTools.wwwc.activate(d,1),cornerstoneTools.orientationMarkers.enable(d),cornerstoneTools.length.enable(d),cornerstoneTools.ellipticalRoi.enable(d),cornerstoneTools.rectangleRoi.enable(d),cornerstoneTools.angle.enable(d),cornerstoneTools.arrowAnnotate.enable(d),cornerstoneTools.textMarker.enable(d),cornerstoneTools.clipping.disable(d),cornerstoneTools.wwwc.activate(d,4),fillInfoOnLay(a,b)})}function fillInfoOnLay(a,b){if("false"!=$("#"+a).attr("data-print-isfill")){$("#"+a).append(template("atomInfoTemp",infoScreenArr));var c=$("#"+a).get(0),d=cornerstone.getViewport(c),e=b.imageId,f=$("#"+a);$(f).find(".printViewportNo").remove(),$(f).find(".print-info-wwwl").text("WL/WW: "+Math.round(d.voi.windowCenter)+"/"+Math.round(d.voi.windowWidth));var g=dvStruct.getSuid(b.imageId),h=b.seriesId,i=g.seriesLength,j=dvStruct.findOriInfoByIds(e,h);if($("#"+a).attr("signId",j.signId),!_.isUndefined(j)){var k=dvStruct.countSNo(h);try{if(j.SeriesInfo.SliceThickness.val){var l=j.SeriesInfo.SliceThickness.val,m=j.SeriesInfo.SliceLocation.val;$(f).find(".print-TL").text("T: "+l+"mm L: "+m+"mm")}if($(f).find(".print-info-accessionNum").text(j.PatientInfo.AccessionNumber.val),$(f).find(".print-info-nowNo").text("Im: "+g.imgIndex+"/"+i),$(f).find(".print-info-SeNo").text("Se: "+k),j.PatientInfo.PatientName.val&&(dvStruct.share||$(f).find(".print-info-PatientName").text(j.PatientInfo.PatientName.val)),j.PatientInfo.PatientID.val&&$(f).find(".print-info-PatientID").text(j.PatientInfo.PatientID.val),j.PatientInfo.PatientsAge.val&&$(f).find(".print-info-PatientAgeSex").text(j.PatientInfo.PatientsAge.val+" "+j.PatientInfo.PatientSex.val),j.PatientInfo.PatientBirthDate.val){var n=j.PatientInfo.PatientBirthDate.val;$(f).find(".print-info-PatientBirthDate").text(n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2))}j.EquipmentInfo.InstitutionName.val&&(dvStruct.share||$(f).find(".print-info-InstitutionName").text(j.EquipmentInfo.InstitutionName.val)),j.StudyInfo.StudyDescription.val&&$(f).find(".print-info-StudyDescription").text(j.StudyInfo.StudyDescription.val),j.SeriesInfo.SeriesDescription.val&&$(f).find(".print-info-SeriesDescription").text(j.SeriesInfo.SeriesDescription.val),j.StudyInfo.BodyPartExamined.val&&$(f).find(".print-info-BodyPartExamined").text(j.StudyInfo.BodyPartExamined.val),j.SomeUsefulInfo.kvp.val&&$(f).find(".print-info-mAkvp").text(j.SomeUsefulInfo.kvp.val+"kV "+j.SomeUsefulInfo.mA.val+"mA");var o=j.UIDS.InstanceUID.val;o&&$(f).find(".print-info-CBZ").text(o),j.ImageInfo.FieldofView.val&&$(f).find(".print-info-fov").text("FOV:"+parseFloat(j.ImageInfo.FieldofView.val).toFixed(1)),j.SomeUsefulInfo.MagneticFieldStrength.val&&$(f).find(".print-info-MagneticFieldStrength").text("FS: "+j.SomeUsefulInfo.MagneticFieldStrength.val),(j.SomeUsefulInfo.RepetitionTime.val||j.SomeUsefulInfo.RepetitionTime.val)&&$(f).find(".print-info-TrTe").text("TR: "+j.SomeUsefulInfo.RepetitionTime.val+" TE: "+j.SomeUsefulInfo.EchoTime.val);var p=j.StudyInfo.StudyDate.val.toString();p&&$(f).find(".print-info-studyDate").text(p.substr(0,4)+"/"+p.substr(4,2)+"/"+p.substr(6,2));var q=j.StudyInfo.StudyTime.val.toString();q&&(q.indexOf(":")==-1&&(q=q.substr(0,2)+":"+q.substr(2,2)+":"+q.substr(2,2)),$(f).find(".print-info-studyTime").text(q)),j.ImageInfo.ImagePositionPatient.val&&$(f).find(".print-info-imgPosition").text(j.ImageInfo.ImagePositionPatient.val),j.ImageInfo.ImageOrientationPatient.val&&$(f).find(".print-info-imgOriention").text(j.ImageInfo.ImageOrientationPatient.val),j.SeriesInfo.Modality.val&&$(f).find(".print-info-modality").text(j.SeriesInfo.Modality.val),j.ImageInfo.SamplesPerPixel.val&&$(f).find(".print-info-samplesP").text(j.ImageInfo.SamplesPerPixel.val),j.SeriesInfo.SpacingBetweenSlices.val&&$(f).find(".print-info-SpacingBetweenSlices").text("层间距:"+j.SeriesInfo.SpacingBetweenSlices.val+"mm")}catch(r){console.log("screen info error",r)}$(f).width()<135?$(f).find(".info-show").hide():$(f).find(".info-show").show(),$(f).width<135&&$(f).find(".info-show").hide()}}}function fillImgWWWL(a){if("true"==$("#"+a).attr("data-print-isfill")){var b=$("#"+a).get(0),c=cornerstone.getViewport(b);$("#"+a).find(".print-info-wwwl").text("WC/WW: "+Math.round(c.voi.windowCenter)+"/"+Math.round(c.voi.windowWidth))}}function removeInnerboxNo(){$("div[imgIn=true]").find(".viewportBoxNo").hide(),$("div[imgIn=false]").find(".viewportBoxNo").show(),$("div[imgIn=false]").find(".printOverlay").hide(),infoLayShow()}function infoLayShow(){$("div[imgIn=true]").each(function(a,b){var c=$(this).height(),d=$(this).width(),e=$(this).find(".printOverlay-lt ").height()+$(this).find(".printOverlay-lb ").height(),f=$(this).find(".printOverlay-rt ").height()+$(this).find(".printOverlay-rb ").height(),g=$(this).find(".printOverlay-lt ").width()+$(this).find(".printOverlay-rt ").width(),h=$(this).find(".printOverlay-lb ").width()+$(this).find(".printOverlay-rb ").width(),i=Math.max(e,f),j=Math.max(g,h);i>c||j>d?$(this).find(".printOverlay").hide():$(this).find(".printOverlay").show()})}function resizeAtom(a){$(".atom[data-print-isFill=true]").each(function(){var b=$("#"+$(this).attr("id")).get(0);cornerstone.enable(b),a?cornerstoneTools.scaleOverlayTool.enable(b):cornerstoneTools.scaleOverlayTool.disable(b),cornerstone.resize(b,!0),$(this).width()<135?$(this).find(".info-show").hide():$(this).find(".info-show").show()})}function updateAtomMarkers(a){$(".atom[data-print-isFill=true]").each(function(){var b=$("#"+$(this).attr("id")).get(0);a?cornerstoneTools.scaleOverlayTool.enable(b):cornerstoneTools.scaleOverlayTool.disable(b),$(this).width()<135?$(this).find(".info-show").hide():$(this).find(".info-show").show()})}function jpegPrint(a){function b(b){if(200==b.status){var c="printArea";$("iframe#"+c).remove();var d=c,e="position:absolute;width:100%;height:100%;left:-10000px;top:-10000px;",f=document.createElement("IFRAME");$(f).attr({style:e,id:d}),document.body.appendChild(f);var g=$("body").data("print"),h=g.isShow,i=g.header,j=g.addr,k=g.tele,l=g.logoPath,m=b.data[0].name,n=b.data[0].ageView,o=b.data[0].gender,p=b.data[0].outpatientNum,q=b.data[0].admissionNum,r=f.contentWindow.document;if(r.write('<link type="text/css" rel="stylesheet" href="../css/printfilm/film.css?v=1.2" >'),h)for(var s=0,t=a.length;s<t;s++){var u="_"+a[s].paperType+"_"+a[s].paperDirect;r.write(template("jpgPrintTemp",{paperSet:u,logoPath:l,hosName:i,imgData:a[s].img,addr:j,tele:k,showState:h,age:n,name:m,gender:o,labelNumber:q?q:p?p:"--"}))}else for(var s=0,t=a.length;s<t;s++){var u="_"+a[s].paperType+"_"+a[s].paperDirect;r.write('<div class="film '+u+'"  style="margin:0;padding:0;border: none;"><img class="filmImg"   src='+a[s].img+'   style="width:100%;height:100%;margin:0;padding:0; "></div>')}r.close();var v=f.contentWindow;v.close(),v.focus(),setTimeout(function(){v.print()},800)}else pop_up({type:"error",title:"提示",message:b.msg,yesName:"确定",noName:"取消"})}com.detail(b)}function connectPrintServer(a){if(!socketPrinter||1!=socketPrinter.readyState){var b=0;if("WebSocket"in window)try{socketPrinter=new WebSocket(eSetting.addrIni.printServer),socketPrinter.onopen=function(){1==socketPrinter.readyState&&a.text("已连接")},socketPrinter.onmessage=function(a){console.log("我发消息了-------------",a)},socketPrinter.onclose=function(a){console.log("我关闭了-------------",a)},socketPrinter.error=function(a){console.log("我出错了-------------",a)}}catch(c){b=3,console.log(c)}else b=-1;socketPrinter&&(b=2),setTimeout(function(){1!=socketPrinter.readyState&&(socketConnectionTips(b),a.text("连接失败"))},3e3)}}function callPrinter(a,b,c,d,e,f,g,h){var i=$("body").data("studyId"),j=[];for(var k in g)"_"==k.charAt(0)&&j.push(k.substring(1,k.length));var l={printerId:b,studyId:i.split(",")[0],studyIds:j.join(","),paperSize:d,printDirection:1==e?"PORTRAIT":"LANDSCAPE",printNum:1,remark:f.join(","),imageData:h,applyType:a};com.saveRecord(l,this.exeResult),setTimeout(function(){com.getJpgPrint(function(a){a.data.forEach(function(a){if(console.log(a),a.iconsDisplay&&a.iconsDisplay.length>0)return $(".print-record").show(),$(".print-record").click(function(){var a="print-record.html?studyId="+window.btoa(com.param("studyId"))+"&token="+window.btoa(com.param("token"));window.open(a,"print-record","_blank")}),!1})})},1e3)}function sendDataPrint(a,b){var c=$(".film-set-box").data("type"),d="1"==$(".film-set-box").data("direct")?"PORTRAIT":"LANDSCAPE",e=getPrinterSet(),f="print",g="serviceType:"+f+"#orientation:"+d+"#filmSize:"+c+"#copys:1#IP:"+e.ip+"#port:"+e.port+"#AET:"+e.aet+"#localAET:"+e.aetLocal+"#filmObj:"+e.position+"#filmType:"+e.type+"#quality:"+e.priority+"#grayEnable:"+e.color+"#magnifyType:"+e.magnifyType;return console.log(b,"本地dcm打印发送参数："+g,e),socketPrinter?void(1!=socketPrinter.readyState?(connectPrintServer($(".verify-printer-state")),setTimeout(function(){1!=socketPrinter.readyState?pop_up({type:"warning",title:"打印服务连接提示",message:"tips5:链接服务失败，请检查打印服务是否开启!",yesName:"确定",noName:"取消"}):(socketPrinter.send(g),socketPrinter.send(convertImgDataToBlob(a)),console.log(b,"成功发送打印数据",g))},1e3)):(socketPrinter.send(g),socketPrinter.send(convertImgDataToBlob(a)),console.log(b,"成功发送打印数据",socketPrinter))):void pop_up({type:"warning",title:"打印服务连接提示",message:"tips4:创建链接失败，请下载打印服务!\r\t下载该服务请点击确定按钮！",ok:downloadPrintServe,yesName:"确定",noName:"取消"})}function synShowtoPrint(a,b,c,d,e){var f=$("#"+b).get(0);cornerstone.enable(f),cornerstoneTools.overlayTool.enable(f),cornerstone.loadImage(c).then(function(b){cornerstone.displayImage(f,b),enableAllMeasureTools(f,d,e,flimScaleOverlayTool);var c=deepCopy1(cornerstone.getViewport(f)),g=$("#"+a).get(0),h=deepCopy1(cornerstone.getViewport(g));h.scale=c.scale,cornerstone.setViewport(f,h)})}function darg2atom(a,b){getTagSet();var c=$("#"+a).parents(".film-page").attr("id"),d=$("#"+a).parents(".unit").attr("id"),e=$("#"+a).parents(".cell").attr("id"),f=[];pageTraverse(c,d,e,a,f),b.dragArr=b.dragArr.concat(f);var g=$(".film-page-check").find("div[data-print-isFill=false]").first().attr("id");if(g){var h=g==a?a:g;reFillAtom(h,b.dragArr),deleNouseFilmPage()}else console.log("需要新增加胶片页")}function reFillAtom(a,b){var c=a;b.forEach(function(a){c=$(".film-page-check").find(".atom[data-print-isFill='false']").first().attr("id"),void 0==c&&($(".film-page-check").next().length<1&&addFilmPage("last"),changeFilmPage("next"),c=$(".film-page-check").find(".atom[data-print-isFill='false']").first().attr("id")),fillImage(c,a);var b=$("#"+c).get(0);b.addEventListener("cornerstoneimagerendered",function(a){if("true"==$("#"+c).attr("data-print-isfill")){var b=a.target,d=cornerstone.getViewport(b);$("#"+c).find(".print-info-wwwl").text("WC/WW: "+Math.round(d.voi.windowCenter)+"/"+Math.round(d.voi.windowWidth))}})}),atomOrderNum(),statistics()}function deleNouseFilmPage(){for(;$(".film-page-check").next().length>0;)$(".film-page-check").next().remove();0==$(".film-page-check").find(".atom[data-print-isfill=true]").length&&$(".film-page").length>1&&($(".film-page-check").remove(),$(".film-page").last().removeClass("film-page-uncheck"),$(".film-page").last().addClass("film-page-check"));var a=$(".film-page-check").index(".film-page")+1;$(".cur-film-page").val(a),$(".total-film-page").text($(".film-page").length)}function atomTraverse(a,b){if("true"==$("#"+a).attr("data-print-isFill")){if("true"!=$("#"+a).attr("data-print-delete")){var c={studyId:$("#"+a).attr("data-studyId"),imageId:$("#"+a).attr("data-print-imgId"),seriesId:$("#"+a).attr("data-print-seriesId")};b.push(c)}var d=guid(8,"atom"),e=$("#"+a).attr("style"),f='<div class="atom" id="'+d+'" style="'+e+'" data-print-isFill="false"></div>';$("#"+a).before(f),$("#"+a).remove()}if(!($("#"+d).next().length>0&&"true"==$("#"+d).next().attr("data-print-isFill")))return!0;var g=$("#"+d).next().attr("id");atomTraverse(g,b)}function cellTraverse(a,b,c){if(!b)return!0;if(atomTraverse(b,c),!($("#"+a).next().length>0&&$("#"+a).next().find('.atom[data-print-isFill="true"]').length>0))return!0;var d=$("#"+a).next().attr("id"),e=$("#"+a).next().find('.atom[data-print-isFill="true"]').first().attr("id");cellTraverse(d,e,c)}function unitTraverse(a,b,c,d){if(!b)return!0;if(cellTraverse(b,c,d),!($("#"+a).next().length>0&&$("#"+a).next().find('.atom[data-print-isFill="true"]').length>0))return!0;var e=$("#"+a).next().attr("id"),f=$("#"+a).next().find(".cell").first().attr("id"),g=$("#"+a).next().find('.atom[data-print-isFill="true"]').first().attr("id");unitTraverse(e,f,g,d)}function pageTraverse(a,b,c,d,e){if(!a)return!0;if(unitTraverse(b,c,d,e),!($("#"+a).next().length>0&&$("#"+a).next().find('.atom[data-print-isFill="true"]').length>0))return!0;var f=$("#"+a).next().attr("id"),g=$("#"+f).find(".unit").first().attr("id"),h=$("#"+g).find(".cell").first().attr("id"),i=$("#"+h).find('.atom[data-print-isFill="true"]').first().attr("id");pageTraverse(f,g,h,i,e)}function getPaperSet(){var a=$(".film-set-box").data("type")||eSetting.film["default"].type,b=$(".film-set-box").data("direct")||eSetting.film["default"].direct,c=$(".film-set-box").data("rows")||eSetting.film["default"].row,d=$(".film-set-box").data("cols")||eSetting.film["default"].col,e={paperType:a,paperDirect:b,rows:parseInt(c),cols:parseInt(d)};return e}function getPaperSetCookie(){var a=com.cookie("film-layout"),b=eSetting.film["default"].col,c=eSetting.film["default"].row;if(""!=a&&a.indexOf("*")!=-1){var d=a.split("*");c=parseInt(d[0]),b=parseInt(d[1])}var e=com.cookie("paper-type"),f=com.cookie("paper-direct");return"v"!=e&&"v"!=f&&""!=e&&""!=f||(e=eSetting.film["default"].type,f=eSetting.film["default"].direct),{paperType:e,paperDirect:f,rows:c,cols:b}}function changePaperSet(a){$(".film-set-box").data("type",a.paperType),$(".film-set-box").data("direct",a.paperDirect),$(".film-set-box").data("rows",a.rows),$(".film-set-box").data("cols",a.cols),$("input[type=radio][name=paperType][value="+a.paperType+"]").prop("checked",!0),$("input[type=radio][name=direct][value="+a.paperDirect+"]").prop("checked",!0),$("input[type=text][name=layout-rows]").val(a.rows),$("input[type=text][name=layout-cols]").val(a.cols)}function changePaperSetCookie(a){com.cookie("paper-type",a.paperType,720),com.cookie("paper-direct",a.paperDirect,720),com.cookie("film-layout",a.rows+"*"+a.cols,720)}function calcFontsize(a,b){var c=Math.min(a,b),d=eSetting.film.fontSize._min;if("scale"==eSetting.film.fontMode){var e=(c-800)/800;e<0?(d=parseInt((1+e/2)*eSetting.film.fontBase),d<10&&(d=12)):d=parseInt((1+e/2)*eSetting.film.fontBase)}else d=c<300?eSetting.film.fontSize._300:c>=300&&c<500?eSetting.film.fontSize._305:c>=500&&c<700?eSetting.film.fontSize._507:c>=700&&c<900?eSetting.film.fontSize._709:c>=900&&c<1e3?eSetting.film.fontSize._910:c>=1e3&&c<1100?eSetting.film.fontSize._101:eSetting.film.fontSize._max;return d}function calcFontsizeAsSet(a,b,c){var d,e=Math.min(a,b),f=(e-800)/800;return f<0?(d=parseInt((1+f/2)*c),d<10&&(d=12)):d=parseInt((1+f/2)*c),d}function getFontHeight(a,b){var c,d=document.createElement("div");return d.id="fontHeight",d.style.cssText="padding:0;visibility:hidden;font-family:"+b+";font-size:"+a+"px",d.innerHTML="测试",document.body.appendChild(d),c=d.offsetHeight,$("#fontHeight").remove(),c}function tagViewport(a,b){var c=$("#tagsPreView").height(),d=(c-b)/2;$("#tagViewport").css("margin-top",d),$("#tagViewport").width(a),$("#tagViewport").height(b);var e="tagViewport",f="dobuleViewport";const g="example://1",h=document.getElementById(f);cornerstone.disable(h),cornerstone.enable(h),cornerstone.loadImage(g).then(function(a){cornerstone.displayImage(h,a),cornerstoneTools.orientationMarkers.enable(h)}),h.addEventListener("cornerstoneimagerendered",function(c){$("#"+f).children("canvas").attr("id","doubleViewCanv");var d=$("#"+f).find(".cornerstone-canvas").get(0),g=getTagSet();drawFilmInfo(d,{ltInfo:g.ltTagset,rtInfo:g.rtTagset,lbInfo:g.lbTagset,rbInfo:g.rbTagset,fontsize:12}),copyDoubleToPreview(f,e,a,b)})}function filmSetPreview(a,b,c){try{var d=$("#tagsPreView").height(),e=(d-b)/2;$("#tagViewport").css("margin-top",e),$("#tagViewport").width(a),$("#tagViewport").height(b);var f="tagViewport",g="dobuleViewport";$("#"+g).width(2*a),$("#"+g).height(2*b);var h=$("#"+f).attr("data-imageId"),i=$("#"+g).get(0);$("#"+g).attr("imageId",h),cornerstone.disable(i),cornerstone.enable(i),cornerstoneTools.mouseInput.enable(i),cornerstone.loadImage(h).then(function(a){cornerstone.displayImage(i,a),cornerstoneTools.orientationMarkers.enable(i)});var j=imgInfoAsSet(0,h,400,40);j.fontsize=calcFontsize(2*a,2*b),i.addEventListener("cornerstoneimagerendered",function(c){$("#"+g).children("canvas").attr("id","doubleViewCanv");var d=$("#"+g).find(".cornerstone-canvas").get(0);drawFilmInfo(d,j),copyDoubleToPreview(g,f,a,b)})}catch(k){tagViewport(a,b,c)}}function copyDoubleToPreview(a,b,c,d){var e=$("#"+a).find(".cornerstone-canvas").get(0),f=e.toDataURL("image/jpeg"),g=new Image;g.src=f;var h=$("#"+b).find("canvas").get(0),i=h.getContext("2d");g.onload=function(){i.drawImage(g,0,0,c,d)}}function buildFilmData(a,b,c,d,e){var f=$("#"+b).attr("data-paper-type"),g=parseInt($("#"+b).attr("data-paper-direct")),h=paperSizeMap(f),i=1==g?h[0]:h[1],j=1==g?h[1]:h[0],k=$("#"+b).width(),l=$("#"+b).height(),m=Math.ceil(i*c),n=Math.ceil(j*c),o={w:m/k,h:n/l},p=guid(8,"filmtemp"),q=$("<canvas id="+p+"></canvas>");$(".film-temp-box").append(q);var r=$("#"+p)[0];r.width=m,r.height=n;var s=r.getContext("2d");s.fillRect(0,0,m,n);var t=[$("#"+b).offset().left,$("#"+b).offset().top],u=$("body").data("studyId");return traverseDrawAtom(b,t,o,s,d).then(function(c){var d=new Promise(function(d,h){if(c.isFilmExist){var i=r.toDataURL("image/jpeg"),j=$(".printBoxSelect option:selected").attr("data-id");callPrinter(a,j,u,f,g,c.urls,c.studyIds,i.substring(23,i.length));var k={img:i,paperType:f,paperDirect:g};e&&sendDataPrint(i,b),dvStruct.filmData.push(k)}else console.log("film not exit");$("#"+p).remove(),d(dvStruct.filmData)});return d})}function traverseDrawAtom(a,b,c,d,e){var f=localStorage.getItem("printInfoShow");null==f&&(f=!0);var g=!1,h=$("#"+a).find(".atom[data-print-isFill=true]").length,i=[],j=[],k=new Promise(function(k,l){0==h?k({isFilmExist:g,urls:i,studyIds:j}):$("#"+a).find(".unit").each(function(a,l){$(l).find(".cell").each(function(a,l){$(l).find(".atom[data-print-isFill=true]").each(function(a,l){g=!0;var m=[$(l).offset().left,$(l).offset().top],n=[m[0]-b[0],m[1]-b[1]],o=$(l).width(),p=$(l).height(),q=o*c.w,r=p*c.h,s={xstart:n[0]*c.w,ystart:n[1]*c.h,xend:(n[0]+o)*c.w,yend:(n[1]+p)*c.h},t=$(l).attr("data-print-imgId");i.push($(l).attr("signId"));var u=$(l).attr("data-studyId");j["_"+u]=!0;var v=$(l).attr("id"),w=guid(8,"atomtemp"),x=$('<div class="atomTemp" id='+w+"></div>");$(".atom-temp-box").append(x),$("#"+w).width(q),$("#"+w).height(r);var y="true"==$("#"+v).attr("data-print-referline"),z=getPrintInfo(v);z.fontsize=calcFontsize(q,r);var A=$("#"+w).get(0);cornerstone.enable(A),A.addEventListener("cornerstoneimagerendered",function(a){setTimeout(function(){var a=$("#"+w).find(".cornerstone-canvas").get(0);"true"!=f&&1!=f||drawFilmInfo(a,z),d.drawImage(a,s.xstart,s.ystart,q,r),$("#"+w).remove(),--h<=0&&k({isFilmExist:g,urls:i,studyIds:j})},100)}),cornerstone.loadImage(t).then(function(a){cornerstone.displayImage(A,a),enableAllMeasureTools(A,y,e,flimScaleOverlayTool);var b=$("#"+v).get(0),c=deepCopy1(cornerstone.getViewport(b));cornerstone.setViewport(b,c),c.scale*=Math.min(q/o,r/p),cornerstone.setViewport(A,c),cornerstoneTools.overlayTool.enable(A)})})})})});return k}function drawFilmInfo(a,b){var c=a.getContext("2d");c.fillStyle="white",c.font=b.fontsize+"px  "+eSetting.film["default"].font,c.globalCompositeOperation="source-over";for(var d=a.width/2,e=getFontHeight(b.fontsize,eSetting.film["default"].font),f=3,g=0,h=f+e/2+3,i=0,j=b.ltInfo.length;i<j;i++)c.setTransform(1,0,0,1,0,0),c.beginPath(),c.scale(1,1),c.textAlign="start",c.fillText(b.ltInfo[i],2,h,d),h+=e/2+f;h=f+e/2;for(var i=0,j=b.lbInfo.length;i<j;i++)g=a.height-h,c.setTransform(1,0,0,1,0,0),c.beginPath(),c.scale(1,1),c.textAlign="start",c.fillText(b.lbInfo[b.lbInfo.length-1-i],2,g,d),h+=e/2+f;h=f+e/2+3;for(var i=0,j=b.rtInfo.length;i<j;i++)c.setTransform(1,0,0,1,0,0),c.beginPath(),c.scale(1,1),c.textAlign="end",c.fillText(b.rtInfo[i],a.width,h,d),h+=e/2+f;h=f+e/2;for(var i=0,j=b.rbInfo.length;i<j;i++)c.setTransform(1,0,0,1,0,0),c.beginPath(),c.scale(1,1),g=a.height-h,c.textAlign="end",c.fillText(b.rbInfo[b.rbInfo.length-1-i],a.width,g,d),h+=e/2+f}function imgInfoAsSet(a,b,c,d){var e;e=dvStruct.findOriInfoOnlyByOriId(b);var f,g=dvStruct.getSuid(b);if(b.indexOf("loadJoinImg")<0){if(void 0!=g.seriesId&&void 0!=g.imgIndex){var h=getTagSet();f=creatInfoDataAsSet(e,g,c,d,h.ltTagset,h.rtTagset,h.lbTagset,h.rbTagset)}}else{var i=parseInt(b.substring(14)),f={ltInfo:[],lbInfo:[],rtInfo:[],rbInfo:[]};f.ltInfo.push(joinOutputObj[i].hosName),f.rtInfo.push(joinOutputObj[i].name),f.rtInfo.push(joinOutputObj[i].age+" "+joinOutputObj[i].sex),f.rtInfo.push(joinOutputObj[i].birthDate.substr(0,4)+"/"+joinOutputObj[i].birthDate.substr(4,2)+"/"+joinOutputObj[i].birthDate.substr(6,2)),f.rbInfo.push(joinOutputObj[i].describe),f.rbInfo.push(joinOutputObj[i].studyDate.substr(0,4)+"/"+joinOutputObj[i].studyDate.substr(4,2)+"/"+joinOutputObj[i].studyDate.substr(6,2)),f.lbInfo.push("WW/WL:"+c+"/"+d)}return f}function creatInfoDataAsSet(a,b,c,d,e,f,g,h){var i,j={ltInfo:[],lbInfo:[],rtInfo:[],rbInfo:[],fontsize:12};j.ltInfo.length=0,j.lbInfo.length=0,j.rtInfo.length=0,j.rbInfo.length=0;for(var k=0,l=e.length;k<l;k++){var m=e[k];if("序列编号"==m&&b.seriesLength>0&&(i="Se:"+b.se,j.ltInfo.push(i)),"图像序号"==m&&b.seriesLength>0&&(i="Im:"+b.imgIndex+"/"+b.seriesLength,j.ltInfo.push(i)),"窗位窗宽"==m&&(i="WL/WW:"+c+"/"+d,j.ltInfo.push(i)),"机构名称"==m&&a.EquipmentInfo.InstitutionName.val&&(i=a.EquipmentInfo.InstitutionName.val,j.ltInfo.push(i)),"患者姓名"==m&&a.PatientInfo.PatientName.val&&(i=a.PatientInfo.PatientName.val,j.ltInfo.push(i)),"患者ID号"==m&&a.PatientInfo.PatientID.val&&(i=a.PatientInfo.PatientID.val,j.ltInfo.push(i)),"患者年龄/性别"==m&&(a.PatientInfo.PatientsAge.val||a.PatientInfo.PatientSex.val)&&(i=a.PatientInfo.PatientsAge.val+" "+a.PatientInfo.PatientSex.val,
j.ltInfo.push(i)),"患者出生日期"==m){var n=a.PatientInfo.PatientBirthDate.val;if(n&&a.PatientInfo.PatientBirthDate.val){var o=n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2);j.ltInfo.push(o)}}if("检查部位"==m&&(i=a.StudyInfo.BodyPartExamined.val,j.ltInfo.push(i)),"序列描述"==m&&a.SeriesInfo.SeriesDescription.val&&(i=a.SeriesInfo.SeriesDescription.val,j.ltInfo.push(i)),"检查描述"==m&&a.StudyInfo.StudyDescription.val&&(i=a.StudyInfo.StudyDescription.val,j.ltInfo.push(i)),"InstanceUID"==m){var p=a.UIDS.InstanceUID.val;p&&p.CBZ&&j.ltInfo.push(p.CBZ)}if("千伏/毫安"==m&&(i=null,a.SomeUsefulInfo.kvp.val&&(i=a.SomeUsefulInfo.kvp.val+"kV"),a.SomeUsefulInfo.mA.val&&(null==i?i=a.SomeUsefulInfo.mA.val+"mA":i+=" "+a.SomeUsefulInfo.mA.val+"mA"),null!=i&&j.ltInfo.push(i)),"FOV"==m&&a.ImageInfo.FieldofView.val&&(i="FOV:"+parseFloat(a.ImageInfo.FieldofView.val).toFixed(1),j.ltInfo.push(i)),"FS"==m&&a.SomeUsefulInfo.MagneticFieldStrength.val&&(i="FS: "+a.SomeUsefulInfo.MagneticFieldStrength.val,j.ltInfo.push(i)),"TR/TE"==m&&(a.SomeUsefulInfo.RepetitionTime.val||a.SomeUsefulInfo.RepetitionTime.val)&&(i="TR: "+a.SomeUsefulInfo.RepetitionTime.val+" TE: "+a.SomeUsefulInfo.EchoTime.val,j.ltInfo.push(i)),"检查日期"==m){var q=a.StudyInfo.StudyDate.val.toString(),r=a.StudyInfo.StudyTime.val.toString();q&&r&&(i=q.substr(0,4)+"/"+q.substr(4,2)+"/"+q.substr(6,2),j.ltInfo.push(i))}if("层厚/实际相对位置"==m){var s=a.SeriesInfo.SliceThickness.val,t=a.SeriesInfo.SliceLocation.val;if(s||t){try{s=s?parseFloat(s).toFixed(1):s,t=t?parseFloat(t).toFixed(1):t}catch(u){console.error(u)}i="T/L:"+s+"/"+t}j.ltInfo.push(i)}if("层间距"==m){var v=a.SeriesInfo.SpacingBetweenSlices.val;if(v){try{v=v?parseFloat(v).toFixed(1):v}catch(u){console.error(u)}i="SBS:"+v+"mm",j.ltInfo.push(i)}}if("图像位置"==m&&a.ImageInfo.ImagePositionPatient.val&&(i=a.ImageInfo.ImagePositionPatient.val,j.ltInfo.push(i)),"检查模态"==m&&a.SeriesInfo.Modality.val&&(i=a.SeriesInfo.Modality.val,j.ltInfo.push(i)),"图像方位"==m&&a.ImageInfo.ImageOrientationPatient.val&&(i=a.ImageInfo.ImageOrientationPatient.val,j.ltInfo.push(i)),"检查时间"==m){var r=a.StudyInfo.StudyTime.val.toString();r&&(r.indexOf(":")==-1&&(r=r.substr(0,2)+":"+r.substr(2,2)+":"+r.substr(2,2)),i=r,j.ltInfo.push(i))}"采样率"==m&&a.ImageInfo.SamplesPerPixel.val&&(i=a.ImageInfo.SamplesPerPixel.val,j.ltInfo.push(i)),"登记编号"==m&&a.PatientInfo.AccessionNumber.val&&(i=a.PatientInfo.AccessionNumber.val,j.ltInfo.push(i))}for(var k=0,l=g.length;k<l;k++){var m=g[k];if("序列编号"==m&&b.seriesLength>0&&(i="Se:"+b.se,j.lbInfo.push(i)),"图像序号"==m&&b.seriesLength>0&&(i="Im:"+b.imgIndex+"/"+b.seriesLength,j.lbInfo.push(i)),"窗位窗宽"==m&&(i="WL/WW:"+c+"/"+d,j.lbInfo.push(i)),"机构名称"==m&&a.EquipmentInfo.InstitutionName.val&&(i=a.EquipmentInfo.InstitutionName.val,j.lbInfo.push(i)),"图像位置"==m&&a.ImageInfo.ImagePositionPatient.val&&(i=a.ImageInfo.ImagePositionPatient.val,j.lbInfo.push(i)),"检查模态"==m&&a.SeriesInfo.Modality.val&&(i=a.SeriesInfo.Modality.val,j.lbInfo.push(i)),"图像方位"==m&&a.ImageInfo.ImageOrientationPatient.val&&(i=a.ImageInfo.ImageOrientationPatient.val,j.lbInfo.push(i)),"检查时间"==m){var r=a.StudyInfo.StudyTime.val.toString();r&&(r.indexOf(":")==-1&&(r=r.substr(0,2)+":"+r.substr(2,2)+":"+r.substr(2,2)),i=r,j.lbInfo.push(i))}if("采样率"==m&&a.ImageInfo.SamplesPerPixel.val&&(i=a.ImageInfo.SamplesPerPixel.val,j.lbInfo.push(i)),"患者姓名"==m&&a.PatientInfo.PatientName.val&&(i=a.PatientInfo.PatientName.val,j.lbInfo.push(i)),"患者ID号"==m&&a.PatientInfo.PatientID.val&&(i=a.PatientInfo.PatientID.val,j.lbInfo.push(i)),"患者年龄/性别"==m&&(a.PatientInfo.PatientsAge.val||a.PatientInfo.PatientSex.val)&&(i=a.PatientInfo.PatientsAge.val+" "+a.PatientInfo.PatientSex.val,j.lbInfo.push(i)),"患者出生日期"==m){var n=a.PatientInfo.PatientBirthDate.val;if(n&&a.PatientInfo.PatientBirthDate.val){var o=n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2);j.lbInfo.push(o)}}if("检查部位"==m&&(i=a.StudyInfo.BodyPartExamined.val,j.lbInfo.push(i)),"检查描述"==m&&a.StudyInfo.StudyDescription.val&&(i=a.StudyInfo.StudyDescription.val,j.lbInfo.push(i)),"序列描述"==m&&a.SeriesInfo.SeriesDescription.val&&(i=a.SeriesInfo.SeriesDescription.val,j.lbInfo.push(i)),"InstanceUID"==m){var p=a.UIDS.InstanceUID.val;p&&p.CBZ&&j.lbInfo.push(p.CBZ)}if("千伏/毫安"==m&&(i=null,a.SomeUsefulInfo.kvp.val&&(i=a.SomeUsefulInfo.kvp.val+"kV"),a.SomeUsefulInfo.mA.val&&(null==i?i=a.SomeUsefulInfo.mA.val+"mA":i+=" "+a.SomeUsefulInfo.mA.val+"mA"),null!=i&&j.lbInfo.push(i)),"FOV"==m&&a.ImageInfo.FieldofView.val&&(i="FOV:"+parseFloat(a.ImageInfo.FieldofView.val).toFixed(1),j.lbInfo.push(i)),"FS"==m&&a.SomeUsefulInfo.MagneticFieldStrength.val&&(i="FS: "+a.SomeUsefulInfo.MagneticFieldStrength.val,j.lbInfo.push(i)),"TR/TE"==m&&(a.SomeUsefulInfo.RepetitionTime.val||a.SomeUsefulInfo.RepetitionTime.val)&&(i="TR: "+a.SomeUsefulInfo.RepetitionTime.val+" TE: "+a.SomeUsefulInfo.EchoTime.val,j.lbInfo.push(i)),"检查日期"==m){var q=a.StudyInfo.StudyDate.val.toString();q&&(i=q.substr(0,4)+"/"+q.substr(4,2)+"/"+q.substr(6,2),j.lbInfo.push(i))}if("层厚/实际相对位置"==m){var s=a.SeriesInfo.SliceThickness.val,t=a.SeriesInfo.SliceLocation.val;if(s||t){try{s=s?parseFloat(s).toFixed(1):s,t=t?parseFloat(t).toFixed(1):t}catch(u){console.error(u)}i="T/L:"+s+"/"+t,j.lbInfo.push(i)}}if("层间距"==m){var v=a.SeriesInfo.SpacingBetweenSlices.val;if(v){try{v=v?parseFloat(v).toFixed(1):v}catch(u){console.error(u)}i="SBS:"+v+"mm",j.lbInfo.push(i)}}"登记编号"==m&&a.PatientInfo.AccessionNumber.val&&(i=a.PatientInfo.AccessionNumber.val,j.lbInfo.push(i))}for(var k=0,l=f.length;k<l;k++){var m=f[k];if("序列编号"==m&&b.seriesLength>0&&(i="Se:"+b.se,j.rtInfo.push(i)),"图像序号"==m&&b.seriesLength>0&&(i="Im:"+b.imgIndex+"/"+b.seriesLength,j.rtInfo.push(i)),"窗位窗宽"==m&&(i="WL/WW:"+c+"/"+d,j.rtInfo.push(i)),"机构名称"==m&&a.EquipmentInfo.InstitutionName.val&&(i=a.EquipmentInfo.InstitutionName.val,j.rtInfo.push(i)),"患者姓名"==m&&a.PatientInfo.PatientName.val&&(i=a.PatientInfo.PatientName.val,j.rtInfo.push(i)),"患者ID号"==m&&a.PatientInfo.PatientID.val&&(i=a.PatientInfo.PatientID.val,j.rtInfo.push(i)),"患者年龄/性别"==m&&(a.PatientInfo.PatientsAge.val||a.PatientInfo.PatientSex.val)&&(i=a.PatientInfo.PatientsAge.val+" "+a.PatientInfo.PatientSex.val,j.rtInfo.push(i)),"患者出生日期"==m){var n=a.PatientInfo.PatientBirthDate.val;if(n&&a.PatientInfo.PatientBirthDate.val){var o=n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2);j.rtInfo.push(o)}}if("检查部位"==m&&(i=a.StudyInfo.BodyPartExamined.val,j.rtInfo.push(i)),"检查描述"==m&&a.StudyInfo.StudyDescription.val&&(i=a.StudyInfo.StudyDescription.val,j.rtInfo.push(i)),"序列描述"==m&&a.SeriesInfo.SeriesDescription.val&&(i=a.SeriesInfo.SeriesDescription.val,j.rtInfo.push(i)),"InstanceUID"==m){var p=a.UIDS.InstanceUID.val;p&&p.CBZ&&j.rtInfo.push(p.CBZ)}if("千伏/毫安"==m&&(i=null,a.SomeUsefulInfo.kvp.val&&(i=a.SomeUsefulInfo.kvp.val+"kV"),a.SomeUsefulInfo.mA.val&&(null==i?i=a.SomeUsefulInfo.mA.val+"mA":i+=" "+a.SomeUsefulInfo.mA.val+"mA"),null!=i&&j.rtInfo.push(i)),"FOV"==m&&a.ImageInfo.FieldofView.val&&(i="FOV:"+parseFloat(a.ImageInfo.FieldofView.val).toFixed(1),j.rtInfo.push(i)),"FS"==m&&a.SomeUsefulInfo.MagneticFieldStrength.val&&(i="FS: "+a.SomeUsefulInfo.MagneticFieldStrength.val,j.rtInfo.push(i)),"TR/TE"==m&&(a.SomeUsefulInfo.RepetitionTime.val||a.SomeUsefulInfo.RepetitionTime.val)&&(i="TR: "+a.SomeUsefulInfo.RepetitionTime.val+" TE: "+a.SomeUsefulInfo.EchoTime.val,j.rtInfo.push(i)),"检查日期"==m){var q=a.StudyInfo.StudyDate.val.toString(),r=a.StudyInfo.StudyTime.val.toString();q&&r&&(i=q.substr(0,4)+"/"+q.substr(4,2)+"/"+q.substr(6,2),j.rtInfo.push(i))}if("层厚/实际相对位置"==m){var s=a.SeriesInfo.SliceThickness.val,t=a.SeriesInfo.SliceLocation.val;if(s||t){try{s=s?parseFloat(s).toFixed(1):s,t=t?parseFloat(t).toFixed(1):t}catch(u){console.error(u)}i="T/L:"+s+"/"+t}j.rtInfo.push(i)}if("层间距"==m){var v=a.SeriesInfo.SpacingBetweenSlices.val;if(v){try{v=v?parseFloat(v).toFixed(1):v}catch(u){console.error(u)}i="SBS:"+v+"mm",j.rtInfo.push(i)}}if("图像位置"==m&&a.ImageInfo.ImagePositionPatient.val&&(i=a.ImageInfo.ImagePositionPatient.val,j.rtInfo.push(i)),"检查模态"==m&&a.SeriesInfo.Modality.val&&(i=a.SeriesInfo.Modality.val,j.rtInfo.push(i)),"图像方位"==m&&a.ImageInfo.ImageOrientationPatient.val&&(i=a.ImageInfo.ImageOrientationPatient.val,j.rtInfo.push(i)),"检查时间"==m){var r=a.StudyInfo.StudyTime.val.toString();r&&(r.indexOf(":")==-1&&(r=r.substr(0,2)+":"+r.substr(2,2)+":"+r.substr(2,2)),i=r,j.rtInfo.push(i))}"采样率"==m&&a.ImageInfo.SamplesPerPixel.val&&(i=a.ImageInfo.SamplesPerPixel.val,j.rtInfo.push(i)),"登记编号"==m&&a.PatientInfo.AccessionNumber.val&&(i=a.PatientInfo.AccessionNumber.val,j.rtInfo.push(i))}for(var k=0,l=h.length;k<l;k++){var m=h[k];if("序列编号"==m&&b.seriesLength>0&&(i="Se:"+b.se,j.rbInfo.push(i)),"图像序号"==m&&b.seriesLength>0&&(i="Im:"+b.imgIndex+"/"+b.seriesLength,j.rbInfo.push(i)),"窗位窗宽"==m&&(i="WL/WW:"+c+"/"+d,j.rbInfo.push(i)),"机构名称"==m&&a.EquipmentInfo.InstitutionName.val&&(i=a.EquipmentInfo.InstitutionName.val,j.rbInfo.push(i)),"患者姓名"==m&&a.PatientInfo.PatientName.val&&(i=a.PatientInfo.PatientName.val,j.rbInfo.push(i)),"患者ID号"==m&&a.PatientInfo.PatientID.val&&(i=a.PatientInfo.PatientID.val,j.rbInfo.push(i)),"患者年龄/性别"==m&&(a.PatientInfo.PatientsAge.val||a.PatientInfo.PatientSex.val)&&(i=a.PatientInfo.PatientsAge.val+" "+a.PatientInfo.PatientSex.val,j.rbInfo.push(i)),"患者出生日期"==m){var n=a.PatientInfo.PatientBirthDate.val;if(n&&a.PatientInfo.PatientBirthDate.val){var o=n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2);j.rbInfo.push(o)}}if("检查部位"==m&&(i=a.StudyInfo.BodyPartExamined.val,j.rbInfo.push(i)),"检查描述"==m&&a.StudyInfo.StudyDescription.val&&(i=a.StudyInfo.StudyDescription.val,j.rbInfo.push(i)),"序列描述"==m&&a.SeriesInfo.SeriesDescription.val&&(i=a.SeriesInfo.SeriesDescription.val,j.rbInfo.push(i)),"InstanceUID"==m){var p=a.UIDS.InstanceUID.val;p&&p.CBZ&&j.rbInfo.push(p.CBZ)}if("千伏/毫安"==m&&(i=null,a.SomeUsefulInfo.kvp.val&&(i=a.SomeUsefulInfo.kvp.val+"kV"),a.SomeUsefulInfo.mA.val&&(null==i?i=a.SomeUsefulInfo.mA.val+"mA":i+=" "+a.SomeUsefulInfo.mA.val+"mA"),null!=i&&j.rbInfo.push(i)),"FOV"==m&&a.ImageInfo.FieldofView.val&&(i="FOV:"+parseFloat(a.ImageInfo.FieldofView.val).toFixed(1),j.rbInfo.push(i)),"FS"==m&&a.SomeUsefulInfo.MagneticFieldStrength.val&&(i="FS: "+a.SomeUsefulInfo.MagneticFieldStrength.val,j.rbInfo.push(i)),"TR/TE"==m&&(a.SomeUsefulInfo.RepetitionTime.val||a.SomeUsefulInfo.RepetitionTime.val)&&(i="TR: "+a.SomeUsefulInfo.RepetitionTime.val+" TE: "+a.SomeUsefulInfo.EchoTime.val,j.rbInfo.push(i)),"检查日期"==m){var q=a.StudyInfo.StudyDate.val.toString(),r=a.StudyInfo.StudyTime.val.toString();q&&r&&(i=q.substr(0,4)+"/"+q.substr(4,2)+"/"+q.substr(6,2),j.rbInfo.push(i))}if("层厚/实际相对位置"==m){var s=a.SeriesInfo.SliceThickness.val,t=a.SeriesInfo.SliceLocation.val;if(s||t){try{s=s?parseFloat(s).toFixed(1):s,t=t?parseFloat(t).toFixed(1):t}catch(u){console.error(u)}i="T:"+s+"mm L:"+t+"mm"}j.rbInfo.push(i)}if("层间距"==m){var v=a.SeriesInfo.SpacingBetweenSlices.val;if(v){try{v=v?parseFloat(v).toFixed(1):v}catch(u){console.error(u)}i="SBS:"+v+"mm"}j.rbInfo.push(i)}if("图像位置"==m&&a.ImageInfo.ImagePositionPatient.val&&(i=a.ImageInfo.ImagePositionPatient.val,j.rbInfo.push(i)),"检查模态"==m&&a.SeriesInfo.Modality.val&&(i=a.SeriesInfo.Modality.val,j.rbInfo.push(i)),"图像方位"==m&&a.ImageInfo.ImageOrientationPatient.val&&(i=a.ImageInfo.ImageOrientationPatient.val,j.rbInfo.push(i)),"检查时间"==m){var r=a.StudyInfo.StudyTime.val.toString();r&&(r.indexOf(":")==-1&&(r=r.substr(0,2)+":"+r.substr(2,2)+":"+r.substr(2,2)),i=r,j.rbInfo.push(i))}"采样率"==m&&a.ImageInfo.SamplesPerPixel.val&&(i=a.ImageInfo.SamplesPerPixel.val,j.rbInfo.push(i)),"登记编号"==m&&a.PatientInfo.AccessionNumber.val&&(i=a.PatientInfo.AccessionNumber.val,j.rbInfo.push(i))}return j}function getPrintInfo(a){var b={fontsize:12,rtInfo:[],ltInfo:[],rbInfo:[],lbInfo:[]};return $("#"+a).find(".left-top-info").find(".atom-info").each(function(){isEmpty($(this).text())||b.ltInfo.push($(this).text())}),$("#"+a).find(".right-top-info").find(".atom-info").each(function(){isEmpty($(this).text())||b.rtInfo.push($(this).text())}),$("#"+a).find(".left-bottom-info").find(".atom-info").each(function(){isEmpty($(this).text())||b.lbInfo.push($(this).text())}),$("#"+a).find(".right-bottom-info").find(".atom-info").each(function(){isEmpty($(this).text())||b.rbInfo.push($(this).text())}),b}function enableAllTools(a){a&&(cornerstoneTools.mouseInput.enable(a),cornerstoneTools.wwwc.enable(a),cornerstoneTools.pan.enable(a),cornerstoneTools.zoom.enable(a),cornerstoneTools.magnify.enable(a),cornerstoneTools.probe.enable(a),cornerstoneTools.length.enable(a),cornerstoneTools.eraser.enable(a),cornerstoneTools.ellipticalRoi.enable(a),cornerstoneTools.rectangleRoi.enable(a),cornerstoneTools.angle.enable(a),cornerstoneTools.rotate.enable(a),cornerstoneTools.freehand.enable(a),cornerstoneTools.heartScale.enable(a),cornerstoneTools.deviation.enable(a),cornerstoneTools.simpleAngle.enable(a))}function closeElementTools(a){var b=$("#"+a).get(0);b&&(cornerstoneTools.length.deactivate(b,1),cornerstoneTools.ellipticalRoi.deactivate(b,1),cornerstoneTools.rectangleRoi.deactivate(b,1),cornerstoneTools.angle.deactivate(b,1),cornerstoneTools.arrowAnnotate.deactivate(b,1),cornerstoneTools.arrowAnnotateTouch.deactivate(b,1),cornerstoneTools.wwwc.deactivate(b,1))}function clearElement(a){a&&(cornerstoneTools.clearToolState(a,"length"),cornerstoneTools.clearToolState(a,"rectangleRoi"),cornerstoneTools.clearToolState(a,"ellipticalRoi"),cornerstoneTools.clearToolState(a,"angle"),cornerstoneTools.arrowAnnotate.disable(a),cornerstoneTools.arrowAnnotateTouch.disable(a),cornerstoneTools.clearToolState(a,"arrowAnnotate"))}function enableImgTools(a,b){cornerstoneTools.mouseInput.enable(b),cornerstoneTools.mouseWheelInput.enable(b),Object.keys(imgToolsMap).forEach(function(c){a==c?imgToolsMap[c](b,!0):imgToolsMap[c](b,!1)}),"wwwc"==a&&"default"!=a||cornerstoneTools.wwwc.activate(b,4)}function enableAllMeasureTools(a,b,c,d){cornerstoneTools.length.enable(a),cornerstoneTools.ellipticalRoi.enable(a),cornerstoneTools.rectangleRoi.enable(a),cornerstoneTools.angle.enable(a),cornerstoneTools.arrowAnnotate.enable(a),cornerstoneTools.textMarker.enable(a),cornerstoneTools.orientationMarkers.enable(a),b&&cornerstoneTools.referenceLines.tool.enable(a,c),d&&cornerstoneTools.scaleOverlayTool.enable(a)}function imgToolsDispatch(a,b){a.each(function(){var a=$(this).get(0);if(a){var c=cornerstone.getViewport(a);if(c)if("horizontal-flip"==b){var d=!1;90!=c.rotation&&c.rotation!=-90&&270!=c.rotation&&c.rotation!=-270||(d=!0),d?c.vflip=!c.vflip:c.hflip=!c.hflip,cornerstone.setViewport(a,c)}else if("vertical-flip"==b){var d=!1;90!=c.rotation&&c.rotation!=-90&&270!=c.rotation&&c.rotation!=-270||(d=!0),d?c.hflip=!c.hflip:c.vflip=!c.vflip,cornerstone.setViewport(a,c)}else"right-rotate"==b?(c.rotation=(c.rotation+90)%360,cornerstone.setViewport(a,c)):"left-rotate"==b?(c.rotation=(c.rotation-90)%360,cornerstone.setViewport(a,c)):"invert"==b?(c.invert=!c.invert,cornerstone.setViewport(a,c)):"reset"==b?cornerstone.reset(a):"default"!=b&&"zoom"!=b&&"pan"!=b&&"rotate"!=b&&"wwwc"!=b&&"clipping"!=b||(enableImgTools(b,a),"clipping"!=b&&cornerstoneTools.clipping.disable(a))}})}function getSelecNodes(a){switch(a){case"img":return 1==$(".unit-check").length?[$(".atom-check[data-print-isFill=true]")]:[$(".unit-check").find(".atom[data-print-isFill=true]")];case"series":var b=$(".atom-check").attr("data-print-seriesId"),c='.atom[data-print-seriesId="'+b+'"]',d=$(".film-page-check").find(c),e=$(".film-page-uncheck").find(c);return[d,e];case"page":return[$(".film-page-check").find(".atom[data-print-isFill=true]")];case"all":var d=$(".film-page-check").find(".atom[data-print-isFill=true]"),e=$(".film-page-uncheck").find(".atom[data-print-isFill=true]");return[d,e];default:console.log("啥也没有选！===",a)}}function imgToolSync(a,b,c){a.each(function(){var a=$(this).get(0),d=cornerstone.getViewport(a);if(d&&a){if("rotate"==b)d.rotation=c.rotation,cornerstone.setViewport(a,d);else if("zoom"==b){var e=c.displayedArea.brhc,f=d.displayedArea.brhc,g=Math.min(e.x/f.x,e.y/f.y);d.scale=c.scale*g,cornerstone.setViewport(a,d)}else"pan"==b?(d.translation=c.translation,cornerstone.setViewport(a,d)):"wwwc"==b&&(d.voi.windowCenter=c.voi.windowCenter,d.voi.windowWidth=c.voi.windowWidth,cornerstone.setViewport(a,d));cornerstone.updateImage(a)}})}function getSynGroup(a){var b=new cornerstoneTools.Synchronizer("CornerstoneNewImage",cornerstoneTools.updateImageSynchronizer);return"print"==a&&$(".atom").each(function(){if("true"==$(this).attr("data-print-isFill")){var a=$(this).get(0);b.add(a)}}),b}function getTextCallback(a){function b(a){13===a.which&&c()}function c(){d.get(0).close(),a(e.val()),e.val("")}var d=$(".annotationDialog"),e=d.find(".annotationTextInput"),f=d.find(".annotationDialogConfirm");d.get(0).showModal(),f.off("click"),f.on("click",function(){c()}),d.off("keydown"),d.on("keydown",b)}function changeTextCallback(a,b,c){function d(a){13===a.which&&e()}function e(){f.get(0).close(),c(a,g.val()),g.val("")}var f=$(".relabelDialog"),g=f.find(".annotationTextInput"),h=f.find(".relabelConfirm"),i=f.find(".relabelRemove");g.val(a.annotationText),f.get(0).showModal(),h.off("click"),h.on("click",function(){f.get(0).close(),c(a,g.val())}),i.off("click"),i.on("click",function(){f.get(0).close(),c(a,void 0,!0)}),f.off("keydown"),f.on("keydown",d)}function initPaperSize(a,b,c){var d=filmPaperSize(paperSizeMap(a.paperType),a.paperDirect),e=$(".film-page-box").width(),f=$(".film-page-box").height(),g=(f-d[1])/2,h=(e-d[0])/2;c?($(".film-page").css({width:d[0],height:d[1],"margin-top":g,"margin-left":h}),$(".film-page").attr("data-paper-type",a.paperType),$(".film-page").attr("data-paper-direct",a.paperDirect)):($("#"+b).css({width:d[0],height:d[1],"margin-top":g,"margin-left":h}),$("#"+b).attr("data-paper-type",a.paperType),$("#"+b).attr("data-paper-direct",a.paperDirect))}function initLayout(a,b,c){var d=splitMap[0];d.unitRow=a.rows,d.unitCol=a.cols;var e=a.rows*a.cols;if(c){$(".film-page").empty(),$(".film-page").attr("data-rows",a.rows),$(".film-page").attr("data-cols",a.cols);for(var f=0;f<e;f++)d.id=guid(8,"unit"),$(".film-page").append(template("unitBoxTemp",d))}else{$("#"+b).empty(),$("#"+b).attr("data-rows",a.rows),$("#"+b).attr("data-cols",a.cols);for(var f=0;f<e;f++)d.id=guid(8,"unit"),$("#"+b).append(template("unitBoxTemp",d))}atomOrderNum()}function atomOrderNum(){$(".film-page").each(function(){$(this).find(".atom").each(function(a,b){"false"==$(this).attr("data-print-isfill")&&($(this).find(".atomNum").remove(),$(this).append('<span class="atomNum">'+(a+1)+"</span>"))})})}function statistics(){var a={};$(".atom[data-print-isFill=true]").each(function(){var b=$(this).attr("data-print-seriesId");a[b]=b});var b=Object.keys(a),c=$(".atom[data-print-isFill=true]").length,d=b.length,e=0;$(".film-page").each(function(){$(this).find(".atom[data-print-isFill=true]").length>0&&e++}),$('label[for="img"').text("图像("+c+")"),$('label[for="series"').text("序列("+d+")"),$('label[for="page"').text("页("+e+")")}function changeFilmPage(a,b){$(".unit-check").removeClass("unit-check"),$(".atom-check").removeClass("atom-check"),"prev"==a?$(".film-page-check").prev().length>=1&&$(".film-page-check").prev().hasClass("film-page")&&$(".film-page-check").prev().addClass("film-page-check").siblings().removeClass("film-page-check"):"last"==a?$(".film-page").last().addClass("film-page-check").siblings().removeClass("film-page-check"):"first"==a?$(".film-page").first().addClass("film-page-check").siblings().removeClass("film-page-check"):"next"==a?$(".film-page-check").next().length>0&&$(".film-page-check").next().addClass("film-page-check").siblings().removeClass("film-page-check"):b&&($("#"+b).length>0?($(".film-page").removeClass("film-page-check"),$("#"+b).addClass("film-page-check")):$(".film-page").last().addClass("film-page-check").siblings().removeClass("film-page-check"));var c=$(".film-page-check").index(".film-page")+1;$(".cur-film-page").val(c),$(".total-film-page").text($(".film-page").length);var d=parseInt($(".film-page-check").attr("data-rows")),e=parseInt($(".film-page-check").attr("data-cols")),f={rows:d,cols:e,paperType:$(".film-page-check").attr("data-paper-type"),paperDirect:$(".film-page-check").attr("data-paper-direct")};return $(".film-page-check").removeClass("film-page-uncheck"),$(".film-page-check").siblings().addClass("film-page-uncheck"),f}function addFilmPage(a){var b=guid(8,"page"),c='<div class="film-page" id="'+b+'"></div>';"after"==a?$(".film-page-check").after(c):"before"==a?$(".film-page-check").before(c):$(".film-page-box").append(c);var d=getPaperSet();initPaperSize(d,b,!1),initLayout(d,b,!1),atomOrderNum()}function deleteFilmPage(){var a,b=parseInt($(".total-film-page").text()),c=parseInt($(".cur-film-page").val()),d=$(".film-page-check").attr("id");b==c?(1==c&&addFilmPage("before"),a=changeFilmPage("first")):a=changeFilmPage("next"),$("#"+d).remove(),changePaperSet(a),changePaperSetCookie(a);var e=$(".film-page-check").index(".film-page")+1;$(".cur-film-page").val(e),$(".total-film-page").text($(".film-page").length)}function initFilmTypes(a){$(".paper-type-box").empty(),a.forEach(function(a,b){$(".paper-type-box").append(template("paperTemp",{paperType:a}))}),$("input[type=radio][name=paperType]").change(function(){$(".film-set-box").data("type",$(this).val()),changeFilmSet()})}function changeFilmSet(){var a=getPaperSet();console.log(a),changePaperSetCookie(a),$(".film-page").each(function(){var b=$(this).attr("id");initPaperSize(a,b,!0)}),resizeAtom()}function clearFilm(){$(".film-page :not(:first)").remove();var a="page0",b=getPaperSetCookie(),c=com.cookie("filmTypes");c&&(c=c.split(","),initFilmTypes(c)),changePaperSet(b),initPaperSize(b,a),initLayout(b,a,!1)}var paperSizeMapStatic=new Array;paperSizeMapStatic.A5=[148,209],paperSizeMapStatic.A4=[210,296],paperSizeMapStatic.A3=[297,419],paperSizeMapStatic["8INX10IN"]=[203,254],paperSizeMapStatic["8_5INX11IN"]=[215,279],paperSizeMapStatic["10INX12IN"]=[254,304],paperSizeMapStatic["10INX14IN"]=[254,355],paperSizeMapStatic["11INX14IN"]=[279,355],paperSizeMapStatic["11INX17IN"]=[279,431],paperSizeMapStatic["14INX14IN"]=[355,355],paperSizeMapStatic["14INX17IN"]=[355,431],paperSizeMapStatic["24CMX24CM"]=[240,240],paperSizeMapStatic["24CMX30CM"]=[240,300],paperSizeMapStatic["default"]=[210,296];var config={markers:["L5","L4","L3","L2","L1","T12","T11","T10","T9","T8","T7","T6","T5","T4","T3","T2","T1","C7","C6","C5","C4","C3","C2","C1"],current:"A",font:"30px  "+eSetting.film["default"].font,fontSize:30},infoDic=new Array;infoDic["序列编号"]="print-info-SeNo",infoDic["图像序号"]="print-info-nowNo",infoDic["窗位窗宽"]="print-info-wwwl",infoDic["机构名称"]="print-info-InstitutionName",infoDic["患者姓名"]="print-info-PatientName",infoDic["患者ID号"]="print-info-PatientID",infoDic["患者年龄/性别"]="print-info-PatientAgeSex",infoDic["患者出生日期"]="print-info-PatientBirthDate",infoDic["检查部位"]="print-info-BodyPartExamined",infoDic["检查描述"]="print-info-StudyDescription",infoDic["序列描述"]="print-info-SeriesDescription",infoDic["千伏/毫安"]="print-info-mAkvp",infoDic.FOV="print-info-fov",infoDic.FS="print-info-MagneticFieldStrength",infoDic["TR/TE"]="print-info-TrTe",infoDic["检查日期"]="print-info-studyDate",infoDic["层厚/实际相对位置"]="print-TL",infoDic["层间距"]="print-info-SpacingBetweenSlices",infoDic["图像位置"]="print-info-imgPosition",infoDic["检查模态"]="print-info-modality",infoDic["图像方位"]="print-info-imgOriention",infoDic["检查时间"]="print-info-studyTime",infoDic["采样率"]="print-info-samplesP",infoDic["登记编号"]="print-info-accessionNum";var infoScreenArr={ltInfo:["print-info-nowNo","print-info-SeNo","print-info-BodyPartExamined","print-info-StudyDescription","print-info-SeriesDescription"],lbInfo:["print-info-zoom","print-info-wwwl","print-info-TL"],rtInfo:["print-info-accessionNum","print-info-InstitutionName","print-info-PatientName","print-info-PatientID","print-info-PatientBirthDate","print-info-PatientAgeSex"],rbInfo:["print-info-mAkvp","print-info-MagneticFieldStrength","print-info-TrTe","print-info-studyDate"]},convertImgDataToBlob=function(a){for(var b="image/jpeg",c=a,d=window.atob(c.split(",")[1]),e=new window.ArrayBuffer(d.length),f=new window.Uint8Array(e),g=0;g<d.length;g++)f[g]=255&d.charCodeAt(g);var h=null;try{h=new Blob([f],{type:b})}catch(i){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==i.name&&window.BlobBuilder){var j=new window.BlobBuilder;j.append(f.buffer),h=j.getBlob("image/jpeg")}else"InvalidStateError"==i.name&&(h=new Blob([e],{type:b}))}return h};if(!dvStruct)var dvStruct={};dvStruct.filmData=[],dvStruct.print={curToolType:"default",filmData:[],imgData:[]};var splitMap=new Array;splitMap[0]={unitRow:1,unitCol:1,rows:1,cols:1,cells:[{rows:1,cols:1}],guid:guid},splitMap[1]={unitRow:2,unitCol:1,rows:2,cols:1,cells:[{rows:1,cols:1},{rows:1,cols:1}],guid:guid},splitMap[2]={unitRow:2,unitCol:1,rows:1,cols:2,cells:[{rows:1,cols:1},{rows:1,cols:1}],guid:guid},splitMap[3]={unitRow:2,unitCol:1,rows:2,cols:1,cells:[{rows:1,cols:1},{rows:1,cols:2}],guid:guid},splitMap[4]={unitRow:2,unitCol:1,rows:1,cols:2,cells:[{rows:1,cols:1},{rows:2,cols:1}],guid:guid},splitMap[5]={unitRow:2,unitCol:1,rows:2,cols:2,cells:[{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1}],guid:guid},splitMap[6]={unitRow:2,unitCol:1,rows:3,cols:2,cells:[{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1}],guid:guid},splitMap[7]={unitRow:2,unitCol:1,rows:2,cols:3,cells:[{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1}],guid:guid},splitMap[8]={unitRow:2,unitCol:1,rows:3,cols:3,cells:[{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1},{rows:1,cols:1}],guid:guid};var imgToolsMap=new Array;imgToolsMap.wwwc=function(a,b){b?cornerstoneTools.wwwc.activate(a,1):cornerstoneTools.wwwc.deactivate(a,1)},imgToolsMap.pan=function(a,b){b?cornerstoneTools.pan.activate(a,1):cornerstoneTools.pan.deactivate(a,1)},imgToolsMap.rotate=function(a,b){b?cornerstoneTools.rotate.activate(a,1):cornerstoneTools.rotate.deactivate(a,1)},imgToolsMap.zoom=function(a,b){b?cornerstoneTools.zoom.activate(a,1):cornerstoneTools.zoom.deactivate(a,1)},imgToolsMap.clipping=function(a,b){b?(cornerstoneTools.clipping.enable(a),cornerstoneTools.clipping.activate(a,1)):(cornerstoneTools.clipping.disable(a),cornerstoneTools.clipping.deactivate(a,1))};var synchronizerWWWC=new cornerstoneTools.Synchronizer("CornerstoneImageRendered",cornerstoneTools.wwwcSynchronizer),synchronizerZoomPan=new cornerstoneTools.Synchronizer("CornerstoneImageRendered",cornerstoneTools.panZoomSynchronizer);$(function(){function a(){var a=[],b=$(".film-page").first().attr("id"),c=$("#"+b).find(".unit").first().attr("id"),d=$("#"+c).find(".cell").first().attr("id"),e=$("#"+d).find(".atom").first().attr("id");pageTraverse(b,c,d,e,a);var f=getPaperSet();$(".film-page").first().addClass("film-page-check").siblings().remove(),initLayout(f,b,!1),changeFilmPage("first");var g=$(".film-page-check").find("div[data-print-isFill=false]").first().attr("id");reFillAtom(g,a)}function b(){var a=localStorage.getItem("printInfoShow");null==a&&localStorage.setItem("printInfoShow",!0),a=!0,1!=a&&"true"!=a||$('input:checkbox[name="printInfoShow"]').prop("checked",!0)}$(document).on("mouseenter",".atom canvas",function(){$(".magnify").hasClass("activeBtn")&&$(this).parent().css({cursor:"zoom-in"}),$(".move").hasClass("activeBtn")&&$(this).parent().css({cursor:"move"}),$(".rotateMin").hasClass("activeBtn")&&$(this).parent().css({cursor:"-webkit-grab"}),$(".wwwl").hasClass("activeBtn")&&$(this).parent().css({cursor:"url(../img/pointer/wwwl.cur),auto"})}),$(document).on("mouseleave",".atom canvas",function(){$(this).parent().css({cursor:"default"})}),$(document).on("mousemove",".atom canvas",function(a){if(3==a.which)return $(a.target).parents(".printWrapper").addClass("imgBoxSelected"),$(a.target).parents(".printViewport").addClass("imgViewportSelected"),$(this).parent().css({cursor:"url(../img/pointer/wwwl.cur),auto"}),!1}),$(document).on("mousedown",".atom canvas",function(a){if(3==a.which)return!1});var c=!1;$(document).on("dblclick",".atom canvas",function(a){$(".unit").removeClass("unit-check"),$(".atom").removeClass("atom-check"),$(".atom").removeClass("atom-chose"),$(this).parents(".atom").addClass("atom-check"),$(this).parents(".unit").addClass("unit-check"),$(this).parents(".film-page").addClass("film-page-check").siblings().removeClass("film-page-check"),$(".film-page-check").removeClass("film-page-uncheck"),$(".film-page-check").siblings().addClass("film-page-uncheck");var b=$(a.target).parents(".atom").attr("id"),d=$("#"+b).get(0);if(d){var e=cornerstoneTools.getToolState(d,"clipping");if(e&&e.data&&e.data.length>0){var f=e.data[0].handles.start,g=e.data[0].handles.end,h=cornerstone.pixelToCanvas(d,f),i=cornerstone.pixelToCanvas(d,g),j={x:a.offsetX,y:a.offsetY},k={left:Math.min(h.x,i.x),top:Math.min(h.y,i.y),width:Math.abs(h.x-i.x),height:Math.abs(h.y-i.y)},l=!1;if(j.x>=k.left&&j.x<=k.left+k.width&&j.y>=k.top&&j.y<=k.top+k.height&&(l=!0),c&&l){var m=$("#"+b).attr("data-print-studyId"),n=$("#"+b).attr("data-print-imgId"),o=$("#"+b).attr("data-print-seriesId"),p=dvStruct.findOriInfoByIds(n,o),q=cornerstone.getEnabledElement(d),r=q.image,s=eSetting.tool.clipping.magnifySize,t=r.width*s,u=r.height*s,v=guid(8,"clip");$(".cointainer-box").append(template("clipTemp",{id:v,width:t,height:u}));var w=$("#"+v).get(0);cornerstone.enable(w),cornerstone.loadImage(n).then(function(a){cornerstone.displayImage(w,a),cornerstoneTools.overlayTool.enable(w),w.addEventListener("cornerstoneimagerendered",function(){var a={left:Math.round(Math.min(f.x*s,g.x*s)),top:Math.round(Math.min(f.y*s,g.y*s)),width:Math.ceil(Math.abs(f.x*s-g.x*s)),height:Math.ceil(Math.abs(f.y*s-g.y*s))},c=$("#"+v).find(".cornerstone-canvas").get(0),d=c.getContext("2d"),e=d.getImageData(a.left,a.top,a.width,a.height);d.fillStyle="black",d.fillRect(0,0,c.width,c.height),d.putImageData(e,a.left,a.top),c=$("#"+v).find(".cornerstone-canvas").get(0);var h=c.toDataURL("image/jpeg"),i={studyId:p.studyId,imgDataStr:h.substring(23,h.length),pixelSpacing:r.columnPixelSpacing/s+"\\"+r.rowPixelSpacing/s};new com.AjaxRequest({type:"POST",url:"dicom/uploadJoinImage",desc:"图像裁剪",param:JSON.stringify(i),isShowLoader:!0,dataType:"json",callBack:function(a){if(200==a.status){var c=a.data.url,d=a.data.id,e="wadouri:"+c;cornerstone.loadAndCacheImage(e).then(function(c){if(_.isObject(c)&&_.isObject(c.data)){dvStruct.imgObjArr.push(c);var f=JSON.parse(a.msg),g=getDicomInfo(c.data);changeInfo(g,f),g.signId=d,g.isSign=!1,g.studyId=a.data.studyId;var h={studyId:m,dataSet:c.data,infoSet:g,imageId:c.imageId,instanceNo:g.InstanceInfo.InstanceNumber.val,signId:d},i=dvStruct.findSeries(a.data.seriesId),j=1;i&&(j=i.dicomArr.length);var k={studyId:a.data.studyId,studyDateTime:a.data.examDate,seriesNo:a.data.sNum,seriesId:a.data.seriesId,url:a.data.url,imageType:a.data.imageType,signId:a.data.id,isSign:!1,inatanceNo:g.InstanceInfo.InstanceNumber.val,imageId:a.data.url,totalCount:j,detail:f,index:1};dvStruct.addDicom(h,k),fillImage(b,{imageId:e,seriesId:a.data.seriesId},!0),$(".series-shrink").show()}else console.log("notObj")})["catch"](function(a){console.log("图像加载报错",a),pop_up({type:"error",title:"裁剪图像保存提示",message:"裁剪图像上传成功，因为跨域问题无法加载到图像列表，请联系工程师。是否退出拼接页面？",yesName:"确定",noName:"取消"})})}}})})})}else c=!1,cornerstoneTools.clipping.disable(d)}}}),$(document).on("mouseup",".atom canvas",function(a){var b=dvStruct.print.curToolType;3==a.which&&($(this).parent().css({cursor:"default"}),hotKeyMap.shiftDown||(b="wwwc"));var c=$(".atom-check").attr("id"),d=$("#"+c).get(0);if(d){var e=cornerstone.getViewport(d),f=$(".print-proc-box").attr("data-procType"),g=getSelecNodes(f);g.forEach(function(a){imgToolSync(a,b,e)})}}),$(".print-work-box,.print-control-box").on("contextmenu",function(a){return!1}),$(".calBox .btnStyle3").bind("click",function(){$(this).addClass("activeBtn").siblings().removeClass("activeBtn"),
$(".btnStyle3").each(function(){var a=$(this).attr("data-img");$(this).hasClass("activeBtn")?$(this).css("background",'url("../img/print/'+a+'") no-repeat  -80px 0'):$(this).css("background",'url("../img/print/'+a+'") no-repeat  0 0')})}),$(".direction-label li").bind("click",function(){$(this).addClass("directionStyle").siblings().removeClass("directionStyle")}),$("#printSetww, #printSetwc").bind("keypress",function(a){if("13"==a.keyCode){var b=$("#printSetww").val(),c=$("#printSetwc").val();isNaN(b)||isNaN(c)||printQuickWindow({ww:b,wc:c,exist:!0}),$("#printSetww").blur(),$(" #printSetwc").blur()}}),$(document).on("mousedown",".atom",function(a){if(hotKeyMap.ctrlDown)$(this).parents(".unit").addClass("unit-check"),$(this).parents(".unit").find(".atom").addClass("atom-chose"),$(".atom").removeClass("atom-check"),$(this).addClass("atom-check");else if(hotKeyMap.shiftDown){$(this).parents(".unit").addClass("unit-check"),$(this).parents(".unit").find(".atom").addClass("atom-chose");for(var b=$(".unit-check").first().index(),c=$(".unit-check").last().index(),d=b;d<c;d++)$(".film-page-check .unit").eq(d).addClass("unit-check"),$(".film-page-check .unit").eq(d).find(".atom").addClass("atom-chose");$(".atom").removeClass("atom-check"),$(this).addClass("atom-check")}else $(this).parents(".unit").hasClass("unit-check")||$(this).hasClass("atom-check")?($(".atom").removeClass("atom-check"),$(this).addClass("atom-check")):($(".unit").removeClass("unit-check"),$(".atom").removeClass("atom-chose"),$(".atom").removeClass("atom-check"),$(this).addClass("atom-check"),$(this).parents(".unit").addClass("unit-check"));$(this).parents(".film-page").addClass("film-page-check").siblings().removeClass("film-page-check"),$(".film-page-check").removeClass("film-page-uncheck"),$(".film-page-check").siblings().addClass("film-page-uncheck")}),bindMagnifydblClick("imgMagnifyDiv"),$(".paper-set").bind("change",function(){var a=getPaperSet();changePaperSetCookie(a),$(".film-page").each(function(){var b=$(this).attr("id");initPaperSize(a,b,!0)}),resizeAtom()}),$("input[type=radio][name=direct]").change(function(){$(".film-set-box").data("direct",$(this).val()),changeFilmSet()}),$("input[type=radio][name=paperType]").change(function(){$(".film-set-box").data("type",$(this).val()),changeFilmSet()}),$(".layout-img").click(function(){var b=$(this).val().split("*");$("input[type=text][name=layout-rows]").val(b[0]),$("input[type=text][name=layout-cols]").val(b[1]),$(".film-set-box").data("rows",b[0]),$(".film-set-box").data("cols",b[1]),changeFilmSet(),a()}),$(".customInput").change(function(){var b=$("input[type=text][name=layout-rows]").val(),c=$("input[type=text][name=layout-cols]").val();$(".film-set-box").data("rows",b),$(".film-set-box").data("cols",c),changeFilmSet(),a()}),$("#filmSet").click(function(){var a=com.cookie("filmTypes");$("input[name=filmTypeRadio]").each(function(){var b=$(this).val();a.indexOf(b)!=-1?$(this).prop("checked",!0):$(this).prop("checked",!1)})}),$("#saveFilmSet").click(function(){var a=[];$("input[name=filmTypeRadio]").each(function(){$(this).prop("checked")&&a.push($(this).val())}),com.delCookie("filmTypes"),com.cookie("filmTypes",a.join(","),720),initFilmTypes(a);var b=$(".film-set-box").data("type");0!=$("input[type=radio][name=paperType][value="+b+"]").length?$("input[type=radio][name=paperType][value="+b+"]").prop("checked",!0):($("input[type=radio][name=paperType]").first().prop("checked",!0),$(".film-set-box").data("type",$("input[type=radio][name=paperType]").first().val()),changeFilmSet()),setModeShow("filmType",!1)}),$("#layoutBtn").bind("click",function(){var b=$('input[name="layoutRadio"]:checked').val().split("*");$("input[type=text][name=layout-rows]").val(b[0]),$("input[type=text][name=layout-cols]").val(b[1]),$(".film-set-box").data("rows",b[0]),$(".film-set-box").data("cols",b[1]),setModeShow("layout",!1),changeFilmSet(),a()}),$(".film-layout").hover(function(a){$(this).find(".ql-ul").show()},function(a){$(this).find(".ql-ul").hide()}),$(".ql-click").bind("click",function(){var a=[],b=$(".film-page").first().attr("id"),c=$("#"+b).find(".unit").first().attr("id"),d=$("#"+c).find(".cell").first().attr("id"),e=$("#"+d).find(".atom").first().attr("id");pageTraverse(b,c,d,e,a);var f=$(this).attr("data-id").split("*"),g=f[0],h=f[1];$(".film-layout").attr("rows",g),$(".film-layout").attr("cols",h),$(".film-page-rows").text(g),$(".film-page-cols").text(h);var i=getPaperSet();changePaperSet(i),changePaperSetCookie(i),setModeShow("layout",!1),$(".film-page").first().addClass("film-page-check").siblings().remove(),initLayout(i,b,!1),changeFilmPage("first");var j=$(".film-page-check").find("div[data-print-isFill=false]").first().attr("id");reFillAtom(j,a)}),$(".film-page-chage").bind("click",function(){var a=$(this).attr("data-page-chage-type"),b=changeFilmPage(a);changePaperSet(b),changePaperSetCookie(b)}),$("#addPage").bind("click",function(){addFilmPage("last");var a=changeFilmPage("next");changePaperSet(a),changePaperSetCookie(a)}),$(".split-img").click(function(){if($(".unit-check").length<1)console.log("未选中拆分单元");else{var a=$(".film-page-check").attr("id"),b=$(".unit-check").attr("id"),c=$(".unit-check").find(".cell").first().attr("id"),d=$(".unit-check").find(".atom").first().attr("id"),e=[];pageTraverse(a,b,c,d,e);var f=$(this).attr("data-id"),g=splitMap[f];g.id=guid(8,"unit"),g.unitRow=parseInt($(".film-page").attr("data-rows")),g.unitCol=parseInt($(".film-page").attr("data-cols")),$(".unit-check").before(template("unitBoxTemp",g)),$(".unit-check").remove(),$("#"+g.id).addClass("unit-check");var h=$(".unit-check").find(".atom").first().attr("id");reFillAtom(h,e),deleNouseFilmPage(),changeFilmPage("current",a)}}),$(".close-film-img").click(function(){$(".film-page-print-mask").hide()}),$('input:checkbox[name="printInfoShow"]').change(function(){var a=$(this).is(":checked");localStorage.setItem("printInfoShow",a)}),$("#localPrintCur").click(function(){var a=$(".film-page-check").find(".atom[data-print-isFill=true]").length;if(!(a>0))return pop_up({type:"warning",title:"提示",message:"当前没有胶片需要处理!",yesName:"确定",noName:"取消"}),!1;setModeShow("print-local-verify",!0),b();var c=localStorage.getItem("printInfoShow");0==c||"false"==c?$('input:checkbox[name="printInfoShow"]').prop("checked",!1):$('input:checkbox[name="printInfoShow"]').prop("checked",!0);var d="localPrinter"!=$(".printBoxSelect").val();d?(connectPrintServer($(".verify-printer-state")),$(".printer-state-item").show()):$(".printer-state-item").hide();var e=$(".printBoxSelect option:selected").attr("data-name"),f=$(".printBoxSelect option:selected").attr("data-printerType"),g=$(".film-set-box").data("type"),h="1"==$(".film-set-box").data("direct")?"纵向打印":"横向打印",i=$(".film-set-box").data("rows")+"X"+$(".film-set-box").data("cols"),j=1;$(".verify-name").text(e),$(".verify-printer-type").text(f),$(".verify-paper-type").text(g),$(".verify-paper-direct").text(h),$(".verify-layout").text(i),$(".verify-print-pages").text(j),$(".print-local-verify-box").find(".verify-film-obj").attr("data-obj","cur"),$(".print-local-verify-box").find("input:radio[data-value= cur]").prop("checked",!0)}),$("#localPrintAll").click(function(){var a=$(".film-page-check").find(".atom[data-print-isFill=true]").length;if(!(a>0))return pop_up({type:"warning",title:"提示",message:"当前没有胶片需要处理!",yesName:"确定",noName:"取消"}),!1;setModeShow("print-local-verify",!0),b();var c="localPrinter"!=$(".printBoxSelect").val();c?(connectPrintServer($(".verify-printer-state")),$(".printer-state-item").show()):$(".printer-state-item").hide();var d=$(".printBoxSelect option:selected").attr("data-name"),e=$(".printBoxSelect option:selected").attr("data-printerType"),f=$(".film-set-box").data("type"),g="1"==$(".film-set-box").data("direct")?"纵向打印":"横向打印",h=$(".film-set-box").data("rows")+"X"+$(".film-set-box").data("cols"),i=$(".total-film-page").text();$(".verify-name").text(d),$(".verify-printer-type").text(e),$(".verify-paper-type").text(f),$(".verify-paper-direct").text(g),$(".verify-layout").text(h),$(".verify-print-pages").text(i)}),$(".item-update").click(function(){var a="已连接";a=1==socketPrinter.readyState?"已连接":(1==socketPrinter.readyState,"未连接"),$(".verify-printer-state").text(a)}),$(".item-retry").click(function(){connectPrintServer($(".verify-printer-state"))}),$("#printLocalSure").click(function(){var a=$(".print-local-verify-box").find(".verify-film-obj").attr("data-obj");pop_up({title:"打印提示",message:"正在生成打印数据......"});var b="localPrinter"!=$(".printBoxSelect").val();dvStruct.filmData=[];var c=b?eSetting.film.magnifyScale:1,d=$(".atom[data-print-isFill=true]").length;if(d>0){var e=getSynGroup("print"),f=$(".film-page").length;if("cur"==a){var g=$(".film-page-check").attr("id");buildFilmData(3,g,c,e,b).then(function(a){b?eSetting.film["default"].exitPrint?(pop_up({title:"打印提示",message:"所有胶片页数据发送完成！将自动退出打印页面（1秒后自动关闭该窗口）",yesName:"确定",noName:"取消",autoClose:!0,delay:1e3}),getModePage("viewer")):pop_up({title:"打印提示",message:"所有胶片页数据发送完成,是否退出胶片打印页面？",yesName:"确定",noName:"取消",ok:function(){getModePage("viewer")}}):(pop_up({title:"打印提示",message:"正在启动打印页面！（1秒后自动关闭该窗口）",yesName:"确定",noName:"取消",autoClose:!0,delay:1e3}),jpegPrint(a))})}else"all"==a&&$(".film-page").each(function(a,d){var g=$(d).attr("id"),h=3;buildFilmData(h,g,c,e,b).then(function(c){a==f-1&&(b?eSetting.film["default"].exitPrint?(pop_up({title:"打印提示",message:"所有胶片页数据发送完成！将自动退出打印页面（1秒后自动关闭该窗口）",yesName:"确定",noName:"取消",autoClose:!0,delay:1e3}),getModePage("viewer")):pop_up({title:"打印提示",message:"所有胶片页数据发送完成,是否退出胶片打印页面？",yesName:"确定",noName:"取消",ok:function(){getModePage("viewer")}}):(jpegPrint(c),pop_up({title:"打印提示",message:"正在启动打印页面！（1秒后自动关闭该窗口）",yesName:"确定",noName:"取消",autoClose:!0,delay:1e3})))})})}else pop_up({title:"打印提示",message:"当前没有图像需要打印",yesName:"确定",noName:"取消"})}),$(".print-local-verify-box").find(".obj-radio-item").click(function(){var a=$(this).attr("data-print-filmObj");$(".print-local-verify-box").find(".verify-film-obj").attr("data-obj",a),$(".print-local-verify-box").find("input:radio[data-value="+a+"]").prop("checked",!0),"cur"==a?$(".print-local-verify-box").find(".verify-print-pages").text(1):$(".print-local-verify-box").find(".verify-print-pages").text($(".film-page").length)}),$(".print-server-verify-box").find(".obj-radio-item").click(function(){var a=$(".print-server-verify-box").find(this).attr("data-print-filmObj");$(".print-server-verify-box").find(".verify-film-obj").attr("data-obj",a),$(".print-server-verify-box").find("input:radio[data-value="+a+"]").prop("checked",!0),"cur"==a?$(".print-server-verify-box").find(".verify-print-pages").text(1):$(".print-server-verify-box").find(".verify-print-pages").text($(".film-page").length)}),$("#remotePrint").click(function(){var a=$(".film-page-check").find(".atom[data-print-isFill=true]").length;if(!(a>0))return pop_up({type:"warning",title:"提示",message:"当前没有胶片需要处理!",yesName:"确定",noName:"取消"}),!1;setModeShow("print-server-verify",!0);var b=$(".printBoxSelect option:selected").attr("data-name"),c=$(".printBoxSelect option:selected").attr("data-printerType"),d=$(".film-set-box").data("type"),e="1"==$(".film-set-box").data("direct")?"纵向打印":"横向打印",f=$(".film-set-box").data("rows")+"X"+$(".film-set-box").data("cols"),g=1;$(".verify-name").text(b),$(".verify-printer-type").text(c),$(".verify-paper-type").text(d),$(".verify-paper-direct").text(e),$(".verify-layout").text(f),$(".verify-print-pages").text(g),$(".print-server-verify-box").attr("remote-obj","print")}),$("#remoteSave").click(function(){var a=$(".film-page-check").find(".atom[data-print-isFill=true]").length;if(!(a>0))return pop_up({type:"warning",title:"提示",message:"当前没有胶片需要处理!",yesName:"确定",noName:"取消"}),!1;setModeShow("print-server-verify",!0);var b=$(".printBoxSelect option:selected").attr("data-name"),c=$(".printBoxSelect option:selected").attr("data-printerType"),d=$(".film-set-box").data("type"),e="1"==$(".film-set-box").data("direct")?"纵向打印":"横向打印",f=$(".film-set-box").data("rows")+"X"+$(".film-set-box").data("cols"),g=1;$(".verify-name").text(b),$(".verify-printer-type").text(c),$(".verify-paper-type").text(d),$(".verify-paper-direct").text(e),$(".verify-layout").text(f),$(".verify-print-pages").text(g),$(".print-server-verify-box").attr("remote-obj","save")}),$("#printServerSure").click(function(){var a=$(".print-server-verify-box").attr("remote-obj"),b=1;"print"==a?b=1:"save"==a&&(b=2);var c=$(".verify-film-obj").attr("data-obj"),d=eSetting.film.magnifyScale;pop_up({title:"打印提示",message:"正在生成打印数据......"}),dvStruct.filmData=[];var e=$(".atom[data-print-isFill=true]").length;if(e>0){var f=getSynGroup("print"),g=$(".film-page").length;if("cur"==c){var h=$(".film-page-check").attr("id");buildFilmData(b,h,d,f,!1).then(function(){pop_up({title:"打印提示",message:"所有胶片页数据上传完成,是否退出胶片打印页面？",yesName:"确定",noName:"取消",ok:function(){getModePage("viewer")}})})}else"all"==c&&$(".film-page").each(function(a,c){var e=$(c).attr("id");buildFilmData(b,e,d,f,!1).then(function(){a==g-1&&pop_up({title:"打印提示",message:"所有胶片页数据上传完成,是否退出胶片打印页面？",yesName:"确定",noName:"取消",ok:function(){getModePage("viewer")}})})})}else pop_up({title:"打印提示",message:"当前没有图像需要打印",yesName:"确定",noName:"取消"})}),$("#printReferLine").click(function(){printReferline()}),$("#printDelete").click(function(){1==$(".unit-check").length?$(".atom-check").attr("data-print-delete",!0):$(".unit-check").find(".atom").attr("data-print-delete",!0);var a=$(".film-page-check").attr("id"),b=$(".unit-check").first().attr("id"),c=$(".unit-check").find(".cell").first().attr("id"),d=$(".unit-check").find(".atom").first().attr("id"),e=[];pageTraverse(a,b,c,d,e);var f=d;reFillAtom(f,e),deleNouseFilmPage(),changeFilmPage("current",a),$(".unit-check").removeClass("unit-check"),$(".atom-check").removeClass("atom-check")}),$("#printJoin").click(function(){$(".join-box").show(),$(".print-box").hide(),setTitle("join","null","拼接页面"),$(".join-cointainer-box").show(),dvStruct.dragOpt.print.join.show=!0});var d=!1;$('input[name="cutEnable"]').change(function(){if(d=$(this).is(":checked"),console.log("cutEnable",d),!d){var a=$(".atom[data-print-isFill=true]");a.each(function(){var a=$(this).get(0);cornerstoneTools.highlight.disable(a),cornerstoneTools.highlight.deactivate(a,1)})}}),$(".print-img-tool").click(function(){if($(this).hasClass("btnStyle2")){var a=$(this).attr("data-img");$(this).hasClass("activeBtn")?($(this).data("state",!1),$(this).removeClass("activeBtn"),$(this).css("background",'url("../img/print/'+a+'") no-repeat  0 0')):($(".btnStyle2").removeClass("activeBtn"),$(".btnStyle2").data("state",!1),$(this).addClass("activeBtn"),$(this).data("state",!0),$(".btnStyle2").each(function(){var a=$(this).attr("data-img");$(this).hasClass("activeBtn")?$(this).css("background",'url("../img/print/'+a+'") no-repeat  -80px 0'):$(this).css("background",'url("../img/print/'+a+'") no-repeat  0 0')}))}else $(this).hasClass("btnStyle1")&&($(this).data("state",!0),$(this).hasClass("recover")||($(".btnStyle2").data("state",!1),$(".btnStyle2").each(function(){var a=$(this).attr("data-img");$(this).hasClass("activeBtn")&&($(this).removeClass("activeBtn"),$(this).css("background",'url("../img/print/'+a+'") no-repeat  0 0'))})));var b=$(this).data("state"),d="default";b&&(d=$(this).attr("data-print-toolType"));var e=$(".print-proc-box").attr("data-procType");"default"!=d&&"zoom"!=d&&"pan"!=d&&"rotate"!=d&&"wwwc"!=d&&"clipping"!=d||(dvStruct.print.curToolType=d,"clipping"==d?c=!0:(c=!1,e="all"));var f=getSelecNodes(e);f.forEach(function(a){imgToolsDispatch(a,d)})}),$(".proc-radio").click(function(){var a=$(this).attr("data-print-procType");$(".print-proc-box").attr("data-procType",a),$(".print-proc-type[value="+a+"]").prop("checked",!0)}),$("#printFliter").click(function(a){$(".atom-check").length<1?pop_up({title:"过滤提示",message:"没有选中的图像，请先选择有效图像！",yesName:"确定",noName:"取消"}):setModeShow("filter",!0)}),$(".printBoxSelect").bind("change",function(){var a="printerName",b=$(".printBoxSelect").val();com.cookie(a,b,720);var c=$(".printBoxSelect option:selected").attr("data-printerType");"local"==c?($(".local-option").show(),$(".server-option").hide()):($(".server-option").show(),$(".local-option").hide())}),$("#printerSet").click(function(a){setModeShow("printer-list",!0),printerShow()}),$("body").on("click",".printer-inner",function(){$(this).addClass("printer-inner-check").siblings().removeClass("printer-inner-check")}),$("#addPrinter").click(function(){setModeShow("printer-list",!1),setModeSecondShow("printer-set",!0,"add-printer")}),$("#modifyPrinter").click(function(){if($(".printer-inner-check").length>0){var a=$(".printer-inner-check").attr("data-name"),b=$(".printer-inner-check").attr("data-printerType"),c=$(".printer-inner-check").attr("data-ip"),d=$(".printer-inner-check").attr("data-aet"),e=$(".printer-inner-check").attr("data-aetLocal"),f=$(".printer-inner-check").attr("data-port"),g=$(".printer-inner-check").attr("data-position"),h=$(".printer-inner-check").attr("data-type"),i=$(".printer-inner-check").attr("data-priority"),j=$(".printer-inner-check").attr("data-color"),k=$(".printer-inner-check").attr("data-magnifyType"),l=c.split(".");$('input[name="name"]').val(a),$('select[name="printerType"]').val(b),$('input[name="ip1"]').val(l[0]),$('input[name="ip2"]').val(l[1]),$('input[name="ip3"]').val(l[2]),$('input[name="ip4"]').val(l[3]),$('input[name="aet"]').val(d),$('input[name="aetLocal"]').val(e),$('input[name="port"]').val(f),$('select[name="position"]').val(g),$('select[name="type"]').val(h),$('select[name="priority"]').val(i),$('select[name="magnifyType"]').val(k),$('input:checkbox[name="gray"]').attr("checked","1"==j),setModeShow("printer-list",!1),setModeSecondShow("printer-set",!0,"modify-printer")}else pop_up({title:"提示",message:"未选择修改项",yesName:"确定",noName:"取消"})}),$("#addPrinterSure").click(function(){var a=$('input[name="name"]').val(),b=$('select[name="printerType"]').val(),c=$('input[name="ip1"]').val()+"."+$('input[name="ip2"]').val()+"."+$('input[name="ip3"]').val()+"."+$('input[name="ip4"]').val(),d=$('input[name="aet"]').val(),e=$('input[name="aetLocal"]').val(),f=$('input[name="port"]').val(),g=$('select[name="position"]').val(),h=$('select[name="type"]').val(),i=$('select[name="priority"]').val(),j=$('input:checkbox[name="gray"]:checked').val(),k=$('select[name="magnifyType"]').val();j=null==j||""==j||void 0==j?0:1;var l={name:a,printerType:b,ip:c,aet:d,aetLocal:e,port:f,position:g,type:h,priority:i,color:j,magnifyType:k};console.log("打印机设置参数",l),isEmpty(a)||isEmpty(b)||isEmpty(c)||isEmpty(d)||isEmpty(e)||isEmpty(f)||isEmpty(g)||isEmpty(h)||isEmpty(i)||isNaN(j)||isEmpty(k)?pop_up({title:"error提示",message:"参数设置有误",yesName:"确定",noName:"取消"}):(addPrinter(l),setModeSecondShow("printer-set",!1,"add-printer"),setModeShow("printer-list",!0))}),$("#modifyPrinterSure").click(function(){var a=$(".printer-inner-check").attr("data-id"),b=$('input[name="name"]').val(),c=$('select[name="printerType"]').val(),d=$('input[name="ip1"]').val()+"."+$('input[name="ip2"]').val()+"."+$('input[name="ip3"]').val()+"."+$('input[name="ip4"]').val(),e=$('input[name="aet"]').val(),f=$('input[name="aetLocal"]').val(),g=$('input[name="port"]').val(),h=$('select[name="position"]').val(),i=$('select[name="type"]').val(),j=$('select[name="priority"]').val(),k=$('input:checkbox[name="gray"]:checked').val(),l=$('select[name="magnifyType"]').val();k=null==k||""==k||void 0==k?0:1;var m={id:a,name:b,printerType:c,ip:d,aet:e,aetLocal:f,port:g,position:h,type:i,priority:j,color:k,magnifyType:l};console.log("打印机设置参数",m),isEmpty(b)||isEmpty(c)||isEmpty(d)||isEmpty(e)||isEmpty(f)||isEmpty(g)||isEmpty(h)||isEmpty(i)||isEmpty(j)||isNaN(k)||isEmpty(l)?pop_up({title:"error提示",message:"参数设置有误",yesName:"确定",noName:"取消"}):(modifyPrinter(m),setModeSecondShow("printer-set",!1,"modify-printer"),setModeShow("printer-list",!0))}),$("#delePrinter").click(function(){$(".printer-inner-check").length>0?delePrinter():pop_up({title:"提示",message:"未选择删除项",yesName:"确定",noName:"取消"})}),$("#filmTagSet").click(function(a){setModeShow("tag-set",!0),tagShow()}),$("body").on("click",".tag-item",function(){$(this).addClass("tag-item-check").siblings().removeClass("tag-item-check")}),$("#addPrintTag").bind("click",function(){addTag()}),$(document).on("click",".fontDiv ul",function(){$(".fontDiv ul").removeClass("activeUl"),$(this).addClass("activeUl")}),$(document).on("mouseover",".fontDiv ul li",function(){$(this).find(".pull-right").show()}),$(document).on("mouseout",".fontDiv ul li",function(){$(this).find(".pull-right").hide()}),$(document).on("click",".moveUpBtn",function(){var a=$(this),b=a.closest("li.courseList"),c=a.closest("li.courseList").prev("li");if(c.length>0){var d=b.html();b.empty().append(c.html()),c.empty().append(d)}$(".pull-right").hide()}),$(document).on("click",".moveDownBtn",function(){var a=$(this),b=a.closest("li.courseList"),c=a.closest("li.courseList").next("li");if(c.length>0){var d=b.html();b.empty().append(c.html()),c.empty().append(d)}$(".pull-right").hide()}),$(document).on("click",".deleteBtn",function(){var a=$(this);a.closest("li.courseList").remove();var b=$('<li class="tag-item"></li>');b.append(a.parents(".courseList").find(".pull-left").text()),$(".selectBox").append(b)}),$("#tagsetOK").click(function(){tagSetSave()}),$(".tagSetHref").click(function(){$(".tag-set-box").find(".font-pre-set").hide(),$(".tag-set-box").find(".yes").show()}),$(".viewFontHref").click(function(){$(".tag-set-box").find(".font-pre-set").hide(),$(".tag-set-box").find(".yes").hide();var a=12;filmSetPreview(426,426,a)}),$("#markL").click(function(a){var b=".atom[data-print-isFill=true]",c=selectedLength(b,!0);return c<1?void $(this).removeClass("directionStyle"):(config.current="L",void changeMarkerText())}),$("#markR").click(function(a){var b=".atom[data-print-isFill=true]",c=selectedLength(b,!0);return c<1?void $(this).removeClass("directionStyle"):(config.current="R",void changeMarkerText())}),$("#markA").click(function(a){var b=".atom[data-print-isFill=true]",c=selectedLength(b,!0);return c<1?void $(this).removeClass("directionStyle"):(config.current="A",void changeMarkerText())}),$("#markH").click(function(a){var b=".atom[data-print-isFill=true]",c=selectedLength(b,!0);return c<1?void $(this).removeClass("directionStyle"):(config.current="H",void changeMarkerText())}),$("#printSetwwwc").bind("change",function(){var a={};a.ww=parseInt($("#printSetwwwc option:selected").attr("data-ww")),a.wc=parseInt($("#printSetwwwc option:selected").attr("data-wc")),printQuickWindow(a)}),$(".closeMarker").click(function(){var a=cornerstoneTools.orientationMarkers.getConfiguration()||eSetting.tool.markers;a&&(a.drawMarkers=!a.drawMarkers,a.isShowAllMarkers&&(a.drawAllMarkers=!a.drawAllMarkers)),cornerstoneTools.orientationMarkers.setConfiguration(a),updateAtomMarkers(flimScaleOverlayTool)}),$("#printScale").click(function(){flimScaleOverlayTool=!flimScaleOverlayTool,updateAtomMarkers(flimScaleOverlayTool)})});