/*!ipacs4.0 - 1.0.0-2021-02-05 */
function socketConnectionTips(a){switch(a){case-1:pop_up({type:"error",title:"打印服务连接提示",message:"tips1:浏览器不支持服务，推荐使用谷歌浏览器，\r\t360极速浏览器（极速模式），搜狗浏览器（极速模式）!",yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 3:pop_up({type:"error",title:"打印服务连接提示",message:"tips2:下载服务连接失败,请检查服务是否正确安装并打开。\r\t如未安装服务请先安装该服务再进入胶片打印页面。\r\t下载该服务请点击确定按钮！",ok:downloadPrintServe,yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 2:pop_up({title:"打印服务连接提示",message:"tips3:下载服务连接失败,请检查服务是否正确安装并打开。\r\t如未安装服务请先安装该服务再进入胶片打印页面。\r\t下载该服务请点击确定按钮！",ok:downloadPrintServe,yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 1:break;default:window.confirm("default")}}function socketConnectionTipsVR(a){switch(a){case-1:pop_up({type:"error",title:"VR提示",message:"tips1:浏览器不支持服务，推荐使用谷歌浏览器，\r\t360极速浏览器（极速模式），搜狗浏览器（极速模式）!",yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 3:pop_up({type:"error",title:"VR提示",message:"tips2:请启动IpacsVR服务并检查端口配置。\r\t下载该服务请点击确定按钮！",ok:download3dService,yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 2:pop_up({type:"error",title:"VR服务提示",message:"tips3:请启动IpacsVR服务并检查端口配置。\r\t下载该服务请点击确定按钮！",ok:download3dService,yesName:"确定",noName:"取消"}),window.stop?window.stop():document.execCommand("Stop");break;case 1:break;default:window.confirm("default")}}function fillImageSimple(a,b){var c=$("#"+a).get(0);cornerstone.enable(c),cornerstoneTools.mouseInput.enable(c),cornerstone.loadImage(b).then(function(a){cornerstone.displayImage(c,a)})}function fillImageKeep(a,b,c,d){var e=$("#"+a).width(),f=$("#"+a).height(),g=$("#"+b).width(),h=$("#"+b).height(),i=Math.min(g/e,h/f),j=$("#"+b).get(0);$("#"+b).attr("imageId",c),$("#"+b).attr("seriesId",d),cornerstone.disable(j),cornerstone.enable(j),cornerstoneTools.mouseInput.enable(j),cornerstone.loadImage(c).then(function(b){cornerstone.displayImage(j,b),cornerstoneTools.orientationMarkers.enable(j);var c=cornerstone.getViewport($("#"+a).get(0));c.scale*=i,cornerstone.setViewport(j,c)})}function isImgExist(a){var b=$(".join-img-box").find('[imageId="'+a+'"]').length;return 0==b}function getMaxZindex(){var a=0,b=0;return $(".join-img-box").find(".join-img").each(function(){var c=$(this).css("z-index");c>b&&(b=c),c<a&&(a=c)}),parseInt(b)}function imgResize(){$(".join-img").each(function(){var a=parseInt($(this).attr("W")),b=parseInt($(this).attr("H")),c=joinImgSize(a,b);$(this).width(c[0]),$(this).height(c[1]);var d=$(this).get(0);cornerstone.resize(d,!0)})}function createJoinCanv(){if($(".join-img").length<2)return!1;var a={patientID:"",studyTime:"",modality:"",instanceNumber:1,name:"",studyDate:"",sex:"",age:"",birthDate:"",imageId:"",hosName:"",describe:"",imageData:[],maxPixelValue:0,minPixelValue:0,slope:0,intercept:0,columnPixelSpacing:0,rowPixelSpacing:0,windowWidth:0,windowCenter:0,columns:0,rows:0,width:0,height:0},b=$(".join-img-box").width(),c=$(".join-img-box").height(),d=$(".join-img").width(),e=$(".join-img").height(),f=0,g=0;joinObj.length=0;var h=0,i=0,j=0,k=0,l=0;$(".join-img").each(function(){var b={imageId:$(this).attr("imageId"),zIndex:$(this).css("z-index"),imageSrc:null,imgRows:0,imgCols:0,xspacing:0,yspacing:0,location:{xstart:$(this).position().left,ystart:$(this).position().top,xend:0,yend:0,W:$(this).width(),H:$(this).height()}};if(b.location.xend=$(this).width()+b.location.xstart,b.location.yend=$(this).height()+b.location.ystart,f<b.location.xend&&(f=b.location.xend),g<b.location.yend&&(g=b.location.yend),d>b.location.xstart&&(d=b.location.xstart),e>b.location.ystart&&(e=b.location.ystart),$(this).addClass("labelTemp"),b.imageSrc=$(".labelTemp>canvas")[0],$(this).removeClass("labelTemp"),b.imageId.indexOf("load")<0){var c=dvStruct.findOriInfoOnlyByOriId(b.imageId);h=parseFloat(c.ImageInfo.RescaleSlope.val),i=parseFloat(c.ImageInfo.RescaleIntercept.val),j=parseFloat(c.ImageInfo.PixelSpacing.val);var m=$(this).get(0),n=deepCopy1(cornerstone.getViewport(m));k=Math.round(n.voi.windowWidth),l=Math.round(n.voi.windowCenter),b.imgRows=parseInt(c.ImageInfo.Rows.val),b.imgCols=parseInt(c.ImageInfo.Columns.val),b.xspacing=parseFloat(c.ImageInfo.PixelSpacing.val),b.yspacing=parseFloat(c.ImageInfo.PixelSpacing.val)}else h=1,i=0,j=.6,k=255,l=128,b.imgRows=parseInt($(this).height()),b.imgCols=parseInt($(this).width()),b.xspacing=.6,b.yspacing=.6;a.patientID=$(this).attr("patientID"),a.studyTime=$(this).attr("studyTime"),a.modality=$(this).attr("modality"),a.name=$(this).attr("name"),a.age=$(this).attr("age"),a.sex=$(this).attr("sex"),a.birthDate=$(this).attr("birthDate"),a.studyDate=$(this).attr("studyDate"),a.describe=$(this).attr("describe"),a.hosName=$(this).attr("hosName"),b.xspacing=parseFloat($(this).attr("spacingX")),b.yspacing=parseFloat($(this).attr("spacingY")),joinObj.push(b)}),joinObj.sort(compare("zIndex"));var m=f-d,n=g-e,o=$("#joinOutputCanv")[0];o.width=b,o.height=c;var p=o.getContext("2d");p.fillStyle="#000000",p.fillRect(0,0,b,c);for(var q=0,r=joinObj.length;q<r;q++){var s,t,u,v;joinObj[q].zIndex;s=joinObj[q].location.xstart,t=joinObj[q].location.ystart,u=joinObj[q].location.W,v=joinObj[q].location.H,p.drawImage(joinObj[q].imageSrc,s,t,u,v)}var w=p.getImageData(d,e,m,n),x=w.width,y=w.height;if(x&&y){var z=$("#saveTest1")[0];z.width=x,z.height=y;var A=z.getContext("2d");A.putImageData(w,0,0);for(var B=0,r=w.width*w.height;B<r;B++)a.imageData[B]=w.data[4*B];var C=cornerstoneWADOImageLoader.getMinMax(a.imageData);return a.maxPixelValue=C.max,a.minPixelValue=C.min,a.slope=h,a.intercept=i,a.columnPixelSpacing=j,a.rowPixelSpacing=j,a.windowWidth=255,a.windowCenter=128,a.columns=w.width,a.rows=w.height,a.width=w.width,a.height=w.height,a.imageId="loadJoinImg://"+joinOutputObj.length,joinOutputObj.push(a),!0}return!1}function createCutBoxCanv(){joinObj.length=0;var a={patientID:"",studyTime:"",modality:"",instanceNumber:1,name:"",studyDate:"",sex:"",age:"",birthDate:"",imageId:"",hosName:"",describe:"",imageData:[],maxPixelValue:0,minPixelValue:0,slope:0,intercept:0,columnPixelSpacing:0,rowPixelSpacing:0,windowWidth:0,windowCenter:0,columns:0,rows:0,width:0,height:0},b=$(".join-img-box").width(),c=$(".join-img-box").height(),d=$(".join-img").width(),e=$(".join-img").height(),f=0,g=0;joinObj.length=0;var h=0,i=0,j=0,k=0,l=0;$(".join-img").each(function(){var b={imageId:$(this).attr("imageId"),zIndex:$(this).css("z-index"),imgRows:0,imgCols:0,imageSrc:null,xspacing:0,yspacing:0,location:{xstart:$(this).position().left,ystart:$(this).position().top,xend:0,yend:0,W:$(this).width(),H:$(this).height()}};if(b.location.xend=$(this).width()+b.location.xstart,b.location.yend=$(this).height()+b.location.ystart,f<b.location.xend&&(f=b.location.xend),g<b.location.yend&&(g=b.location.yend),d>b.location.xstart&&(d=b.location.xstart),e>b.location.ystart&&(e=b.location.ystart),$(this).addClass("labelTemp"),b.imageSrc=$(".labelTemp>canvas")[0],$(this).removeClass("labelTemp"),b.imageId.indexOf("load")<0){var c=dvStruct.findOriInfoOnlyByOriId(b.imageId);h=parseFloat(c.ImageInfo.RescaleSlope.val),i=parseFloat(c.ImageInfo.RescaleIntercept.val),j=parseFloat(c.ImageInfo.PixelSpacing.val);var m=$(this).get(0),n=deepCopy1(cornerstone.getViewport(m));k=Math.round(n.voi.windowWidth),l=Math.round(n.voi.windowCenter),b.imgRows=parseInt(c.ImageInfo.Rows.val),b.imgCols=parseInt(c.ImageInfo.Columns.val),b.xspacing=parseFloat(c.ImageInfo.PixelSpacing.val),b.yspacing=parseFloat(c.ImageInfo.PixelSpacing.val)}else h=1,i=0,j=.6,k=255,l=128,b.imgRows=parseInt($(this).height()),b.imgCols=parseInt($(this).width()),b.xspacing=.6,b.yspacing=.6;a.patientID=$(this).attr("patientID"),a.studyTime=$(this).attr("studyTime"),a.modality=$(this).attr("modality"),a.name=$(this).attr("name"),a.age=$(this).attr("age"),a.sex=$(this).attr("sex"),a.birthDate=$(this).attr("birthDate"),a.studyDate=$(this).attr("studyDate"),a.describe=$(this).attr("describe"),a.hosName=$(this).attr("hosName"),b.xspacing=parseFloat($(this).attr("spacingX")),b.yspacing=parseFloat($(this).attr("spacingY")),joinObj.push(b)}),joinObj.sort(compare("zIndex"));var m=f-d,n=g-e,o=[m*parseFloat($(".join-img").attr("spacingX")),n*parseFloat($(".join-img").attr("spacingY"))];$(".cut-box").width(m),$(".cut-box").height(n);var p=$(".join-cut-box").height(),q=(p-n)/2,r=q>0?q:0;$(".cut-img-box").css({marginTop:r+"px"}),$(".cut-img-box").width(m),$(".cut-img-box").height(n),$(".cut-img-box").attr("patientID",a.patientID),$(".cut-img-box").attr("studyTime",a.studyTime),$(".cut-img-box").attr("modality",a.modality),$(".cut-img-box").attr("name",a.name),$(".cut-img-box").attr("age",a.age),$(".cut-img-box").attr("sex",a.sex),$(".cut-img-box").attr("birthDate",a.birthDate),$(".cut-img-box").attr("studyDate",a.studyDate),$(".cut-img-box").attr("describe",a.describe),$(".cut-img-box").attr("hosName",a.hosName),$(".cut-img-box").attr("spacingX",$(".join-img").attr("spacingX")),$(".cut-img-box").attr("spacingY",$(".join-img").attr("spacingY")),$(".cut-img-box").attr("W",m),$(".cut-img-box").attr("H",n),$(".cut-img-box").attr("actualW",o[0]),$(".cut-img-box").attr("actualH",o[1]);var s=$("#cutCanv")[0];s.width=m,s.height=n;var t=s.getContext("2d"),u=$("#joinOutputCanv")[0];u.width=b,u.height=c;var v=u.getContext("2d");v.fillStyle="#000000",v.fillRect(0,0,b,c);for(var w=0,x=joinObj.length;w<x;w++){var y,z,A,B;joinObj[w].zIndex;y=joinObj[w].location.xstart,z=joinObj[w].location.ystart,A=joinObj[w].location.W,B=joinObj[w].location.H,v.drawImage(joinObj[w].imageSrc,joinObj[w].location.xstart,joinObj[w].location.ystart,joinObj[w].location.W,joinObj[w].location.H)}var C=v.getImageData(d,e,m,n);return t.putImageData(C,0,0),joinObj.length=0,!0}function createCutImgCanv(a,b){joinObj.length=0;var c=0,d=0,e={patientID:"",studyTime:"",modality:"",instanceNumber:1,name:"",studyDate:"",sex:"",age:"",birthDate:"",imageId:"",hosName:"",describe:"",imageData:[],maxPixelValue:0,minPixelValue:0,slope:0,intercept:0,columnPixelSpacing:0,rowPixelSpacing:0,windowWidth:0,windowCenter:0,columns:0,rows:0,width:0,height:0},f=0,g=0,h=0,i=0,j=0;$(".cutActive").each(function(){c=$(this).width(),d=$(this).height();var a={imageId:$(this).attr("imageId"),zIndex:$(this).css("z-index"),imgRows:0,imgCols:0,xspacing:0,yspacing:0,imageSrc:null,location:{xstart:$(this).position().left,ystart:$(this).position().top,xend:0,yend:0,W:$(this).width(),H:$(this).height()}};if(a.location.xend=$(this).width()+a.location.xstart,a.location.yend=$(this).height()+a.location.ystart,$(this).addClass("labelTemp"),a.imageSrc=$(".labelTemp>canvas")[0],$(this).removeClass("labelTemp"),a.imageId.indexOf("load")<0){var b=dvStruct.findOriInfoOnlyByOriId(a.imageId);f=parseFloat(b.ImageInfo.RescaleSlope.val),g=parseFloat(b.ImageInfo.RescaleIntercept.val),h=parseFloat(b.ImageInfo.PixelSpacing.val);var k=$(this).get(0),l=deepCopy1(cornerstone.getViewport(k));i=Math.round(l.voi.windowWidth),j=Math.round(l.voi.windowCenter),a.imgRows=parseInt(b.ImageInfo.Rows.val),a.imgCols=parseInt(b.ImageInfo.Columns.val),a.xspacing=parseFloat(b.ImageInfo.PixelSpacing.val),a.yspacing=parseFloat(b.ImageInfo.PixelSpacing.val)}else f=1,g=0,h=.6,i=255,j=128,a.imgRows=parseInt($(this).height()),a.imgCols=parseInt($(this).width()),a.xspacing=.6,a.yspacing=.6;e.patientID=$(this).attr("patientID"),e.studyTime=$(this).attr("studyTime"),e.modality=$(this).attr("modality"),e.name=$(this).attr("name"),e.age=$(this).attr("age"),e.sex=$(this).attr("sex"),e.birthDate=$(this).attr("birthDate"),e.studyDate=$(this).attr("studyDate"),e.describe=$(this).attr("describe"),e.hosName=$(this).attr("hosName"),a.xspacing=parseFloat($(this).attr("spacingX")),a.yspacing=parseFloat($(this).attr("spacingY")),joinObj.push(a)}),joinObj.sort(compare("zIndex"));for(var k=0,l=joinObj.length;k<l;k++)a.drawImage(joinObj[k].imageSrc,0,0,c,d);return joinObj.length=0,!0}function getCutResult(a,b,c){var d=b.getContext("2d"),e=d.getImageData(c.xstart,c.ystart,c.width,c.height);b.width=e.width,b.height=e.height,d.putImageData(e,0,0),a.width(e.width),a.height(e.height),a.find("canvas").width(e.width),a.find("canvas").height(e.height)}function joinImgSize(a,b){var c=.4,d=Math.ceil($(".join-img-box").width()),e=Math.ceil($(".join-img-box").height()*c),f=Math.min(d/a,d/b,e/b,e/a);return d=a*f,e=b*f,[Math.ceil(d),Math.ceil(e)]}function calcSize(a,b,c,d){var e=Math.ceil(a.width()),f=Math.ceil(a.height()*b),g=Math.min(e/c,e/d,f/d,f/c);return e=c*g,f=d*g,[Math.ceil(e),Math.ceil(f)]}function positionAdjust(a){if("blank"!=a){var b=$(".join-img-box").width();$(".joinImgSelec").each(function(){var c=$(this).css("left"),d=$(this).css("top"),e=$(this).width();switch(a){case"up":$(this).css("top",customCalc(d,"1px","subCalc","px",b-e,0));break;case"left":$(this).css("left",customCalc(c,"1px","subCalc","px",b-e,0));break;case"down":$(this).css("top",customCalc(d,"1px","addCalc","px",b-e,0));break;case"right":$(this).css("left",customCalc(c,"1px","addCalc","px",b-e,0))}})}}function hideTool(a,b){$(".cutBtn").hide(),"joinPageS"==a?$(".joinPageS").show():"cropPageS"==a?($(".cropPageS").show(),b<1?$(".join-undo").hide():$(".join-undo").show()):"previewPageS"==a&&$(".previewPageS").show()}function hidePrintBtn(a){2==a?($(".join-sendToPrint1").hide(),$(".join-sendToPrint2").show()):1==a?($(".join-sendToPrint2").hide(),$(".join-sendToPrint1").show()):0==a&&($(".join-sendToPrint2").hide(),$(".join-sendToPrint1").hide())}function setTitle(a,b,c){$(".join-title-box").text(c),$(".tool-group").hide(),$(".tool-"+a).show()}function getCropImg(){for(var a=$("#cutScanCanv")[0],b=a.getContext("2d"),c=a.width,d=a.height,e={patientID:"",studyTime:"",modality:"",instanceNumber:1,name:"",studyDate:"",sex:"",age:"",birthDate:"",imageId:"",hosName:"",describe:"",imageData:[],maxPixelValue:255,minPixelValue:0,slope:1,intercept:0,columnPixelSpacing:1,rowPixelSpacing:1,windowWidth:128,windowCenter:255,columns:c,rows:d,width:c,height:d},f=b.getImageData(0,0,c,d),g=0,h=f.width*f.height;g<h;g++)e.imageData[g]=f.data[4*g];return e}function sendToPrint(a,b,c,d){var e="loadJoinImg://"+joinOutputObj.length;if($(".joinOutPutBox").empty(),"join"==a&&createJoinCanv()&&(b&&addToLeftBox(e),c&&addToPrintPage(e)),"crop"==a){var f=getCropImg();joinOutputObj.push(f),joinOutputObj[joinOutputObj.length-1].imageId=e,joinOutputObj.length>0&&(b&&addToLeftBox(e),c&&addToPrintPage(e),d&&($(".join-close").click(),$(".joinPreviewBox").hide(),$(".joinCutBox").hide(),$(".join-img-box").show()))}return d&&(joinStruct.openWay=!1,$(".join-close").click(),$(".joinHelpBox").hide()),!0}function uploadJoinImage(a){function b(a){if(200==a.status){var b=a.data.url,c=a.data.id,d="wadouri:"+b;$(".cutActive").attr("imageId",d),pop_up({title:"拼接图像保存提示",message:"拼接图像上传成功，已经加载到图像列表。是否退出拼接页面？",yesName:"确定",noName:"取消",ok:function(){$(".back-to-print").click()}}),cornerstone.loadAndCacheImage(d).then(function(b){if(_.isObject(b)&&_.isObject(b.data)){dvStruct.imgObjArr.push(b);var e=JSON.parse(a.msg),f=getDicomInfo(b.data);changeInfo(f,e),f.signId=c,f.isSign=!1;var g={studyId:a.data.studyId,dataSet:b.data,infoSet:f,imageId:b.imageId,instanceNo:f.InstanceInfo.InstanceNumber.val,signId:c},h=dvStruct.findSeries(a.data.seriesId),i=1;h&&(i=h.dicomArr.length);var j={studyId:a.data.studyId,studyDateTime:a.data.examDate,seriesNo:a.data.sNum,seriesId:a.data.seriesId,url:a.data.url,imageType:a.data.imageType,signId:a.data.id,isSign:!1,inatanceNo:f.InstanceInfo.InstanceNumber.val,imageId:a.data.url,totalCount:i,detail:e,index:1};dvStruct.addDicom(g,j),$(".series-shrink").show(),setTimeout(function(){var b=$(".film-page-check").find(".atom[data-print-isFill='false']").first().attr("id");fillImage(b,{studyId:a.data.studyId,imageId:d,seriesNo:a.data.sNum,seriesId:a.data.seriesId})},3e3)}else console.log("notObj")})["catch"](function(a){console.log("图像加载报错",b,a),pop_up({type:"error",title:"拼接图像保存提示",message:"拼接图像上传成功，因为跨域问题无法加载到图像列表，请联系工程师。是否退出拼接页面？",yesName:"确定",noName:"取消",ok:function(){$(".back-to-print").click()}})})}else pop_up({type:"error",title:"error提示",message:"上传失败，"+a.msg,yesName:"确定",noName:"取消"})}com.uploadJoinImage(a,b)}function ran(a){a=a>13?13:a;var b=(new Date).getTime();return b.toString().substring(13-a)}function getXAndY(a){Ev=a||window.event;var b=mouseCoords(a),c=b.x,d=b.y,e=$(".join-img-box").offset().left,f=$(".join-img-box").offset().top,g=c-e,h=d-f;return{x:g,y:h}}function mouseCoords(a){return a.pageX||a.pageY?{x:a.pageX,y:a.pageY}:{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}}function compare(a){return function(b,c){var d=b[a],e=c[a];return d-e}}function currentDate(){var a=new Date,b=""+a.getFullYear()+"/";return b+=a.getMonth()+1+"/",b+=a.getDate()}function customCalc(a,b,c,d,e,f){var g=0,h=d.length;switch(c){case"addCalc":g=parseInt(a.substring(0,a.length-h))+parseInt(b.substring(0,b.length-h));break;case"subCalc":g=parseInt(a.substring(0,a.length-h))-parseInt(b.substring(0,b.length-h));break;case"plus":g=parseInt(a.substring(0,a.length-h))*parseInt(b.substring(0,b.length-h))}return g>e&&(g=e),g<f&&(g=f),g}function loadCropImg(a){function b(){return d}var c=parseInt(a.substring(14)),d=cropImgArr[c].imageData,e={imageId:a,minPixelValue:cropImgArr[c].minPixelValue,maxPixelValue:cropImgArr[c].maxPixelValue,slope:cropImgArr[c].slope,intercept:cropImgArr[c].intercept,windowCenter:cropImgArr[c].windowCenter,windowWidth:cropImgArr[c].windowWidth,render:cornerstone.renderGrayscaleImage,getPixelData:b,rows:cropImgArr[c].height,columns:cropImgArr[c].width,height:cropImgArr[c].height,width:cropImgArr[c].width,color:!1,columnPixelSpacing:cropImgArr[c].columnPixelSpacing,rowPixelSpacing:cropImgArr[c].rowPixelSpacing,invert:!1,sizeInBytes:cropImgArr[c].columns*cropImgArr[c].rows*2};return{promise:new Promise(function(a){a(e)}),cancelFn:void 0}}function loadJoinImg(a){function b(){return d}var c=parseInt(a.substring(14)),d=joinOutputObj[c].imageData,e={imageId:a,minPixelValue:joinOutputObj[c].minPixelValue,maxPixelValue:joinOutputObj[c].maxPixelValue,slope:1,intercept:1,windowCenter:joinOutputObj[c].windowCenter,windowWidth:joinOutputObj[c].windowWidth,render:cornerstone.renderGrayscaleImage,getPixelData:b,rows:joinOutputObj[c].height,columns:joinOutputObj[c].width,height:joinOutputObj[c].height,width:joinOutputObj[c].width,color:!1,columnPixelSpacing:joinOutputObj[c].columnPixelSpacing,rowPixelSpacing:joinOutputObj[c].rowPixelSpacing,invert:!1,sizeInBytes:joinOutputObj[c].columns*joinOutputObj[c].rows*2};return{promise:new Promise(function(a){a(e)}),cancelFn:void 0}}function loadTempImg(a){function b(){return d}var c=parseInt(a.substring(14)),d=joinCutObj[c].imageData,e={imageId:a,minPixelValue:joinCutObj[c].minPixelValue,maxPixelValue:joinCutObj[c].maxPixelValue,slope:joinCutObj[c].slope,intercept:joinCutObj[c].intercept,windowCenter:joinCutObj[c].windowCenter,windowWidth:joinCutObj[c].windowWidth,render:cornerstone.renderGrayscaleImage,getPixelData:b,rows:joinCutObj[c].height,columns:joinCutObj[c].width,height:joinCutObj[c].height,width:joinCutObj[c].width,color:!1,columnPixelSpacing:joinCutObj[c].columnPixelSpacing,rowPixelSpacing:joinCutObj[c].rowPixelSpacing,invert:!1,sizeInBytes:joinCutObj[c].columns*joinCutObj[c].rows*2};return{promise:new Promise(function(a){a(e)}),cancelFn:void 0}}function addToLeftBox(a){var b=parseInt(a.substring(14));if(!($("#joinSeries").length>0)){var c=$(".thumbnail-box"),d="joinSeriesBox",e="joinSeries",f="拼接图像",g="<ul class='orderUl'><li class='orderLi'> <div id='joinImgCount' class='orderTitle font12' title='图像数："+(b+1)+"'> <div class='left'> <span class='info' style='font-size: 10px; color: #00a379;'>"+f+"</span><span id='"+d+"' style='font-size: 10px; line-height: 15px;color: #00a379;'>"+currentDate()+"</span><span id='"+d+"img'> </span></div><div class='right'><i class='fa fa-caret-down icon' style='display: none; line-height: 30px' aria-hidden='true'></i><i class='fa fa-caret-right icon' aria-hidden='true'></i> </div> </div> <ul id='"+e+"' class='imgUl ui-widget-header'> </ul> </li></ul>";c.append(g)}$("#joinImgCount").attr("title","图像数："+(b+1));var h=$("#joinSeries"),i="join_"+b,j="join_1",k=$(" <li id='"+i+"' imageId='"+a+"' seriNo='"+j+"' class='imgLi' style='border: gray solid;'></li>");h.append(k);var l=$("#"+i).get(0);cornerstone.enable(l),cornerstone.loadImage(a).then(function(a){cornerstone.displayImage(l,a)})}function addToPrintPage(a){var b=$("div[imgIn=false]").attr("id");b&&(fillImage(b,a," "),fillInfoOnLay(b),$("#"+b).parent().find(".viewportBoxNo").hide())}function dragIn(a,b){var c=dvStruct.findOriInfoByIds(a,b);drawJoinImg(b,a,c)}function drawJoinImg(a,b,c){var d=guid(8,"join"),e=c.PatientInfo.PatientID.val,f=c.ImageInfo.PixelSpacing.val,g=f.split("\\"),h=parseInt(c.ImageInfo.Columns.val),i=parseInt(c.ImageInfo.Rows.val),j=joinImgSize(h,i),k=parseFloat(g[0])*h,l=parseFloat(g[1])*i;g[0]=k/j[0],g[1]=l/j[1];var m={stdId:c.studyId,studyId:c.StudyInfo.StudyId.val,id:d,imageId:b,seriesId:a,pixelSpacing:f,spacingX:g[0],spacingY:g[1],patientID:e,studyTime:c.StudyInfo.StudyTime.val,modality:c.SeriesInfo.Modality.val,studyDate:c.StudyInfo.StudyDate.val,name:c.PatientInfo.PatientName.val,sex:c.PatientInfo.PatientSex.val,age:c.PatientInfo.PatientsAge.val,birthDate:c.PatientInfo.PatientBirthDate.val,hosName:c.EquipmentInfo.InstitutionName.val,describe:c.StudyInfo.StudyDescription.val,actualW:k,actualH:l,imgW:h,imgH:i};addJoinImg(m),fillImageSimple(d,b)}function dragVerify(a,b){var c={patientCheck:"",pixelSpacingCheck:"",isFit:!0};return $(".join-img").each(function(){var d=$(this).attr("patientID"),e=$(this).attr("pixelSpacing");d!=a&&(c.patientCheck="拖入图像与当前图像病人ID不一致！",c.isFit=!1),e!=b&&(c.pixelSpacingCheck="拖入图像与当前图像成像参数不一致！",c.isFit=!1)}),c}function addJoinImg(a){joinStruct.studyId=a.stdId;var b=$(template("joinImgTemp",a));$(".join-img-box").append(b),b.draggable({containment:".join-img-box",stack:b,scroll:!1,start:function(){b.css("opacity","0.5")},drag:function(){},stop:function(){b.css("opacity","1")}}),$(".join-img-box.join-img").draggable({stack:".join-img-box.join-img"}),$(".join-img").hover(function(){$(".adjustDiv").find(".btn").show()},function(){$(".adjustDiv").find(".btn").hide()})}$(function(){"use strict";var a=window.console||{log:function(){}},b=$(".docs-alert"),c=b.find(".message"),d=function(a,d){c.text(a),d&&c.addClass(d),b.fadeIn(),setTimeout(function(){b.fadeOut()},3e3)};!function(){var b=$(".img-container > canvas"),c=$("#dataX"),e=$("#dataY"),f=$("#dataHeight"),g=$("#dataWidth"),h=($("#dataRotate"),{aspectRatio:16/9,preview:".join-scan",crop:function(a){c.val(Math.round(a.x)),e.val(Math.round(a.y)),f.val(Math.round(a.height)),g.val(Math.round(a.width))}});b.on({"ready.cropper":function(a){},"start.cropper":function(a){},"move.cropper":function(a){},"end.cropper":function(a){},"crop.cropper":function(a){},"zoom.cropper":function(a){},"build.cropper":function(a){},"built.cropper":function(a){},"dragstart.cropper":function(a){},"dragmove.cropper":function(a){},"dragend.cropper":function(a){},"zoomin.cropper":function(a){},"zoomout.cropper":function(a){}}).cropper(h),$(document.body).on("click","[data-method]",function(){var c,d,e=$(this).data();if(e.method){if(e=$.extend({},e),"undefined"!=typeof e.target&&(c=$(e.target),"undefined"==typeof e.option))try{e.option=JSON.parse(c.val())}catch(f){a.log(f.message)}if(d=b.cropper(e.method,e.option),"getCroppedCanvas"===e.method&&$("#getCroppedCanvasModal").modal().find(".modal-body").html(d),$.isPlainObject(d)&&c)try{c.val(JSON.stringify(d))}catch(f){a.log(f.message)}}}).on("keydown",function(a){switch(a.which){case 37:a.preventDefault(),b.cropper("move",-1,0);break;case 38:a.preventDefault(),b.cropper("move",0,-1);break;case 39:a.preventDefault(),b.cropper("move",1,0);break;case 40:a.preventDefault(),b.cropper("move",0,1)}});var i,j=$("#inputImage"),k=window.URL||window.webkitURL;k?j.change(function(){var a,c=this.files;c&&c.length&&(a=c[0],/^image\/\w+$/.test(a.type)?(i=k.createObjectURL(a),b.one("built.cropper",function(){k.revokeObjectURL(i)}).cropper("reset",!0).cropper("replace",i),j.val("")):d("Please choose an image file."))}):j.parent().remove(),$(".docs-options :checkbox").on("change",function(){var a=$(this);h[a.val()]=a.prop("checked"),b.cropper("destroy").cropper(h)}),$('[data-toggle="tooltip"]').tooltip()}()});var joinOutputIndex=0,joinOutputObj=[],joinObj=[],cropImgArr=[];cornerstone.registerImageLoader("loadCropImg",loadCropImg),cornerstone.registerImageLoader("loadJoinImg",loadJoinImg);var joinCutObj=[];cornerstone.registerImageLoader("loadTempImg",loadTempImg),$(function(){$("#openJoin").click(function(){setTitle("join","null","拼接页面"),$(".join-box").show(),$(".join-cointainer-box").show(),$(".print-box").hide(),dvStruct.dragOpt.print.join.show=!0}),$(".back-to-print").click(function(){setTitle("join","null","拼接页面"),$(".join-img-box").empty(),$(".join-box").hide(),$(".print-box").show(),$(".cut-scan-box").hide(),$(".join-img-box").show(),$(".cut-img-box").hide(),dvStruct.dragOpt.print.join.show=!1,$(window).resize()}),$(document).on("click",".join-img",function(){var a=parseInt($(this).css("z-index"));a=a<0||NaN==a?1:getMaxZindex()+1,$(this).css("z-index",a)}),$(document).on("click",".join-adjust",function(){joinStruct.cutImgEnable=!0,joinStruct.cutBoxEnable=!1,setTitle("cut","img","裁剪页面"),$(this).parents(".join-img").addClass("cutActive").siblings().removeClass("cutActive");var a=$(this).parents(".join-img").width(),b=$(this).parents(".join-img").height(),c=$(this).parents(".join-img").find(".cornerstone-canvas").get(0);$(".cut-box").width(a),$(".cut-box").height(b),$(".cut-box").attr("studyId",$(".cutActive").attr("studyId")),$(".cut-box").attr("patientID",$(".cutActive").attr("patientID")),$(".cut-box").attr("studyTime",$(".cutActive").attr("studyTime")),$(".cut-box").attr("modality",$(".cutActive").attr("modality")),$(".cut-box").attr("name",$(".cutActive").attr("name")),$(".cut-box").attr("studyDate",$(".cutActive").attr("studyDate")),$(".cut-box").attr("sex",$(".cutActive").attr("sex")),$(".cut-box").attr("age",$(".cutActive").attr("age")),$(".cut-box").attr("birthDate",$(".cutActive").attr("birthDate")),$(".cut-box").attr("hosName",$(".cutActive").attr("hosName")),$(".cut-box").attr("describe",$(".cutActive").attr("describe")),$(".cut-box").attr("W",$(".cutActive").attr("W")),$(".cut-box").attr("H",$(".cutActive").attr("H")),$(".cut-box").attr("spacingX",$(".cutActive").attr("spacingX")),$(".cut-box").attr("spacingY",$(".cutActive").attr("spacingY")),$(".cut-box").attr("actualW",$(".cutActive").attr("actualW")),$(".cut-box").attr("actualH",$(".cutActive").attr("actualH"));var d=$("#cutCanv")[0];d.width=a,d.height=b;var e=d.getContext("2d");e.fillStyle="#000000",e.fillRect(0,0,a,b),e.drawImage(c,0,0,a,b),$(".join-cointainer-box").hide(),$(".cut-img-box").show(),$(".cut_destory").click(),$(".cut_reset").click(),hideTool("cropPageS",0);var f=($(".join-cut-box").height()-$(".cut-box").height())/2,g=f>0?f:0;$(".cut-box").css({marginTop:g+"px"})}),$(document).on("click",".join-delete",function(){$(this).parents(".join-img").remove()}),$(document).on("dblclick",".join-img",function(){if($(this).hasClass("joinImgSelec"))$(this).removeClass("joinImgSelec"),$(this).find(".active").remove();else{var a='<div class="active"><img src="../img/print/join_ok.png"></div>';$(this).append(a),$(this).addClass("joinImgSelec")}}),$(".join-cutBox").on("click",function(){joinStruct.cutBoxEnable=!0,setTitle("cut","all","裁剪页面"),createCutBoxCanv()&&($(".join-cointainer-box").hide(),$(".cut-img-box").show()),$(".cut_destory").click(),$(".cut_reset").click(),hideTool("cropPageS",2)}),$(".join-cutSure").on("click",function(){var a={xstart:$(".cropper-crop-box").position().left,ystart:$(".cropper-crop-box").position().top,width:$(".cropper-crop-box").width(),height:$(".cropper-crop-box").height()},b=$("#cutCanv")[0].getContext("2d"),c=b.getImageData(a.xstart,a.ystart,a.width,a.height);$(".join-scan").width(a.width),$(".join-scan").height(a.height);var d=$("#cutScanCanv")[0];d.width=a.width,d.height=a.height;var e=$("#cutScanCanv")[0].getContext("2d");if(e.putImageData(c,0,0),joinStruct.cutBoxEnable){setTitle("scan","all","预览页面"),$(".cut-img-box").hide(),$(".cut-scan-box").show();var f=($(".cut-scan-box").width()-$(".join-scan").width())/2,g=f>0?f:0;$(".join-scan").css({marginLeft:g+"px"}),joinStruct.cutBoxEnable=!1}else if(joinStruct.cutImgEnable){setTitle("join","null","拼接页面"),$(".cutActive").width(a.width),$(".cutActive").height(a.height),$(".cutActive canvas").width(a.width),$(".cutActive canvas").height(a.height);var h=$(".cutActive canvas")[0];h.width=a.width,h.height=a.height;var i=h.getContext("2d");i.putImageData(c,0,0),$(".join-cointainer-box").show(),$(".cut-img-box").hide(),joinStruct.cutImgEnable=!1}}),$(".join-undo").on("click",function(){setTitle("cut","all","裁剪页面"),joinStruct.cutBoxEnable=!0,$(".cut-img-box").show(),$(".cut-scan-box").hide(),hideTool("cropPageS",2)}),$(".join-back").on("click",function(){$(".join-cointainer-box").show(),$(".cut-img-box").hide(),setTitle("join","null","拼接页面")}),$(".join-sendToPrint").on("click",function(){sendToPrint("join",!0,!0,!0)}),$(".cut-sendToPrint").on("click",function(){sendToPrint("crop",!0,!0,!0)}),$(".join-save").on("click",function(){if(joinStruct.cutBoxEnable=!0,createCutBoxCanv()){var a=$("#cutCanv")[0],b=a.toDataURL("image/jpeg"),c=$(".join-img").attr("spacingX"),d=$(".join-img").attr("spacingY"),e={studyId:joinStruct.studyId,imgDataStr:b.substring(23,b.length),pixelSpacing:c+"\\"+d};uploadJoinImage(e)}$(".cut_destory").click(),$(".cut_reset").click(),hideTool("cropPageS",2)}),$(".cut-save").on("click",function(){var a=$("#cutScanCanv")[0],b=a.toDataURL("image/jpeg"),c=$(".join-img").attr("spacingX"),d=$(".join-img").attr("spacingY"),e={studyId:joinStruct.studyId,imgDataStr:b.substring(23,b.length),pixelSpacing:c+"\\"+d};uploadJoinImage(e)})});