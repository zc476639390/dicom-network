/*!ipacs4.0 - 1.0.0-2021-06-16 */
function checkAndSynByWinId(a){if(dvStruct.synposition.enable){var b=dvStruct.viewer.findWin(a),c=b.wrappers[0],d=c.stack,e=d.imageIds[d.currentImageIdIndex];dvStruct.synposition.findAndSyn(e,c)}}function updateTotalImgNo(a){for(var b=0,c=a.wrappers.length;b<c;b++){var d=a.wrappers[b],e=d.stack.imageIds.length;if(e>0){var f=$(d.element).parent();$(f).find(".js-info-totalNo").text("/"+e)}}}function reDrawWrapper(a){var b=a.stack.imageIds[a.stack.currentImageIdIndex];if(b)try{cornerstone.disable(a.element),cornerstone.enable(a.element),cornerstone.loadImage(b).then(function(b){cornerstone.displayImage(a.element,b),cornerstoneTools.scaleOverlayTool.enable(a.element),cornerstoneTools.overlayTool.enable(a.element),cornerstone.updateImage(a.element),b.hasOwnProperty("stack")&&(cornerstoneTools.addStackStateManager(a.element,["stack","playClip"]),cornerstoneTools.addToolState(a.element,"stack",b.stack),cornerstoneTools.playClip(a.element,b.cineRate)),cornerstoneTools.orientationMarkers.enable(a.element),cornerstoneTools.mouseInput.enable(a.element),cornerstoneTools.wwwc.activate(a.element,1),cornerstoneTools.stackScrollWheel.activate(a.element)})}catch(c){console.error(c)}}function drawOverlay(a,b){var c=cornerstone.getViewport(a),d=dvStruct.viewer.findOriInfoByIds(b);console.log(a,c,d)}function changeInfo(a,b){b.name&&(a.PatientInfo.PatientName.val=b.name),b.gender&&(a.PatientInfo.PatientSex.val=b.gender),b.ageView&&(a.PatientInfo.PatientsAge.val=b.ageView),b.itemName&&(a.StudyInfo.StudyDescription.val=b.itemName),b.patientNum&&(a.PatientInfo.PatientID.val=b.patientNum),b.studyNum&&(a.StudyInfo.StudyId.val=b.studyNum),b.hosName&&(a.EquipmentInfo.InstitutionName.val=b.hosName)}function loadingProcess(a){var b=a.url,c=new Promise(function(c,d){if("jpg"==a.imageType&&(io.process++,$("#progressText").text(io.process+"/"+io.total)),"dicom"==a.imageType){var e="wadouri:"+b;cornerstone.loadAndCacheImage(e).then(function(b){dvStruct.imgObjArr.push(b),io.process++,$("#progressText").text(io.process+"/"+io.total);var d=getDicomInfo(b.data);d.signId=a.signId,d.isSign=a.isSign,d.studyId=a.studyId,a.detail&&changeInfo(d,a.detail),1==a.detail.urlMode&&(a.seriesId=d.UIDS.SeriesUID.val,a.studyDateTime=d.StudyInfo.StudyDate.val+d.StudyInfo.StudyTime.val,a.studyId=d.UIDS.StudyUID.val);var f={dataSet:b.data,infoSet:d,imageId:e,instanceNo:parseInt(d.InstanceInfo.InstanceNumber.val),signId:a.signId,imageType:a.imageType};""!=d.SeriesInfo.SeriesNo.val&&(a.seriesNo=d.SeriesInfo.SeriesNo.val),dvStruct.addDicom(f,a),c({isSuccess:!0,data:a,e:null})})["catch"](function(b){c({isSuccess:!1,txt:"图像资源访问失败",error:b,data:a,statusText:b.statusText})})}else if("jpg"==a.imageType){var f=new XMLHttpRequest;f.responseType="arraybuffer",f.onreadystatechange=function(b){4==f.readyState&&0!=f.status&&(console.log(f),c({isSuccess:!1,txt:"jpg加载问题",xhr:f,data:a,statusText:f.statusText}))},f.open("get",a.url,!0),f.send();var g={};g.signId=a.signId,g.isSign=a.isSign;var h={dataSet:[],infoSet:g,imageId:a.imageId,instanceNo:a.instanceNo,signId:a.signId,imageType:a.imageType};dvStruct.addDicom(h,a),c({isSuccess:!0,data:a,e:null,xhr:f})}});return c}function dealUrlFile(a,b,c,d){var e=c.name.lastIndexOf("."),f=c.name.substring(e,c.name.length);if(".zip"!=f.toLowerCase()){var g=a+"."+c.name,h=b.file(c.name).async("uint8array");h.then(function(a){var b="byteArray:"+g;cornerstone.loadByteArrayImage(b,a).then(function(a){var c=guid(8,"sign");dvStruct.imgObjArr.push(a),io.process++,io.total++,$("#progressText").text(io.process+"/"+io.total);var d=getDicomInfo(a.data),e=dvStruct.findSeries(d.UIDS.SeriesUID.val),f=1;e&&(f=e.dicomArr.length+1);var h={studyId:com.studyId(!1),studyDateTime:d.StudyInfo.StudyDate.val+d.StudyInfo.StudyTime.val,seriesNo:d.SeriesInfo.SeriesNo.val,seriesId:d.UIDS.SeriesUID.val,url:g,index:parseInt(d.SeriesInfo.SeriesNo.val),imageType:"dicom",signId:c,isSign:!1,instanceNo:parseInt(d.InstanceInfo.InstanceNumber.val),imageId:b,totalCount:f,detail:{urlMode:!0}};d.signId=c,d.isSign=!1,d.studyId=com.studyId(!1);var i={dataSet:a.data,infoSet:d,imageId:b,instanceNo:parseInt(d.InstanceInfo.InstanceNumber.val),signId:c,imageType:"dicom"};dvStruct.addDicom(i,h)})["catch"](function(a){console.log("zip中包含非法文件"+c.name)})})}else goUrlZipWay(c,d)}function goUrlZipWay(a,b){var c=new JSZip,d=c.loadAsync(a._data.compressedContent);d.then(function(a){for(var c in a.files){var d=a.files[c];d.dir||dealUrlFile(a,d,b)}})}function findDetail(a,b){return _.find(a,function(a){return a.id==b})}function loadOthers(a,b,c,d,e,f){for(var g=1;g<b;g++){var h=a[g],i={studyId:c,studyDateTime:d,seriesNo:e,seriesId:h.seriesId,url:h.url,index:g+1,imageType:h.imageType,signId:h.id,isSign:1==h.flag,instanceNo:g,imageId:h.url,totalCount:b,detail:f};loadingProcess(i).then(function(a){a.isSuccess||(console.log("others error",a),a.hasOwnProperty("statusText")&&loadTips(a))})}}function asyncLoad(a,b){var c=a.data.data,d=(a.data.seriesCount||0,a.data.fileType),e={total:0,initData:[],leftData:[]};if(c&&Array.isArray(c)?(e.total+=c.length,c.forEach(function(a,b){if(d&&"zip"==d)io.Url.load(a,b);else{var c={studyId:com.studyId(!1),studyDateTime:new Date,seriesNo:0,seriesId:new Date,url:a,imageType:"dicom",signId:b,isSign:!1,instanceNo:b,index:b,imageId:a,totalCount:1,detail:{urlMode:!0}};e.initData.push(c)}})):c&&"object"==typeof c&&Object.keys(c).forEach(function(a){Object.keys(c[a]).forEach(function(d){Object.keys(c[a][d]).forEach(function(f){var g=c[a][d][f].length;c[a][d][f].forEach(function(h,i){if("dicom"==h.imageType||"jpg"==h.imageType){var j={studyId:a,studyDateTime:d,seriesNo:f,seriesId:h.seriesId,url:h.url,imageType:h.imageType,signId:h.id,isSign:1==h.flag,instanceNo:i,index:i,imageId:h.url,totalCount:g,detail:findDetail(b,a)};0==i?(e.initData.push(j),e.total+=c[a][d][f].length):e.leftData.push(j)}})})})}),!d){io.total=e.total;var f=e.initData.concat(e.leftData),g=f.length,h=Math.ceil(g/eSetting.load.asyncTH);if(g<=h)f.forEach(function(a){loadingProcess(a).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&loadTips(a)})});else for(var i=Math.ceil(g/h),j=0;j<=i&&!(j*h>=f.length);j++)syncLoad(f.slice(j*h,(j+1)*h),j);0==g&&$("#progressText").text("图像数：0")}}function syncLoad(a,b){loadingProcess(a[0]).then(function(c){c.isSuccess||c.hasOwnProperty("statusText")&&loadTips(c),a.splice(0,1),a.length>0&&syncLoad(a,b)})}function loadTips(a){if($(".load-alert").show(),!a.isSuccess){var b=a.data;switch(a.statusText){case"Not Found":$(".not-exit-box").show();var c='  <div class="item"><div  class="txt">URL:</div><div class=" val locked-image"  >'+b.url+"</div> </div>";$(".not-exit-box .item-box").append(c);break;case"Forbidden":if($('div[lockedId="'+b.studyId+'"]').length<1){var c='  <div class="item"><div  class="txt">检查号:</div><div class=" val locked-image" lockedId="'+b.studyId+'">'+b.studyId+'</div><div class="unlock">解锁</div><div class="unlock-state"></div></div>';$(".locked-box").show(),$(".locked-box .item-box").append(c)}break;default:$(".cross-origin-box").show();var d=guid(8,"reload");if($("#"+d).length<1){var c='  <div class="item"  id="'+d+'" ><div  class="txt">URL:</div><div class=" val locked-image" >'+b.url+"</div></div>";$(".cross-origin-box .item-box").append(c),$("#"+d).click(function(){loadingProcess(b).then(function(a){a.isSuccess&&$("#"+d).remove()})})}}}}function fillColormapsList(){var a=document.getElementById("colormaps"),b=cornerstone.colors.getColormapsList(),c=function(b,c){var d=document.createElement("OPTION");d.value=b,d.textContent=c,a.appendChild(d)};b.forEach(function(a){c(a.id,a.name)})}function layoutMatch(a,b,c){var d=1,e=1;return d=Math.floor(Math.sqrt(a)),d*d<a&&d++,d>c&&(d=c),e=Math.floor(a/d),e*d<a&&e++,e>b&&(e=b),[e,d]}function initSeriesWorkWindows(a,b){function c(a,b){return a.sNum-b.sNum}if(b.seriesCount){var d=layoutMatch(b.seriesCount,dvStruct.viewer.maxRow,dvStruct.viewer.maxCol);dvStruct.viewer.col=d[1],dvStruct.viewer.row=d[0]}var e=b.data,f=0;if(b.seriesCount&&b.seriesCount>0){var g=[];Object.values(e).forEach(function(a){var b=[];Object.values(a).forEach(function(a){Object.values(a).forEach(function(a){return!(f>=dvStruct.viewer.maxRow*dvStruct.viewer.maxCol)&&void("jpg"!=a[0].imageType&&b.push({sNum:a[0].sNum,seriesId:a[0].seriesId,length:a.length}))})}),b.sort(c),g.push(b)}),g.forEach(function(a){a.forEach(function(a){return!(f>=dvStruct.viewer.maxRow*dvStruct.viewer.maxCol)&&void dvStruct.addWaitingBind(a.seriesId,dvStruct.viewer.winArr[f++],a.length)})})}}function initViewSize(){var a=$(".main-engine-box").width(),b=$(".main-engine-box").height(),c=$(".top-tool-box").height(),d=$(".work-box"),e=a,f=b-c;if($(".work-box").height(f),dvStruct.dblclickFlag.winNo==dvStruct.dblclickFlag.winNoMax){var g=100/dvStruct.viewer.row,h=100/dvStruct.viewer.col;$(".series").css({height:g+"%",width:h+"%"}),dvStruct.viewer.eachW=$(".series").width(),dvStruct.viewer.eachH=$(".series").height(),$(".series").each(function(){var a=$(this).attr("id"),b=dvStruct.viewer.calInnerEachSize(a);$(this).find(".viewWrapper").css({height:100*b[1]+"%",width:100*b[0]+"%"})}),$(".series").show()}else dvStruct.viewer.eachW=e,dvStruct.viewer.eachH=f,d.find(".seriesCheck").css({height:f+"px",width:e+"px"}),d.find(".seriesCheck").css({height:f+"px",width:e+"px"}),d.find(".seriesCheck").siblings().css({height:"0px",width:"0px"}),d.find(".seriesCheck").siblings().hide();dvStruct.viewer.eachElement({callback:function(a){cornerstone.resize(a,!0)}})}function onViewportUpdated(a){var b=a.target;if(b){var c=cornerstone.getViewport(b),d=dvStruct.viewer.getWrapperById($(b).attr("id")),e=$(b).parent();if(!$(e).attr("studydate"))return!1;$(e).find(".js-info-wwwc").text("WC/WW: "+Math.round(c.voi.windowCenter)+"/"+Math.round(c.voi.windowWidth)),$(e).find(".js-info-zoom").text("Zoom: "+c.scale.toFixed(2));var f=cornerstoneTools.getToolState(d.element,"stack");if(void 0===f||void 0===f.data||0===f.data.length)return;var g=(f.data[0],cornerstone.getImage(b).imageId);$(e).attr("imageId",g);var h=dvStruct.viewer.findOriInfoByIds(g);if(h){var i=h.SeriesInfo.SliceThickness.val,j=h.SeriesInfo.SliceLocation.val;if(i||j){try{i=i?parseFloat(i).toFixed(1):i,j=j?parseFloat(j).toFixed(1):j}catch(a){console.error(a)}$(e).find(".js-info-tl").text("T: "+i+"mm L: "+j+"mm")}}}}function reLayoutSeriesWin(a){a&&(dvStruct.viewer.row=a[0],dvStruct.viewer.col=a[1]);var b=1/dvStruct.viewer.row,c=1/dvStruct.viewer.col;$(".series").css({height:100*b+"%",width:100*c+"%"}),dvStruct.viewer.eachW=parseInt($(".series").width()),dvStruct.viewer.eachH=parseInt($(".series").height()),$(".series").each(function(){var a=$(this).attr("id"),b=dvStruct.viewer.calInnerEachSize(a);$(this).show(),$(this).find(".viewWrapper").css({height:100*b[1]+"%",width:100*b[0]+"%"}),dvStruct.viewer.eachElement({callback:function(a){cornerstone.resize(a,!0)}})}),$(".js-fullScreen").show(),$(".js-restore").hide()}function getTargetStd(a,b){if(dvStruct.dblclickFlag.winNo!=dvStruct.dblclickFlag.winNoMax)return{col:dvStruct.viewer.col,row:dvStruct.viewer.row,winNo:dvStruct.dblclickFlag.winNo};var c=$(".top-tool-box").height(),d=$(".left-box").width(),e=Math.ceil((a-d)/dvStruct.viewer.eachW),f=Math.ceil((b-c)/dvStruct.viewer.eachH),g=dvStruct.viewer.col*(f-1)+e-1;return{col:e-1,row:f-1,winNo:g}}function getModePage(a){if("mpr"==a?$(".js-freehand").hide():$(".js-freehand").show(),$(".mode-page").each(function(){$(this).attr("mode")==a?$(this).show():$(this).hide()}),"viewer"==a)dvStruct.viewer.eachElement({callback:function(a){cornerstone.resize(a,!0)}}),$(".measure-tool-box .tools").show();else if("print"==a){if($(".film-page").each(function(a){0==a?($(this).empty(),$(this).addClass("film-page-check"),$(this).removeClass("film-page-uncheck"),$(".cur-film-page").val(1),$(".total-film-page").text(1)):$(this).remove()}),$(".film-page-check").find(".atom").length<1){var b=$(".film-page-check").attr("id"),c=getPaperSetCookie();console.log("first init print page",b,c);var d=com.cookie("filmTypes");d&&(d=d.split(","),initFilmTypes(d)),changePaperSet(c),initPaperSize(c,b),initLayout(c,b,!1)}else{var c=getPaperSet(),e=filmPaperSize(paperSizeMap(c.paperType),c.paperDirect),f=$(".film-page").width(),g=$(".film-page").height();Math.ceil(e[0])==f&&Math.ceil(e[1])==g||(initPaperSize(c,"",!0),resizeAtom())}$(".measure-tool-box .tools").hide()}Object.keys(dvStruct.dragOpt).forEach(function(b){a==b?dvStruct.dragOpt[b].show=!0:dvStruct.dragOpt[b].show=!1})}function layoutSelectorBuilder(a,b,c){var d={cols:a,rows:b,layoutSelector:void 0,getLayoutSelector:function(){return function(){return d.layoutSelector||function(){for(var a=d,b=23*a.cols+4,e=23*a.rows+4,f='<div style="height:'+e+"px;width:"+b+'px;visibility: hidden" id="'+c+'">',g=0,h=a.cols*a.rows;g<h;g++)g%a.cols==0&&(f+='<div class="urow">'),f+='<div class="ucol" colNum='+(g%a.cols+1)+" rowNum="+(parseInt(g/a.cols)+1)+" ></div>",g%a.cols==a.cols-1&&(f+="</div>");return f+="</div>",$(document.body).append(f),d.layoutSelector=document.getElementById(c)}()}}(),show:function(a,b){unit.mask.show();var c=this.getLayoutSelector();if("left"==b)var d=$(c).width(),e=a.y,f=a.x-d;else var e=a.y,f=a.x;$(c).css({top:e+"px",left:f+"px"}),$(c).css("visibility","visible"),this.onSelecting()},hide:function(){var a=this.getLayoutSelector();$(a).css("visibility","hidden"),unit.mask.hide()},onSelecting:function(){var a=this;$(document.body).on("mousemove",function(b){a.getNowColAndRow(b)}),$(document.body).on("mousedown",function(b){$(document.body).off("mousedown"),$(document.body).off("mousemove"),a.endSelecting(b)})},endSelecting:function(a){this.hide();var b=this.getNowColAndRow(a);0!=b.col&&0!=b.row&&this.callback(b)},getNowColAndRow:function(a){var b=this.getLayoutSelector(),c=($(b).offset(),a.pageX),d=a.pageY,e=0,f=0;$(b).find(".ucol").each(function(){var a=$(this).offset();if(c>a.left&&d>a.top){$(this).addClass("lighten");var b=parseInt($(this).attr("colNum")),g=parseInt($(this).attr("rowNum"));b>e&&(e=b),g>f&&(f=g)}else $(this).removeClass("lighten")});var g={col:e,row:f};return g},callback:function(){}};return d}function changeMgSet(){const a=$("#mg-scale").val();$(".mg-scale-val").text(a),magnifyConfig.magnificationLevel=parseInt(a),cornerstoneTools.magnify.setConfiguration(magnifyConfig),setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)})}function getVoxelDimensions(a){this.series=a;var b,c,d,e=null,f=this.series.dicomArr[0].infoSet,g=this.series.dicomArr[1].infoSet;return d=f.ImageInfo.PixelSpacing.val.split("\\")||[0,0],b=Math.max(parseFloat(f.SeriesInfo.SpacingBetweenSlices.val),parseFloat(f.SeriesInfo.SliceThickness.val)),c=Math.abs(parseFloat(f.SeriesInfo.SliceLocation.val)-parseFloat(g.SeriesInfo.SliceLocation.val)),0===c&&(c=b),e={colSize:Math.abs(parseFloat(d[0])),rowSize:Math.abs(parseFloat(d[1])),sliceSize:Math.abs(c)},e||(0===e.rowSize&&(e.rowSize=1),0===e.colSize&&(e.colSize=1),0===e.sliceSize&&(e.sliceSize=1)),e}function getPrinterSet(){var a=$(".printBoxSelect option:selected"),b={id:a.attr("data-id"),name:a.attr("data-name"),printerType:a.attr("data-printerType"),ip:a.attr("data-ip"),aet:a.attr("data-aet"),aetLocal:a.attr("data-aetLocal"),port:a.attr("data-port"),position:a.attr("data-position"),type:a.attr("data-type"),priority:a.attr("data-priority"),color:a.attr("data-color"),magnifyType:a.attr("data-magnifyType")};return b}function initWebEngine(){function a(a){200==a.status?(new Monitor(a.msg),$("#container").engine(a.data),changeLocation(),printerShow(),tagShow(),com.getByClassify("CT",callbacks.wwwcShow),com.detail(function(b){asyncLoad(a,b.data)})):pop_up({type:"error",title:"提示",message:a.msg,yesName:"确定",noName:"取消"})}com.study(a)}function browseFolder(a){try{var b="请选择文件夹",c=new ActiveXObject("Shell.Application"),d=c.BrowseForFolder(0,b,64,17);if(null!=d)return d=d.items(),d=d.item(),d=d.Path,"\\"!=d.charAt(d.length-1)&&(d+="\\"),document.getElementById(a).value=d,d}catch(e){alert(e.message)}}function dataURLtoBlob(a){for(var b=a.split(","),c=b[0].match(/:(.*?);/)[1],d=atob(b[1]),e=d.length,f=new Uint8Array(e);e--;)f[e]=d.charCodeAt(e);return new Blob([f],{type:c})}function getBase64Image(a){var b=new Image;b.src=a,b.onload=function(a){var c=document.createElement("canvas");c.width=b.width,c.height=b.height;var d=c.getContext("2d");d.drawImage(b,0,0,b.width,b.height);c.toDataURL("image/png")};var c=document.createElement("canvas");c.width=b.width,c.height=b.height;var d=c.getContext("2d");d.drawImage(b,0,0,b.width,b.height);var e=c.toDataURL("image/png");return e}function dvLocalLoader(a){var b=_.find(dvStruct.imgObjArr,function(b){return b.imageId==a});return b.imagePromise}function dvSeriesLoader(a){var b,c=a.split(":");winId=c[1];var d=_.find(dvStruct.viewer.winArr,function(a){return a.winId==winId});if(_.isObject(d))var b=_.find(d.imgObjArr,function(b){return b.imageId==a});return _.isObject(b)?b.imagePromise:void console.error("dvSeriesLoader:no re no imagePromise")}function setAllEle(a){dvStruct.viewer.eachElement({callback:function(b,c){try{var d=cornerstone.getImage(b);_.isObject(d)&&a(b)}catch(e){console.error(e)}}})}function disablePaging(){$(".seriesWindow").each(function(a,b){var c=_.find(dvStruct.viewer.winArr,function(b){return b.no==a});if(dvStruct.fun.synPagingCheck(c),_.isObject(c))for(var d=0,e=c.col*c.row;d<e;d++){var f=c.wrappers[d],g=f.stack,h=f.element,i=g.imageIds[g.currentImageIdIndex];void 0!=i&&cornerstone.loadImage(i).then(function(a){cornerstone.displayImage(h,a),cornerstoneTools.removeToolState(h,"stack",g),cornerstoneTools.stackScroll.deactivate(h,1)})}})}function clearwwwc(){$(".device1").val("CT"),$(".wlInput").val(""),$(".wwInput").val(""),$(".modifyName").val("")}function viewerQuickWindow(a){console.log(a),isNaN(a.ww)||isNaN(a.wc)||($(".widthInput").val(a.ww),$(".centerInput").val(a.wc),dvStruct.fun.wwwc(a.ww,a.wc))}function mprQuickWindow(a){if(console.log(a),!isNaN(a.ww)&&!isNaN(a.wc)){$(".widthInput").val(a.ww),$(".centerInput").val(a.wc);var b=a.ww,c=a.wc;isNaN(b)||isNaN(c)||($("#ChangeRange-0Min0").val(c-b/2),$("#ChangeRange-0Min0").change(),$("#ChangeRange-0Max0").val(c+b/2),$("#ChangeRange-0Max0").change()),$(".mpr-viewport").each(function(){var a=$(this).get(0);if(a){cornerstone.enable(a);var d=cornerstone.getViewport(a);d&&(d.voi.windowWidth=b,d.voi.windowCenter=c,cornerstone.setViewport(a,d))}})}}function printQuickWindow(a){console.log(a);var b=$(".print-proc-box").attr("data-procType"),c=getSelecNodes(b);isNaN(a.ww)||isNaN(a.wc)||($("#printSetww").val(a.ww),$("#printSetwc").val(a.wc),c.forEach(function(b){b.each(function(){var b=$(this).attr("id"),c=$("#"+b).get(0),d=cornerstone.getViewport(c);d.voi.windowCenter=a.wc,d.voi.windowWidth=a.ww,cornerstone.setViewport(c,d),cornerstone.updateImage(c),fillImgWWWL(b)})}))}function signAction(a,b,c,d){function e(c){200==c.status?(console.log(c),changeSignLocal(b,a,d)):pop_up({title:"error提示",message:"请求失败，"+c.msg,yesName:"确定",noName:"取消"})}var f={ids:c,flag:d};com.doFlag(f,e)}function changeSignLocal(a,b,c){dvStruct.seriesArr.forEach(function(d){if(d.seriesId==b)return d.dicomArr.forEach(function(b){if(b.imageId==a)return b.infoSet.isSign=c,!1}),!1})}function disableAllTools(a){dvStruct.viewer.eachElement({callback:function(b,c){try{if(b){var d=cornerstone.getImage(b);_.isObject(d)&&dvStruct.fun.disableTools(b,a)}}catch(e){console.error(e)}}})}function topScrollX(){var a=0;$(".tool_btn").each(function(){a+=$(this).parent().outerWidth(!0)}),a+=$(".tool_window").width(),$("#top_tool").width(a)}function btnShowCheck(){$(".seriesWindow").each(function(){var a=parseInt($(this).attr("seriesLength"))||0,b=$(this).find(".js-info-Modality").text();b.toLowerCase().indexOf("ct")>=0||$(this).find(".js-lungAI").hide(),a>=1?$(this).find(".js-syn").show():($(this).find(".js-syn").hide(),$(this).find(".js-lungAI-shiyan").hide()),a>5?(b.toLowerCase().indexOf("ct")>=0||b.toLowerCase().indexOf("mr")>=0?($(this).find(".js-VR").show(),$(this).attr("vr",!0)):($(this).find(".js-VR").hide(),$(this).attr("vr",!1)),$(this).find(".js-mpr").show()):($(this).find(".js-mpr").hide(),$(this).find(".js-VR").hide(),$(this).attr("vr",!1))})}function bindDragToCanv(){function a(a,b,c){var d=0;return c.dicomArr.forEach(function(d){if(d.imageId&&$('div[signId="'+d.signId+'"]').length<1){var e=guid(8,"gallery"),f=d.instanceNo;if($("div[data-seriesId='"+b+"']").append(template("instancePreviewTemp",{id:e,studyId:a,seriesId:b,imageId:d.imageId,seriesNo:c.seriesNo,instanceNo:f,signId:d.signId})),"jpg"!=d.imageType){var g=$(dvStruct.container).find("#"+e).get(0);cornerstone.enable(g),cornerstoneTools.mouseWheelInput.disable(g),$(g).off("mousewheel DOMMouseScroll"),cornerstone.loadImage(d.imageId).then(function(a){cornerstone.displayImage(g,a)})}else{var h=document.createElement("img");h.src=d.imageId,$(dvStruct.container).find("#"+e).append(h)}}}),d=$(".series-scan-check").parents(".series-scan-box").find(".instance-scan").length*$(".instance-scan").height()+$(".series-title").height()}$(document).on("click",".folder .folderInStudy",function(a){$(this).hide(),$(this).parent().find(".folderOutStudy").show(),$(this).parents(".patient-scan").find(".study-time").each(function(a,b){a>0&&$(this).hide(),0==a&&$(this).find(".series-scan-box").each(function(a,b){a>0&&$(this).hide()})})}),$(document).on("click",".folder .folderOutStudy",function(a){$(this).hide(),$(this).parent().find(".folderInStudy").show(),$(this).parents(".patient-scan").find(".study-time").each(function(a,b){$(this).show(),0==a&&$(this).find(".series-scan-box").each(function(a,b){a>0&&$(this).show()})})}),$(document).on("click",".series-open",function(b){var c=$(this).attr("data-height"),d=$(this).parents(".patient-scan").attr("data-studyId"),e=$(this).parents(".series-scan-box").find(".series-scan").attr("data-seriesId"),f=dvStruct.findSeries(e);$(".instance-scan").removeClass("instance-scan-check"),$(".series-scan").removeClass("series-scan-check"),$(this).parents(".series-scan-box").find(".series-scan").addClass("series-scan-check"),(void 0==c||$(this).parents(".series-scan-box").find(".instance-scan").length<f.dicomArr.length)&&a(d,e,f),c=$(".series-scan-check").parents(".series-scan-box").find(".instance-scan").length*$(".instance-scan").height()+$(".series-title").height(),$(this).attr("data-height",$(this).parents(".series-scan-box").height()),$(this).parents(".series-scan-box").height(c),$(this).parents(".series-scan-box").find(".series-scan").height(c),$(this).parent(".series-shrink").find("li").each(function(){$(this).is(":hidden")?$(this).show():$(this).hide()})}),$(document).on("click",".series-close",function(a){var b=160;$(this).parents(".series-scan-box").height(b),$(this).parents(".series-scan-box").find(".series-scan").height(b),$(this).parent(".series-shrink").find("li").each(function(){$(this).is(":hidden")?$(this).show():$(this).hide()})}),$(document).on("mousedown",".js-dragToCanv canvas",function(b){var c=!$(this).parents(".series-scan-box").find(".series-open").is(":hidden");if(c){$(".instance-scan").removeClass("instance-scan-check"),$(".series-scan").removeClass("series-scan-check"),$(this).parents(".series-scan").addClass("series-scan-check");var d=$(this).parents(".series-scan").find(".instance-scan").length,e=$(this).parents(".patient-scan").attr("data-studyId"),f=$(this).parents(".series-scan").attr("data-seriesId"),g=dvStruct.findSeries(f),h=g.dicomArr.length;if(d<h){var i=a(e,f,g);$(".series-scan-check").parents(".series-scan-box").find(".series-shrink").attr("data-height",i)}$(this).parents(".series-scan").find(".instance-scan").addClass("instance-scan-check")}else if(hotKeyMap.ctrlDown||hotKeyMap.shiftDown||($(".instance-scan").removeClass("instance-scan-check"),$(".series-scan").removeClass("series-scan-check")),$(this).parents(".instance-scan").addClass("instance-scan-check"),$(this).parents(".series-scan").addClass("series-scan-check"),hotKeyMap.shiftDown)for(var j=$(".instance-scan-check").first().index(),k=$(".instance-scan-check").last().index(),l=j;l<k;l++)$(".series-scan-check .instance-scan").eq(l).addClass("instance-scan-check");var m=$(this).offset(),n=[];$(".instance-scan-check").each(function(){n.push({studyId:$(this).attr("data-studyId"),imageId:$(this).find(".img").attr("imageId"),seriesId:$(this).find(".img").attr("seriesId")})}),dvStruct.dragToCanv.on(n,m,b,c)}),$(document).on("click",".download",function(a){var b=$(this).parents(".patient-scan").attr("data-studyId");$(".download-params").attr("data-downRange","study"),$(".download-params").attr("data-downStudyId",b),setModeShow("download",!0),dvStruct.drawJpgForDownload("study",{studyId:b,seriesId:""})}),$(document).on("click",".series-download",function(a){if(!$(this).hasClass("forbid-download")){var b=$(this).parents(".patient-scan").attr("data-studyId"),c=$(this).parents(".series-scan-box").find(".series-scan").attr("data-seriesId");$(".download-params").attr("data-downRange","series"),$(".download-params").attr("data-downStudyId",b),$(".download-params").attr("data-downSeriesId",c),setModeShow("download",!0),dvStruct.drawJpgForDownload("series",{studyId:b,seriesId:c})}}),$(document).on("click",".close-study",function(a){var b=$("body").data("studyId"),c=$(this).parents(".patient-scan").attr("data-studyId");b=b.split(",");var d=[];b.forEach(function(a,b){a!=c&&d.push(a)});var e=btoa(com.param("token"));d=btoa(d.join(",")),localStorage.setItem("viewImgId",d);var f=document.location.toString(),g=f.split("?"),h=g[0]+"?token="+e+"&studyId="+d;window.location.replace(h)})}function changeLocation(){var a="toolsLocation",b=com.cookie(a);if("bottom"==b){var c=$(".top-tool-box");$(".top-tool-box").remove(),$(".main-engine-box").append(c)}}function getwindowVal(a){var b=0,c=0,d=!1;return $(".wwwc-box").find(".table2Body tr").each(function(){if($(this).find(".txt").text()==a)return b=parseInt($(this).find(".ww").text()),c=parseInt($(this).find(".wc").text()),d=!0,!1}),{ww:b,wc:c,exist:d}}function responseHotKey(a){switch(a){case"joinDirect":positionAdjust(hotKeyMap.direct);break;case"rapidWwwc":var b=hotKeyMap.rapidWwwc,c=getwindowVal(b);console.log(c),c.exist&&(dvStruct.dragOpt.viewer.show?viewerQuickWindow(c):dvStruct.dragOpt.mpr.show||dvStruct.dragOpt.print.show&&printQuickWindow(c));break;case"printMultiSelec":hotKeyMap.ctrlDown||hotKeyMap.shiftDown;break;case"pageChange":changeFilmPage(hotKeyMap.pageChange);break;case"imageChange":dvStruct.fun.imageChange(hotKeyMap.imageChange);break;case"layout":var d="input[type=text][name=layout-"+hotKeyMap.layout+"]";$(d).focus();break;case"layoutChange":var e=$("input[type=text][name=layout-rows]").val(),f=$("input[type=text][name=layout-cols]").val(),g={rows:parseInt(e),cols:parseInt(f)};"add"==hotKeyMap.layoutChange.action?g[hotKeyMap.layoutChange.name]+=1:g[hotKeyMap.layoutChange.name]>1&&(g[hotKeyMap.layoutChange.name]-=1),$("input[type=text][name=layout-rows]").val(g.rows),$("input[type=text][name=layout-cols]").val(g.cols),$(".customInput").change();break;case"changeWwwc":}}function setModeShow(a,b){b?($(".common-mask").show(),$(".common-pop-up-box").show(),$(".set-mode").each(function(){var b=$(this).attr("set-mode");b==a?$(this).show():$(this).hide()})):($(".common-mask").hide(),$(".common-pop-up-box").hide(),$(".set-mode").hide())}function setModeSecondShow(a,b,c){b?($(".common-pop-up-box").show(),$(".common-mask").show(),$(".set-mode-second").each(function(){var b=$(this).attr("set-mode");b==a?($(this).show(),$(this).find(".yes").hide(),$(this).find("."+c).show()):$(this).hide()})):($(".common-pop-up-box").hide(),$(".common-mask").hide(),$(".set-mode-second").hide())}var toolbarObj,sliceTypeArr=["axialImg","coronalImg","sagttialImg"],palyStart,playSpeed=350,socketPrinter,socketVR,socketMsg,flimScaleOverlayTool=!1,joinStruct={cutImgEnable:!1,cutBoxEnable:!1},fusionMap=new Array,dvStruct=dvStruct||{};if(dvStruct.viewer={col:1,row:1,maxCol:4,maxRow:4,eachW:0,eachH:0,maxInnerCol:2,maxInnerRow:2,scrollAll:!1,winArr:[],addNewWin:function(a,b){var c={winId:a,no:b,row:1,col:1,wrappers:[],imgObjArr:[],synchronizerWWWC:new cornerstoneTools.Synchronizer("CornerstoneImageRendered",cornerstoneTools.wwwcSynchronizer),synchronizerZoomPan:new cornerstoneTools.Synchronizer("CornerstoneImageRendered",cornerstoneTools.panZoomSynchronizer)};return this.winArr.push(c),c},getWinByNo:function(a){return _.find(dvStruct.viewer.winArr,function(b){return b.no==a})},calInnerEachSize:function(a){if(_.isObject(a))b=a;else var b=_.find(dvStruct.viewer.winArr,function(b){return b.winId==a});if(_.isObject(b))return[1/b.col,1/b.row]},getCheckedWin:function(){var a=$(".seriesCheck").attr("id"),b=parseInt($(".studyCheck").attr("no"));if(void 0!=a&&NaN!=b){var c=_.find(dvStruct.viewer.winArr,function(b){return b.winId==a});return c}},isInWin:function(a,b){for(var c=0,d=b.wrappers.length;c<d;c++){var e=b.wrappers[c].element;if(a==e)return!0}return!1},isInSameWin:function(a,b){return $(a).parents(".series").get(0)==$(b).parents(".series").get(0)},getWin:function(b){var c=_.find(dvStruct.viewer.winArr,function(b){return b.winId==a});return c},createWrapper:function(a,b){return{wrapperId:a.wrapperId,no:b,pid:a.pid,eid:a.eid,studyNo:a.studyNo,element:a.element,suid:void 0,stack:{currentImageIdIndex:0,imageIds:[]}}},clearWrapper:function(a){a.suid=void 0,a.stack.currentImageIdIndex=0,a.stack.imageIds=[]},eachElement:function(a){if(_.isObject(a)||(a={}),_.isObject(a.win))var b=[a.win];else var b=dvStruct.viewer.winArr;for(var c=0,d=b.length;c<d;c++)for(var e=b[c],f=0,g=e.wrappers.length;f<g;f++)a.callback&&a.callback(e.wrappers[f].element,e.wrappers[f])},eachWin:function(a){_.isObject(a)||(a={});for(var b=dvStruct.viewer.winArr,c=0,d=b.length;c<d;c++)a.callback&&a.callback(b[c])},getWrapperById:function(a){for(var b,c=dvStruct.viewer.winArr,d=0,e=c.length;d<e;d++)for(var f=c[d],g=0,h=f.wrappers.length;g<h;g++){var i=f.wrappers[g];i.eid==a&&(b=i)}return i}},dvStruct.viewer.findOriInfoByIds=function(a){var b=a.split(":");if("wadouri"==b[0]||"byteArray"==b[0])return dvStruct.findOriInfoOnlyByOriId(a);var c=b[1],d=b[2],e=_.find(dvStruct.viewer.winArr,function(a){return a.winId==c}),f=_.find(e.imgObjArr,function(b){return b.imageId==a});if(_.isObject(f)){var g=f.bindOriImageId;return dvStruct.findOriInfoByIds(g,d)}},dvStruct.viewer.findWin=function(a){var b=_.find(dvStruct.viewer.winArr,function(b){return b.winId==a});return b},dvStruct.viewer.bindSeries=function(a,b,c,d){$("#"+a.winId).attr("seriesLength",c),$("#"+a.winId).attr("seriesId",b),a.seriesId=b;var e=dvStruct.findSeries(b);if(e){var f=e.dicomArr,g=[];a.imgObjArr=[];for(var h=0,i=f.length;h<i;h++)d?($("#"+a.winId).attr("seriesLength",1),f[h].imageId==d&&(a.imgObjArr.push(f[h]),g.push(f[h].imageId))):(a.imgObjArr.push(f[h]),g.push(f[h].imageId));for(var j=g.length,h=0,i=dvStruct.viewer.maxInnerCol*dvStruct.viewer.maxInnerRow;h<i;h++){var k=a.wrappers[h];dvStruct.fun.removeSync(a,k.element)}for(var h=0,i=dvStruct.viewer.maxInnerCol*dvStruct.viewer.maxInnerRow;h<i;h++){var k=a.wrappers[h];if(a.wrappers[h].seriesId=b,k.seriesId=b,k.suid=b,k.stack.imageIds=[],h<a.col*a.row){var l=cornerstone.getEnabledElement(k.element);if(h<j&&(k.stack.currentImageIdIndex=h),h<j)k.stack.imageIds=g,dvStruct.viewer.emptyInfo(k),l.viewport=void 0,reDrawWrapper(k),dvStruct.viewer.fillInfo(k);else{k.stack.imageIds=[];var m=cornerstone.getImage(k.element);if(_.isObject(m)){cornerstoneTools.mouseInput.disable(k.element),dvStruct.fun.disableTools(k.element);var n=l.canvas.getContext("2d");n.setTransform(1,0,0,1,0,0),n.fillStyle="black",n.fillRect(0,0,l.canvas.width,l.canvas.height),l.data={},l.image=void 0}dvStruct.viewer.emptyInfo(k)}}}btnShowCheck()}},dvStruct.viewer.resizeWin=function(a){var b=a.wrappers[0],c=(cornerstone.getEnabledElement(b.element),b.stack.currentImageIdIndex),d=b.stack.imageIds.length;if(d>0)for(var e=1,f=a.col*a.row;e<f;e++){var g=a.wrappers[e],h=cornerstone.getEnabledElement(g.element);if(e<d){g.stack.imageIds=b.stack.imageIds;var i=c+e>d-1?c+e-d:c+e;g.stack.currentImageIdIndex=i,reDrawWrapper(g),
dvStruct.viewer.fillInfo(g)}else{var j=h.canvas.getContext("2d");j.setTransform(1,0,0,1,0,0),j.fillStyle="black",j.fillRect(0,0,h.canvas.width,h.canvas.height)}}},dvStruct.viewer.emptyInfo=function(a){var b=$(a.element).parent();$(b).find(".js-info").text("")},dvStruct.viewer.fillInfo=function(a){var b=a.stack.imageIds[a.stack.currentImageIdIndex],c=a.seriesId,d=dvStruct.viewer.findOriInfoByIds(b,c);if(!_.isUndefined(d)){var e=dvStruct.countSNo(c),f=$(a.element).parent();try{$(f).find(".js-sign").find("input").show(),$(f).find(".js-sign").find("input").prop("checked",d.isSign),$(f).find(".js-sign").find("input").val("标记"),$(f).find(".js-sign").find("input").attr("signId",d.signId),$(f).find(".js-sign").find("input").attr("imageId",b),$(f).find(".js-sign").find("input").attr("seriesId",c);var g=d.StudyInfo.StudyDate.val.toString(),h=d.StudyInfo.StudyTime.val.toString();if(g&&h){var i=h;h.indexOf(":")==-1&&(i=h.substr(0,2)+":"+h.substr(2,2)+":"+h.substr(2,2)),$(f).find(".js-info-Datetime").text(g.substr(0,4)+"/"+g.substr(4,2)+"/"+g.substr(6,2)+" "+i)}var j=d.SomeUsefulInfo.ww.val.split("\\"),k=d.SomeUsefulInfo.wc.val.split("\\");$(f).attr("ww",j[0]),$(f).attr("wc",k[0]),$(f).attr("intercept",d.ImageInfo.RescaleIntercept.val),$(f).attr("slope",d.ImageInfo.RescaleSlope.val);var l=g.substr(0,4)+"/"+g.substr(4,2)+"/"+g.substr(6,2);$(f).attr("studyDate",l),$(f).attr("studyTime",h);var m=d.SeriesInfo.Modality.val;if($(f).attr("modality",m),$(f).find(".js-info-Modality").text(m),$(f).attr("patientName",d.PatientInfo.PatientName.val),d.SeriesInfo.Modality.val&&$(f).find(".js-info-Modality").text(d.SeriesInfo.Modality.val),$(f).find(".js-info-nowNo").text("Im:"+(a.stack.currentImageIdIndex+1)),$(f).find(".js-info-totalNo").text("/"+a.stack.imageIds.length),$(f).find(".js-info-SeNo").text("Se: "+e),$(f).find(".js-info-SeNo").attr("data-seriesId",c),dvStruct.share||$(f).find(".js-info-PatientName").text(d.PatientInfo.PatientName.val),$(f).find(".js-info-PatientID").text(d.PatientInfo.PatientID.val),d.PatientInfo.PatientSex.val&&($(f).attr("sex",d.PatientInfo.PatientSex.val),$(f).find(".js-info-PatientSex").text("性别:"+d.PatientInfo.PatientSex.val)),d.PatientInfo.PatientsAge.val&&($(f).attr("sex",d.PatientInfo.PatientsAge.val),$(f).find(".js-info-PatientAge").text("年龄:"+d.PatientInfo.PatientsAge.val)),n){var n=d.PatientInfo.PatientBirthDate.val;$(f).find(".js-info-PatientBirthDate").text(n.substr(0,4)+"/"+n.substr(4,2)+"/"+n.substr(6,2))}dvStruct.share||$(f).find(".js-info-InstitutionName").text(d.EquipmentInfo.InstitutionName.val),$(f).find(".js-info-SeriesDescription").text(d.SeriesInfo.SeriesDescription.val),$(f).find(".js-info-StudyDescription").text(d.StudyInfo.StudyDescription.val),$(f).find(".js-info-BodyPartExamined").text(d.StudyInfo.BodyPartExamined.val),d.SomeUsefulInfo.mA.val&&$(f).find(".js-info-mA").text(d.SomeUsefulInfo.mA.val+"mA"),d.SomeUsefulInfo.kvp.val&&$(f).find(".js-info-kvp").text(d.SomeUsefulInfo.kvp.val+"kV"),d.ImageInfo.FieldofView.val&&$(f).find(".js-info-fov").text("FOV:"+parseFloat(d.ImageInfo.FieldofView.val).toFixed(1)),d.SomeUsefulInfo.MagneticFieldStrength.val&&$(f).find(".js-info-MagneticFieldStrength").text("FS: "+d.SomeUsefulInfo.MagneticFieldStrength.val),(d.SomeUsefulInfo.RepetitionTime.val||d.SomeUsefulInfo.RepetitionTime.val)&&$(a).find(".js-info-TrTe").text("TR: "+d.SomeUsefulInfo.RepetitionTime.val+" TE: "+d.SomeUsefulInfo.EchoTime.val)}catch(o){console.error(o)}}},dvStruct.viewer.removeBindSeries=function(a,b){b=a.studyNo,a.imgObjArr=[];for(var c=0,d=dvStruct.viewer.studySet[b].maxInnerCol*dvStruct.viewer.studySet[b].maxInnerRow;c<d;c++){var e=a.wrappers[c];dvStruct.fun.removeSync(a,e.element)}for(var c=0,d=dvStruct.viewer.studySet[b].maxInnerCol*dvStruct.viewer.studySet[b].maxInnerRow;c<d;c++){var e=a.wrappers[c];if(e.suid=void 0,e.seriesId=void 0,e.stack.imageIds=[],c<a.col*a.row){var f=cornerstone.getEnabledElement(e.element);e.stack.imageIds=[];var g=cornerstone.getImage(e.element);if(_.isObject(g)){cornerstoneTools.mouseInput.disable(e.element);var h=f.canvas.getContext("2d");h.setTransform(1,0,0,1,0,0),h.fillStyle="black",h.fillRect(0,0,f.canvas.width,f.canvas.height),f.data={},f.image=void 0}}}},!dvStruct)var dvStruct={};dvStruct.container=void 0,dvStruct.imgObjArr=[],dvStruct.seriesArr=[],dvStruct.getSuid=function(a){var b={imgId:a,seriesId:0,seriesLength:0,se:0,imgIndex:0};return $.each(dvStruct.seriesArr,function(c){var d=!1;$.each(dvStruct.seriesArr[c].dicomArr,function(e){dvStruct.seriesArr[c].dicomArr[e].imageId===a&&(b.seriesId=dvStruct.seriesArr[c].seriesId,b.se=dvStruct.countSNo(dvStruct.seriesArr[c].seriesId),b.seriesLength=dvStruct.seriesArr[c].dicomArr.length,b.imgIndex=e+1,d=!0)})}),b},dvStruct.addSeries=function(a,b){var c={seriesId:b.seriesId,seriesNo:b.seriesNo,dicomArr:[],sideImageIds:[],studyId:b.studyId,studyDateTime:b.studyDateTime},d=parseFloat(a.infoSet.SeriesInfo.SliceLocation.val);return"dicom"==b.imageType&&c.sideImageIds.push({farsideImageId:a.imageId,nearsideImageId:a.imageId,farLoc:d,nearLoc:d}),c.offset=void 0,dvStruct.seriesArr.push(c),c.dicomArr.push(a),commEventHandler.fireEvent({type:"dicomSeriesAdded",seriesId:b.seriesId,seriesNo:c.seriesNo,dicomCoverted:a,studyId:c.studyId,studyDateTime:b.studyDateTime,signId:b.signId,imageType:b.imageType,url:b.url,totalCount:b.totalCount}),c},dvStruct.dicomInsert=function(a,b){if(0==a.dicomArr.length)return a.dicomArr.push(b),void commEventHandler.fireEvent({type:"dicomAddedPush",series:a,dicomCoverted:b});for(var c=0,d=a.dicomArr.length;c<d;c++)if(parseInt(b.instanceNo)<parseInt(a.dicomArr[c].instanceNo))return a.dicomArr.splice(c,0,b),void commEventHandler.fireEvent({type:"dicomAddedSplice",series:a,dicomCoverted:b,i:c});a.dicomArr.push(b),commEventHandler.fireEvent({type:"dicomAddedPush",series:a,dicomCoverted:b})},dvStruct.addDicom=function(a,b){var c=b.seriesId,d=dvStruct.findSeries(c);if(d)dvStruct.dicomInsert(d,a);else if($("#tagViewport").attr("data-imageId","wadouri:"+b.imageId),d=dvStruct.addSeries(a,b),1==b.detail.urlMode){if(dvStruct.seriesArr.length>1){var e=layoutMatch(dvStruct.seriesArr.length,dvStruct.viewer.maxRow,dvStruct.viewer.maxCol);dvStruct.viewer.col=e.col,dvStruct.viewer.row=e.row,reLayoutSeriesWin(e),btnShowCheck()}dvStruct.viewer.bindSeries(dvStruct.viewer.winArr[dvStruct.seriesArr.length-1],b.seriesId,dvStruct.seriesArr.length)}commEventHandler.fireEvent({imageType:a.imageType,type:"dicomAdded",seriesId:c,dicomCoverted:a,series:d,url:b.url,signId:b.signId,instanceNo:a.instanceNo,index:b.index,studyId:b.studyId})},dvStruct.findSeries=function(a){return _.find(dvStruct.seriesArr,function(b){return b.seriesId==a})},dvStruct.findImgObj=function(a){return _.find(dvStruct.imgObjArr,function(b){return b.imageId==a})},dvStruct.findSeriesByElement=function(a){var b=$(a).parents(".seriesWindow:first").attr("id"),c=_.find(dvStruct.viewer.winArr,function(a){return a.winId==b});if(!_.isUndefined(c)){var d=c.wrappers[0].suid,e=dvStruct.findSeries(d);return e}},dvStruct.countSNo=function(a){var b=0;_.find(dvStruct.seriesArr,function(c){return b++,c.seriesId==a});return b},dvStruct.findOriInfoByIds=function(a,b){var c=dvStruct.findSeries(b);if(!_.isUndefined(c)){var d=c.dicomArr,e=_.find(d,function(b){return b.imageId==a});if(!_.isUndefined(e))return e.infoSet}},dvStruct.findOriInfoOnlyByOriId=function(a){for(var b=0,c=dvStruct.seriesArr.length;b<c;b++){var d=dvStruct.seriesArr[b];if(!_.isUndefined(d)){var e=d.dicomArr,f=_.find(e,function(b){return b.imageId==a});if(!_.isUndefined(f))return f.infoSet}}},dvStruct.waitingBind=[],dvStruct.addWaitingBind=function(a,b,c){dvStruct.waitingBind.push({seriesId:a,win:b,seriesLength:c})};var checkAndBind=function(a,b){for(var c=0,d=dvStruct.waitingBind.length;c<d;c++)if(dvStruct.waitingBind[c].seriesId==a){dvStruct.waitingBind[c].win.wrappers[0].seriesId||dvStruct.viewer.bindSeries(dvStruct.waitingBind[c].win,a,dvStruct.waitingBind[c].seriesLength),dvStruct.waitingBind.splice(c,1);break}},renderer=new cornerstoneTools.stackRenderers.FusionRenderer;renderer.findImageFn=function(a,b){var c,d=1,e=cornerstone.metaData.get("imagePlaneModule",b),f=e.imagePositionPatient[2];return a.forEach(function(a){var b=cornerstone.metaData.get("imagePlaneModule",a),e=b.imagePositionPatient[2],g=Math.abs(e-f);g<d&&(d=g,c=a)}),c},cornerstoneTools.overlayTool.setConfiguration({color:eSetting.tool.overlay.color,lineWidth:1,shadowColor:"black",shadowBlur:4}),commEventHandler.addEventListener("dicomAdded",function(a){var b=a.seriesId,c=a.dicomCoverted.imageId;if(dvStruct.showAll){var d="",e=$("div[data-seriesId='"+b+"']").find(".instance-scan")[0],f=parseInt($(e).attr("instanceNo")),g=a.instanceNo;if(parseInt(g)<parseInt(f))if("jpg"!=a.imageType){d=$(e).find(".img").attr("id"),$(e).attr("data-studyId",a.studyId),$(e).attr("imageidPreview",c),$(e).attr("instanceNo",g),$(e).attr("signId",a.signId),$(e).find(".img").attr("instanceNo",g),$(e).find(".img").attr("imageId",c);var h=$(dvStruct.container).find("#"+d).get(0);cornerstone.disable(h),cornerstone.enable(h),cornerstone.loadImage(c).then(function(a){cornerstone.displayImage(h,a)})}else{var i=document.createElement("img");i.src=c,console.log("添加一张jpg缩略图")}}var j=a.series.dicomArr.length;$(".series-scan[data-seriesId='"+b+"']").parents(".series-scan-box").find(".load-count").text(j);var k=$(".series-scan[data-seriesId='"+b+"']").parents(".series-scan-box").find(".total").text();if(j>parseInt(k)&&$(".series-scan[data-seriesId='"+b+"']").parents(".series-scan-box").find(".total").text(j),"dicom"==a.imageType){var l=cornerstoneTools.referenceLines.getImgPlan(a.dicomCoverted.imageId),m=null,n=null,o=!1,p=a.dicomCoverted.infoSet.SeriesInfo,q=parseFloat(p.SliceLocation.val);if(l&&void 0!=l.rowCosines)try{m=l.imagePositionPatient,n=l.rowCosines.clone().cross(l.columnCosines);for(var r=0,s=a.series.sideImageIds.length;r<s;r++){var t=a.series.sideImageIds[r],u=cornerstoneTools.referenceLines.getImgPlan(t.farsideImageId),v=cornerstoneTools.referenceLines.getImgPlan(t.nearsideImageId),w=u.rowCosines.clone().cross(u.columnCosines),x=n.angleTo(w);if(x=Math.abs(x),x<.1&&null!=m){if(o=!0,NaN!=q)q>t.farLoc&&(t.farLoc=q,t.farsideImageId=a.dicomCoverted.imageId),q<t.nearLoc&&(t.nearLoc=q,t.nearsideImageId=a.dicomCoverted.imageId);else{var y=u.imagePositionPatient,z=dvStruct.vo.farsideCal(y,m);if(dvStruct.vo.notSame(y,z))t.farsideImageId=a.dicomCoverted.imageId;else{var A=v.imagePositionPatient;dvStruct.vo.calDistanceSquared([A,z])<dvStruct.vo.calDistanceSquared([m,z])&&(t.nearsideImageId=a.dicomCoverted.imageId)}}break}}}catch(B){console.log("定位线异常")}o||a.series.sideImageIds.push({farsideImageId:a.dicomCoverted.imageId,nearsideImageId:a.dicomCoverted.imageId,farLoc:q,nearLoc:q})}}),commEventHandler.addEventListener("dicomAddedPush",function(a){dvStruct.showHander;for(var b=0,c=dvStruct.viewer.col*dvStruct.viewer.row;b<c;b++){var d=dvStruct.viewer.winArr[b];if(d.wrappers[0].seriesId==a.series.seriesId){d.imgObjArr.push(a);var e=d.wrappers[0];if(e.stack.imageIds.length>0){e.stack.imageIds.push(a.dicomCoverted.imageId);var f=e.stack.imageIds.length;if(f>1&&f<=d.col*d.row){var g=d.wrappers[f-1],h=d.wrappers[f-2],i=cornerstone.getEnabledElement(g.element);g.stack.imageIds=e.stack.imageIds,g.stack.currentImageIdIndex=h.stack.currentImageIdIndex+1>=f?0:h.stack.currentImageIdIndex+1,dvStruct.viewer.emptyInfo(g),i.viewport=void 0,reDrawWrapper(g),dvStruct.fun.elementIni(g.element,d),dvStruct.fun.checkAndSetActive(g.element),dvStruct.viewer.fillInfo(g)}updateTotalImgNo(d)}break}}}),commEventHandler.addEventListener("dicomAddedSplice",function(a){if(dvStruct.showHander){a.dicomCoverted.dataSet}for(var b=a.i,c=0,d=dvStruct.viewer.col*dvStruct.viewer.row;c<d;c++){var e=dvStruct.viewer.winArr[c];if(e.wrappers[0].seriesId==a.series.seriesId){var f=a.dicomCoverted.imageId,g=dvStruct.findImgObj(a.dicomCoverted.imageId);g.bindOriImageId=f,e.imgObjArr.splice(c,0,g);var h=e.wrappers[0];if(h.stack.imageIds.length>0){h.stack.imageIds.splice(b,0,g.imageId);var i=h.stack.imageIds.length;if(i>1&&i<=e.col*e.row)for(var j=0;j<i;j++){var k=e.wrappers[j],l=cornerstone.getEnabledElement(k.element);if(j==i-1){var m=e.wrappers[i-2];k.stack.imageIds=h.stack.imageIds,k.stack.currentImageIdIndex=m.stack.currentImageIdIndex+1>=i?0:m.stack.currentImageIdIndex+1,dvStruct.viewer.emptyInfo(k),l.viewport=void 0,reDrawWrapper(k),dvStruct.fun.elementIni(k.element,e),dvStruct.fun.checkAndSetActive(k.element),dvStruct.viewer.fillInfo(k)}else k.stack.currentImageIdIndex>=b&&reDrawWrapper(k)}else if(i>=e.col*e.row)for(var j=0;j<e.col*e.row;j++){var k=e.wrappers[j];k.stack.currentImageIdIndex>=b&&reDrawWrapper(k)}updateTotalImgNo(e)}}}}),commEventHandler.addEventListener("dicomSeriesAdded",function(a){var b=a.studyId,c=guid(8,"gallery"),d=a.dicomCoverted.imageId,e=a.studyDateTime,f=a.seriesId,g=a.dicomCoverted.instanceNo,h=e.split(" ")[0],i=e.split(" ")[1],j=a.dicomCoverted.infoSet.StudyInfo.StudyDescription.val,k=a.dicomCoverted.infoSet.SeriesInfo.SeriesDescription.val,l=a.totalCount,m="JPG图像组",n="JPG图像组";if("jpg"!=a.imageType&&(m=a.dicomCoverted.infoSet.PatientInfo.PatientName.val,g=a.dicomCoverted.infoSet.InstanceInfo.InstanceNumber.val,n=m,h=a.dicomCoverted.infoSet.StudyInfo.StudyDate.val.toString(),i=a.dicomCoverted.infoSet.StudyInfo.StudyTime.val.toString(),h&&i&&(h=h.substr(0,4)+"/"+h.substr(4,2)+"/"+h.substr(6,2),i.indexOf(":")==-1&&(i=i.substr(0,2)+":"+i.substr(2,2)+":"+i.substr(2,2)))),$(".patient-scan[data-studyId='"+b+"']").length<1&&$(dvStruct.container).find(".thumbnail-box").append(template("studyPreviewTemp",{studyId:b,shortName:n,studyDate:h,studyTime:i,patientName:m})),$(".patient-scan[data-studyId='"+b+"']").find(".study-time[data-studyDateTime='"+e+"']").length<1&&$(".patient-scan[data-studyId='"+b+"']").append(template("studyDateTimeTemp",{studyId:b,studyDate:e,studyDateTime:h+" "+i,studyDescribe:j})),$(".patient-scan[data-studyId='"+b+"']").find(".study-time[data-studyDateTime='"+e+"']").find(".series-scan-box").each(function(){var c=parseInt($(this).attr("data-seriesNo"));if(c>parseInt(a.seriesNo))return $(this).before(template("seriesPreviewTemp",{studyId:b,seriesId:f,seriesNo:a.seriesNo,studyDate:h,studyTime:i,seriesDes:k,total:l})),!1}),$(".series-scan[data-seriesId='"+f+"']").length<1&&$(".patient-scan[data-studyId='"+b+"']").find(".study-time[data-studyDateTime='"+e+"']").append(template("seriesPreviewTemp",{studyId:b,seriesId:f,seriesNo:a.seriesNo,studyDate:h,studyTime:i,seriesDes:k,total:l})),"jpg"==a.imageType&&($(".series-scan[data-seriesId='"+f+"']").parent().find(".series-title").addClass("jpg-series-title"),$(".series-scan[data-seriesId='"+f+"']").parent().find(".series-download").addClass("forbid-download"),$(".series-scan[data-seriesId='"+f+"']").parent().find(".series-download").attr("title","jpg图像不支持批量下载")),$(".series-scan[data-seriesId='"+f+"']").append(template("instancePreviewTemp",{studyId:b,id:c,seriesId:f,seriesNo:a.seriesNo,imageId:d,instanceNo:g,signId:a.signId})),"jpg"!=a.imageType){var o=$(dvStruct.container).find("#"+c).get(0);cornerstone.disable(o),cornerstone.enable(o),cornerstoneTools.mouseWheelInput.disable(o),$(o).off("mousewheel DOMMouseScroll"),cornerstone.loadImage(d).then(function(a){cornerstone.displayImage(o,a)}),checkAndBind(f,0)}else{var p=document.createElement("img");p.src=a.url,$(dvStruct.container).find("#"+c).append(p)}});var io=io||{};io.process=0,io.total=0,io.Url={load:function(a,b){var c=io.Url.xhrRequest(a,b);return c},xhrRequest:function(a,b){var c=$.Deferred(),d=new XMLHttpRequest;return d.open("get",a,!0),d.responseType="arraybuffer",d.onreadystatechange=function(b){if(4===d.readyState)if(200===d.status){var e=d.response,f=a.split("/"),g=f[f.length-1],h={};commEventHandler.fireEvent({type:"dicomDownloaded",name:g,data:e,infoAfterAnalysised:h});var i=new JSZip,j=i.loadAsync(e);j.then(function(b){for(var c in b.files){var d=b.files[c];d.dir||dealUrlFile(a,b,d,h)}})["catch"](function(b){var e={studyId:com.studyId(!1),studyDateTime:new Date,seriesNo:0,seriesId:new Date,url:a,imageType:"dicom",signId:0,isSign:!1,instanceNo:0,index:0,imageId:a,totalCount:1,detail:{urlMode:!0}};loadingProcess(e).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&loadTips(a)}),c.reject(d.response)})}else"Forbidden"==d.statusText,unit.loadingProcessing.updateProcessing(url),c.reject(d.response)},d.onprogress=function(a){if(a.lengthComputable){var b=a.loaded,c=a.total;Math.round(b/c*100)}},d.send(),c.promise()}};try{io.File={zipReader:new FileReader,dcmReader:new FileReader,load:function(a){try{for(var b=0,c=a.length;b<c;b++){var d=a[b],e=d.name.lastIndexOf("."),f=d.name.substring(e,d.name.length);".zip"!=f.toLowerCase()?io.File.dcmReader.readAsArrayBuffer(d):io.File.zipReader.readAsArrayBuffer(d)}}catch(g){console.error(g),alert("加载异常")}},checkType:function(){},zipReaderOnload:function(a){var b=new JSZip,c=b.loadAsync(a.target.result);c.then(function(a){for(var b in a.files){var c=a.files[b];c.dir||io.File.zipReader.dealFile(c,a)}})}},io.File.zipReader.onload=io.File.zipReaderOnload,io.File.zipReader.dealFile=function(a,b){var c=a.name,d=c.lastIndexOf("."),e=c.substring(d,c.length);if(".zip"!=e.toLowerCase())try{var f=function(a){},g=b.file(a.name).async("uint8array");g.then(function(a){var b=dicomLocalCoverUint8(a,f);b&&dvStruct.addDicom(b,{})})}catch(h){console.error(h)}else{var g=b.file(a.name).async("blob");g.then(function(a){var b=new FileReader;b.onload=io.File.zipReaderOnload,b.readAsArrayBuffer(a)})}},io.File.dcmReader.onload=function(a){var b=function(a){},c=dicomLocalCovert(a.target.result,b);c&&dvStruct.addDicom(c,{})}}catch(e){console.error(e)}var dvStruct=dvStruct||{};dvStruct.viewer||(dvStruct.viewer={col:1,row:1,maxCol:4,maxRow:4,eachW:0,eachH:0,maxInnerCol:2,maxInnerRow:2});var unit={};if(unit.mask={getMask:function(){var a;return function(){return a||function(){return $(document.body).append('<div id="unitMask"></div>'),a=document.getElementById("unitMask")}()}}(),show:function(){var a=this.getMask();$(a).show()},hide:function(){var a=this.getMask();$(a).hide()}},unit.layoutSelector=layoutSelectorBuilder(dvStruct.viewer.maxRow,dvStruct.viewer.maxCol,"unitLayoutSelector"),unit.layoutSelector.callback=function(a){dvStruct.viewer.col=a.col,dvStruct.viewer.row=a.row,reLayoutSeriesWin(),btnShowCheck()},unit.innerLayoutSelector=layoutSelectorBuilder(dvStruct.viewer.maxInnerRow,dvStruct.viewer.maxInnerCol,"unitInnerLayoutSelector"),unit.innerLayoutSelector.callback=function(a){var b=dvStruct.viewer.getCheckedWin();if(_.isObject(b)){b.col=a.col,b.row=a.row;var c=dvStruct.viewer.calInnerEachSize(b.winId);dvStruct.viewer.resizeWin(b),$("#"+b.winId).find(".viewWrapper").css({height:100*c[1]+"%",width:100*c[0]+"%"}).each(function(){cornerstone.resize($(this).find(".viewport").get(0),!0)})}},unit.quickWWWL={ceils:[{ww:90,wc:35,name:"头颅平扫"},{ww:85,wc:40,name:"头颅增强"},{ww:1600,wc:450,name:"头颅骨窗"},{ww:1600,wc:550,name:"关节骨窗"},{ww:300,wc:40,name:"关节软组织窗"},{ww:2e3,wc:450,name:"鼻窦骨窗"},{ww:350,wc:35,name:"鼻窦软组织窗"},{ww:4e3,wc:650,name:"乳突"},{ww:2e3,wc:450,name:"椎间盘骨窗"},{ww:350,wc:40,name:"椎间盘软组织窗"},{ww:1e3,wc:-650,name:"肺窗"},{ww:1500,wc:-600,name:"肺窗2"},{ww:350,wc:-40,name:"纵隔窗1"},{ww:430,wc:55,name:"纵隔窗2"},{ww:200,wc:50,name:"肝脏"},{ww:350,wc:40,name:"肾脏"},{ww:300,wc:55,name:"肾脏"}],savedStatus:{beginOfsX:0,beginOfsY:0,prevPageX:void 0,prevPageY:void 0},wwwlBoxIni:function(a){$(a).find(".closeBtn").on("mousedown",function(a){unit.quickWWWL.hide(),a.stopPropagation()}),$(a).find(".topbar").on("mousedown",function(){$(document.body).on("mousemove",function(b){var c=b.pageX,d=b.pageY,e=unit.quickWWWL.savedStatus;if(!_.isUndefined(e.prevPageX)&&!_.isUndefined(e.prevPageY)){var f=e.beginOfsX+c-e.prevPageX,g=e.beginOfsY+d-e.prevPageY;$(a).css({top:g+"px",left:f+"px",right:"auto",bottom:"auto"}),e.beginOfsX=f,e.beginOfsY=g}e.prevPageX=c,e.prevPageY=d}),$(document.body).on("mouseup mouseleave",function(a){$(document.body).off("mousedown"),$(document.body).off("mousemove");var b=unit.quickWWWL.savedStatus;b.prevPageX=void 0,b.prevPageY=void 0})}),$(a).find(".ceilBox").click(function(b){var c=b.target;if($(c).hasClass("aCeil")){var d=parseInt($(c).attr("ww")),e=parseInt($(c).attr("wc"));$(a).find(".wwVal").val(d),$(a).find(".wcVal").val(e)}b.stopPropagation()}),$(a).find(".yes").click(function(){var b=parseInt($(a).find(".wwVal").val()),c=parseInt($(a).find(".wcVal").val());isNaN(b)||isNaN(c)||dvStruct.fun.wwwc(b,c)})},getWWWLBox:function(){var a;return function(){return a||function(){var b='<div id="quickWWWLBox">';b+='<div class="topbar"  style=" -webkit-user-select: none; -webkit-user-drag: none;touch-action: none;" ><div class="closeBtn">✖</div></div>',b+='<div class="calBox"  style=" -webkit-user-select: none; -webkit-user-drag: none;touch-action: none;">',b+='<div class="inputArea">窗位:&ensp;<input class="wcVal"></div>',b+='<div class="inputArea">窗宽:&ensp;<input class="wwVal"></div>',b+='<div class="yes">确定</div>',b+="</div>",b+='<div class="ceilBox"></div>',b+="</div>",$(dvStruct.container).append(b),a=document.getElementById("quickWWWLBox");for(var c=0,d=unit.quickWWWL.ceils.length;c<d;c++){var e=unit.quickWWWL.ceils[c];$(a).find(".ceilBox").append('<div class="aCeil" ww="'+e.ww+'" wc="'+e.wc+'" >'+e.name+"</div>")}return unit.quickWWWL.wwwlBoxIni(a),a}()}}(),show:function(){unit.mask.show();var a=unit.quickWWWL.getWWWLBox();$(a).css({top:0,left:0,right:0,bottom:0}),$(a).show();var b=unit.quickWWWL.savedStatus,c=$(a).offset();b.beginOfsX=c.left,b.beginOfsY=c.top,b.prevPageX=void 0,b.prevPageY=void 0},hide:function(){unit.mask.hide();var a=unit.quickWWWL.getWWWLBox();$(a).hide()}},unit.loadingProcessing={failedUrls:[],getProcessiong:function(){var a;return function(){return a||function(){var b='<div id="processingBox" style="display: none"  class="processingBox">';return b+='<div class="js-hide hidebtn" style="display: none"><span>✖</span></div>',b+='<div class="failed" style="display: none">失败：<span class="failedNum"></span>&ensp;<span class="tryAgain">重试</span></div>',b+='<div class="loadingTxt" >正在加载:<span class="now">0</span>/<span class="max"></span></div>',b+='<div class="processing">',b+='<div class="progress progress-striped active"><div class="progress-bar "  role="progressbar" style="width:0"></div></div>',b+="</div>",b+="</div>",$(".leftGallery").append(b),a=document.getElementById("processingBox"),$(a).find(".tryAgain").click(function(){var b=unit.loadingProcessing.failedUrls.length,c=unit.loadingProcessing.failedUrls.concat();unit.loadingProcessing.failedUrls=[],unit.loadingProcessing.finished=0,$(a).find(".js-hide").hide(),$(a).find(".loadingTxt").show(),$(a).find(".failed").hide(),unit.loadingProcessing.init(b);for(var d=0;d<b;d++)io.Url.load(c[d])}),$(a).find(".js-hide").click(function(){$(a).hide()}),a}()}}(),maxNum:0,finished:0,clear:function(){this.maxNum=0,this.finished=0,this.success=0;var a=this.getProcessiong();$(a).hide()},updateProcessing:function(a){if(a)this.failedUrls.push(a);else{this.finished++;var b=parseInt(this.finished/this.maxNum*100),c=this.getProcessiong();$(c).find(".now").text(this.finished),$(c).find(".progress-bar").css("width",b+"%")}this.finished+this.failedUrls.length==this.maxNum&&this.end()},end:function(){var a=this.getProcessiong();this.failed>0?($(a).find(".js-hide").show(),$(a).find(".loadingTxt").hide(),$(a).find(".failed").show().find(".failedNum").text(this.failedUrls.length)):($(a).hide(),setTimeout(function(){if(void 0!=dvStruct.userCode&&null!=dvStruct.userCode&&dvStruct.userCode.length>0&&(getModality(),"none"!=Modality&&(wwwlShow(Modality,dvStruct.userCode),$(".device").val(Modality),typeChange(dvStruct.userCode))),void 0!=dvStruct.hospitalCode&&null!=dvStruct.hospitalCode&&dvStruct.hospitalCode.length>0){var a=dvStruct.hospitalCode;showPrintInfo(a),initinfoScreenArr(a)}void 0!=dvStruct.hospitalCode&&null!=dvStruct.hospitalCode,btnShowCheck()},100))},init:function(a){if(this.maxNum=parseInt(a),this.maxNum>0){var b=this.getProcessiong();$(b).find(".progress-bar").width(0),$(b).find(".max").text(this.maxNum),$(b).show()}}},unit.speedSlider={ini:function(){var a=this.getSliderBox(),b=$(a).find(".rangeBar").get(0);noUiSlider.create(b,{start:[10],snap:!0,range:{min:1,"15%":2,"25%":4,"35%":8,"50%":10,"65%":20,"75%":25,"85%":50,max:100}}),b.noUiSlider.on("update",function(a,b){dvStruct.isplaying&&(dvStruct.playSpeed=parseInt(a[b]),dvStruct.fun.stop(),dvStruct.fun.play())})},getSliderBox:function(){return document.getElementById("playSpeedSet")},show:function(){$(unit.mask.getMask()).on("click",function(a){unit.speedSlider.hide(),a.preventDefault()});var a=this.getSliderBox();unit.mask.show(),$(a).show()},hide:function(){$(this.getSliderBox()).hide(),unit.mask.hide(),$(unit.mask.getMask()).off("click")}},!dvStruct)var dvStruct={};dvStruct.showAll=!0,dvStruct.frameRate=3,dvStruct.showHander=!0,dvStruct.engineId="engine",dvStruct.share=!1,dvStruct.dblclickFlag={clickState:!1,winNo:dvStruct.viewer.maxCol*dvStruct.viewer.maxRow,winNoMax:dvStruct.viewer.maxCol*dvStruct.viewer.maxRow},dvStruct.aiResult={series:[]},dvStruct.dragOpt={mpr:{seriesId:"",show:!1},viewer:{show:!0},print:{show:!1,join:{show:!1}},fusion:{show:!0,data:{ctSrc:[],petSrc:[],synchronizer:new cornerstoneTools.Synchronizer("cornerstonenewimage",cornerstoneTools.stackImageIndexSynchronizer)}}};var magnifyConfig=cornerstoneTools.magnify.getConfiguration();if(magnifyConfig.magnificationLevel=3,magnifyConfig.magnifySize=500,function(a,b,c){function d(){e=b[h](function(){f.each(function(){var b=a(this),c=b.width(),d=b.height(),e=a.data(this,j);c===e.w&&d===e.h||b.trigger(i,[e.w=c,e.h=d])}),d()},g[k])}var e,f=a([]),g=a.resize=a.extend(a.resize,{}),h="setTimeout",i="resize",j=i+"-special-event",k="delay",l="throttleWindow";g[k]=250,g[l]=!0,a.event.special[i]={setup:function(){if(!g[l]&&this[h])return!1;var b=a(this);f=f.add(b),a.data(this,j,{w:b.width(),h:b.height()}),1===f.length&&d()},teardown:function(){if(!g[l]&&this[h])return!1;var b=a(this);f=f.not(b),b.removeData(j),f.length||clearTimeout(e)},add:function(b){function d(b,d,f){var g=a(this),h=a.data(this,j);h.w=d!==c?d:g.width(),h.h=f!==c?f:g.height(),e.apply(this,arguments)}if(!g[l]&&this[h])return!1;var e;return a.isFunction(b)?(e=b,d):(e=b.handler,void(b.handler=d))}}}(jQuery,this),function(a){function b(b){var c=a(".dvContainer").height(),d=(a(".js-imageViewer").width(),a(".js-topPannel").height());a(".js-imageViewer").height(c-d),a(".js-imageViewer").width(b-dvStruct.viewer.col);var e,f,g=a(".js-imageViewer").height(),h=a(".js-imageViewer").width();e=parseInt(h/dvStruct.viewer.col),f=parseInt(g/dvStruct.viewer.row),a("[class='seriesWindow']").show(),a(".seriesWindow").css({height:f+"px",width:e+"px"}),dvStruct.viewer.eachW=e,dvStruct.viewer.eachH=f,1==dvStruct.viewer.row&&1==dvStruct.viewer.col&&a(".seriesWindow:first").click(),a(".seriesWindow").each(function(){var b=a(this).attr("id"),c=dvStruct.viewer.calInnerEachSize(b);a(this).find(".viewportWrapper").css({height:c[1]+"px",width:c[0]+"px"})}),dvStruct.viewer.eachElement({callback:function(a){cornerstone.resize(a,!0)}})}var c={viewer:dvStruct.viewer};a.fn.extend({engine:function(d){function e(){dvStruct.viewer.saveDiyStat("js-default",1),setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)}),a(".imgTool").each(function(){a(this).find(".btn").removeClass("btnActive")}),a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive")}function f(b,c,d){if(d&&d!=b.which)return-1;var e=0;if(a(c).hasClass("rightBtnActive")&&(e=4,a(c).removeClass("rightBtnActive"),dvStruct.viewer.rightBtnDisable()),a(c).hasClass("leftBtnActive")&&(e=1,a(c).removeClass("leftBtnActive"),dvStruct.viewer.leftBtnDisable()),a(c).hasClass("middleBtnActive")&&(e=2,a(c).removeClass("middleBtnActive"),dvStruct.viewer.middleBtnDisable()),3==b.which){a(".btnArea").removeClass("rightBtnActive"),a(c).addClass("rightBtnActive");var f=4;4!=e&&dvStruct.viewer.rightBtnDisable()}else if(2==b.which){a(".btnArea").removeClass("middleBtnActive"),a(c).addClass("middleBtnActive");var f=2;2!=e&&dvStruct.viewer.middleBtnDisable()}else{a(".btnArea").removeClass("leftBtnActive"),a(c).addClass("leftBtnActive");var f=1;1!=e&&dvStruct.viewer.leftBtnDisable()}return f}function g(){var b=a(".main-engine-box").find(".custom-location").toArray();b.reverse(),a(".main-engine-box").html(b)}var h=this.opts=a.extend({},c,d);dvStruct.container=this,a(".top-tool-box").append(template("flexibletoolTemp",{})),a(".measure-tool-box").append(template("measuretoolTemp",{}));for(var i=this.find(".work-box"),j=0,k=h.viewer.maxCol*h.viewer.maxRow;j<k;j++){var l=guid(8,"win");a(i).append(template("seriesTemp",{seriesId:l,no:j}));for(var m=dvStruct.viewer.addNewWin(l,j),n=document.getElementById(l),o=0,p=h.viewer.maxInnerCol*h.viewer.maxInnerRow;o<p;o++){var q=guid(8,"ele"),r=guid(8,"view");a(n).append(template("viewWrapperTemp",{no:o,id:r,eid:q}));var s={wrapperId:r,pid:l,eid:q,element:document.getElementById(q)};cornerstone.enable(s.element);var t=dvStruct.viewer.createWrapper(s,o);m.wrappers.push(t)}}initSeriesWorkWindows(i,h),initViewSize(),dvStruct.init.checkMouseOnViewpoint(),bindDragToCanv(),dvStruct.viewer.eachWin({callback:function(a){for(var b=0,c=a.wrappers.length;b<c;b++){var d=a.wrappers[b].element,e=a.wrappers[b];cornerstoneTools.addStackStateManager(d,["stack","playClip","referenceLines"]),cornerstoneTools.addToolState(d,"stack",e.stack),d.addEventListener("cornerstoneimagerendered",onViewportUpdated)}}}),a(dvStruct.container).find(".viewer").on("mousewheel DOMMouseScroll",function(a){return a.originalEvent.wheelDelta<0||a.originalEvent.detail>0?dvStruct.fun.nextPage():dvStruct.fun.prevPage(),!1}),a(dvStruct.container).find(".series").on("mousewheel DOMMouseScroll",function(b){a(this).hasClass("seriesCheck")||(a(".series").removeClass("seriesCheck"),a(this).addClass("seriesCheck"),a(this).parents(".study").addClass("studyCheck").siblings().removeClass("studyCheck"),checkAndSynByWinId(a(this).attr("id")),a(".js-reference").find(".btn").hasClass("btnActive")&&(a(".js-reference").click(),a(".js-reference").click()))}),a(".left-box,.top-tool-box,.js-default,.tool_btn ,.tool_window ,.js-clearToolState,.js-zoom,.js-pan,.js-wwwcRegion,.js-wwwc,.js-probeUnSave,.js-probe,.js-length,.js-arrow,.js-angle,.js-ellipse,.js-rect,.js-heartScale,.js-cw,.js-ccw,.js-reference,.js-refresh").on("contextmenu",function(a){return a.preventDefault(),!1}),a(".js-default").mousedown(function(b){var c=f(b,this);dvStruct.viewer.saveDiyStat("js-default",c),setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)}),a(".imgTool").each(function(){a(this).find(".btn").removeClass("btnActive")}),a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive")}),a(".imgTool").click(function(b){a(".imgTool").find(".btn").removeClass("btnActive"),a(this).find(".btn").addClass("btnActive"),a(".js-browseSeries").find(".btn").hasClass("btnActive")&&(a(".js-browseSeries").find(".btn").removeClass("btnActive"),v.state=!1,disablePaging())}),a(window).resize(function(){initViewSize();var a=getPaperSet();initPaperSize(a,"",!0),resizeAtom(),dvStruct.fun.fusionResize()}),a(".public-set-sure").click(function(){var b=a('input[name="toolsLocation"]:checked').val(),c="toolsLocation",d=com.cookie(c);d!=b&&(g(),d=b,com.delCookie(c),com.cookie(c,d,720)),setModeShow("sets",!1)}),a(".js-infoVisible").click(function(){a(this).find(".btn").hasClass("btnActive")?(a(this).find(".btn").removeClass("btnActive"),a(".js-info").hide()):(a(this).find(".btn").addClass("btnActive"),a(".js-info").show())}),a(".js-infoDiretMarker").click(function(){var a=cornerstoneTools.orientationMarkers.getConfiguration()||setting.markesConfig;a&&(a.drawMarkers=!a.drawMarkers,a.isShowAllMarkers&&(a.drawAllMarkers=!a.drawAllMarkers)),cornerstoneTools.orientationMarkers.setConfiguration(a),dvStruct.viewer.eachWin({
callback:function(a){var b=a.wrappers[0],c=b.stack.imageIds.length;if(c>0)for(var d=0,e=a.col*a.row;d<e;d++){var f=a.wrappers[d];cornerstone.getEnabledElement(f.element);d<c&&reDrawWrapper(f)}}})}),a(".js-layoutSelector").click(function(b){dvStruct.dblclickFlag.winNo=dvStruct.dblclickFlag.winNoMax;var c=a(this).offset(),d=a(this).height(),e=a(this).width(),f={x:parseInt(c.left+e/2),y:parseInt(c.top+d)};unit.layoutSelector.show(f,"left")}),a(".js-innerlayoutSelector").click(function(){var b=a(this).offset(),c=a(this).height(),d=a(this).width(),e={x:parseInt(b.left+d/2),y:parseInt(b.top+c)};unit.innerLayoutSelector.show(e,"left"),a(".js-stop").click()}),a(".seriesWindow").on("contextmenu",function(b){if(a(this).addClass("seriesCheck ").siblings().removeClass("seriesCheck "),0==a(".btnArea.rightBtnActive").length||a(".btnArea.rightBtnActive").hasClass("js-default")){var c=a(this).attr("playState");"play"==c?(a(".js-play").hide(),a(".js-stop").show()):(a(".js-stop").hide(),a(".js-play").show());var d=f(b,this);dvStruct.viewer.saveDiyStat("js-wwwl",d),dvStruct.viewer.btnStates.wwwc.enable=!0,dvStruct.viewer.btnStates.wwwc.type=d,setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)})}return b.preventDefault(),!1}),a(".viewer").dblclick(function(){dvStruct.dblclickFlag.clickState===!1?(a(".js-fullScreen").hide(),a(".js-restore").show(),dvStruct.dblclickFlag.winNo=a(".seriesCheck").attr("no"),dvStruct.dblclickFlag.winNo!=dvStruct.dblclickFlag.winNoMax&&(initViewSize(),dvStruct.dblclickFlag.clickState=!0)):(a(".js-fullScreen").show(),a(".js-restore").hide(),dvStruct.dblclickFlag.winNo=dvStruct.dblclickFlag.winNoMax,initViewSize(),dvStruct.dblclickFlag.clickState=!1)}),a(".js-fullScreen").click(function(){a(".js-fullScreen").hide(),a(".js-restore").show(),a(this).parents(".seriesWindow").hasClass("seriesCheck")||(a(".seriesWindow").removeClass("seriesCheck"),a(this).parents(".seriesWindow").addClass("seriesCheck"),checkAndSynByWinId(a(this).parents(".seriesWindow").attr("id")),a(".js-reference").find(".btn").hasClass("btnActive")&&(a(".js-reference").click(),a(".js-reference").click())),dvStruct.dblclickFlag.winNo=a(this).parents(".seriesWindow").attr("no"),dvStruct.dblclickFlag.winNo!=dvStruct.dblclickFlag.winNoMax&&(initViewSize(),dvStruct.dblclickFlag.clickState=!0)}),a(".js-restore").click(function(){a(".js-fullScreen").show(),a(".js-restore").hide(),dvStruct.dblclickFlag.winNo=dvStruct.dblclickFlag.winNoMax,initViewSize(),dvStruct.dblclickFlag.clickState=!1}),a(".js-checkData").click(function(){console.log("dvStruct:",dvStruct)}),a(".js-putFileBtn").click(function(){a("#putFile").click()}),a("#putFile").change(function(a){const b=a.target.files[0];if(0!==b.length){var c=cornerstoneWADOImageLoader.wadouri.fileManager.add(b);console.log(c),setTimeout(function(){cornerstone.loadImage(c).then(function(a){console.log(a)})},5e3)}}),a("body").on("mousedown",".js-dragToCanv img",function(){var b=a(this).attr("src");setModeShow("jpg-view",!0);var c=[];a(this).parents(".series-scan").find(".js-dragToCanv img").each(function(){c.push(a(this).attr("src"))});var d=a(this).parents(".patient-scan").find(".patient-name").attr("title"),e=a(this).parents(".study-time").attr("data-studydatetime");a(".jpg-info-box").find(".name").text(d),a(".jpg-info-box").find(".date").text(e),a(".jpg-item").attr("src",b),a(".scan-box").empty(),c.forEach(function(b){var c='<div class="jpg-box"><img src="'+b+'"></div>';a(".scan-box").append(c)}),a(".jpg-box").eq(0).addClass("jpg-box-check")}),a("body").on("click",".jpg-box img",function(){var b=a(this).parent(),c=a(this).attr("src");b.addClass("jpg-box-check").siblings().removeClass("jpg-box-check"),a(".jpg-item").attr("src",c)}),a(".js-quickwwwc").click(function(b){setModeShow("wwwc",!0);var c=a(".device").val();com.getByClassify(c,callbacks.wwwcShow)}),a("body").on("click","tbody tr",function(){a(this).addClass("wwwc-item-check").siblings().removeClass("wwwc-item-check")}),a(".device").bind("change",function(){var b=a(".device option:selected").text();console.log(b),com.getByClassify(b,callbacks.wwwcShow)}),a("#addwwwc").click(function(b){var c=a(".device option:selected").text();console.log(c),a(".device1").val(c),setModeShow("wwwc",!1),setModeSecondShow("wwwc-set",!0,"add-wwwc")}),a("#modifywwwc").click(function(b){var c=a(".wwwc-item-check"),d=c.find(".name").text(),e=c.find(".wc").text(),f=c.find(".ww").text(),g=a(".device1").val();a(".device1").val(g),a(".wcInput").val(e),a(".wwInput").val(f),a(".modifyName").val(d),setModeShow("wwwc",!1),setModeSecondShow("wwwc-set",!0,"modify-wwwc")}),a("#delewwwc").click(function(){com.delWindowSet(callbacks.reloadWwwc)}),a(".add-wwwc").click(function(b){var c=a(".device1").val(),d=parseInt(a(".wcInput").val()),e=parseInt(a(".wwInput").val()),f=a(".modifyName").val();if(isNaN(d)||isNaN(e))pop_up({title:"error提示",message:"参数有误，窗位窗宽为数值",yesName:"确定",noName:"取消"});else{var g={name:f,device:c,classifyType:c,wc:d,ww:e};console.log(g),com.addWindowSet(g,callbacks.reloadWwwc),setModeSecondShow("printer-set",!1,""),setModeShow("wwwc",!0)}}),a(".modify-wwwc").click(function(b){var c=a(".device1").val(),d=parseInt(a(".wcInput").val()),e=parseInt(a(".wwInput").val()),f=a(".modifyName").val(),g=a(".wwwc-item-check").attr("data-id");if(isNaN(d)||isNaN(e))pop_up({title:"error提示",message:"参数有误，窗位窗宽为数值",yesName:"确定",noName:"取消"});else{var h={id:g,name:f,device:c,classifyType:c,wc:d,ww:e};com.updateWindowSet(h,callbacks.reloadWwwc),setModeSecondShow("printer-set",!1,""),setModeShow("wwwc",!0)}}),a(".wcBtnAdd").click(function(){var b=parseInt(a(".wcInput").val());a(".wcInput").val(b+1)}),a(".wcBtnReduce").click(function(){var b=parseInt(a(".wcInput").val());a(".wcInput").val(b-1)}),a(".wwBtnAdd").click(function(){var b=parseInt(a(".wwInput").val());a(".wwInput").val(b+1)}),a(".wwBtnReduce").click(function(){var b=parseInt(a(".wwInput").val());a(".wwInput").val(b-1)}),a(".openMprPage").click(function(){""==a("#mprFrame").attr("src")&&a("#mprFrame").attr("src","papa_gai/html/main.html");var b=mprFrame;b.window.checkAndLoad&&b.window.checkAndLoad(),a("#mprFrame").focus()}),a(".js-modePage").click(function(){var b=a(this).attr("mode");if(getModePage(b),"mpr"==b){var c=a(this).parents(".seriesWindow").find(".viewWrapper").first().find(".js-info-SeNo").attr("data-seriesId");mprLoadSeries(c)}}),a(".js-VR").click(function(){var b=a(this).parents(".seriesWindow").find(".viewWrapper").first().find(".js-info-SeNo").attr("data-seriesId"),c=dvStruct.findSeries(b),d=c.dicomArr.length,e=getVoxelDimensions(c);a(".js-VR").hide();var f=50,g=0;if("WebSocket"in window)try{socketMsg=new WebSocket(eSetting.addrIni.msgServer),socketMsg.onopen=function(){setTimeout(function(){var a="VR",b="serviceType:"+a;socketMsg.send(b)},300)},socketMsg.onmessage=function(a){var g=a.data;if(console.log("message:",g),"0"==g&&(pop_up({title:"VR提示",message:"三维处理应用程序打开失败，请联系工程人员！（5秒后自动关闭该窗口）",yesName:"确定",noName:"取消",autoClose:!0,delay:5e3}),alreadyState()),"1"==g){var h=Math.ceil(d/f);return process3D.series=c.dicomArr,process3D.paraVR.seriesLength=d,process3D.paraVR.dataLength=h,process3D.voxelDimensions=e,void setTimeout(function(){callServiceVR.socketConnect(b,d,h)},300)}enableStateVR=!0},socketMsg.onclose=function(){},socketMsg.error=function(){sendState(),a(".wmf-confirm").empty(),a(".wmf-confirm").hide(),a(".overlay_pop").hide(),pop_up({title:"VR提示",message:"数据解析出错，请联系工程人员！（10秒后自动关闭该窗口）",ok:alreadyState(),yesName:"确定",noName:"取消",autoClose:!0,delay:1e4})}}catch(h){g=3,console.log(h)}else g=-1;socketMsg&&(g=2),setTimeout(function(){if(1==socketMsg.readyState){if(!JSZip.support.blob)return pop_up({title:"VR提示",message:"浏览器不支持数据解析",yesName:"确定",noName:"取消"}),alreadyState(),!1}else socketConnectionTipsVR(g),alreadyState()},3e3)}),a(".js-order").click(function(){var b=dvStruct.viewer.col*dvStruct.viewer.row;a(".series-scan").each(function(c,d){if(c==b)return!1;var e=a(d).attr("data-seriesId"),f=a(".seriesWindow").eq(c).attr("seriesId");if(e!=f){var d=dvStruct.findSeries(e),g=d.dicomArr.length;dvStruct.viewer.bindSeries(dvStruct.viewer.getWinByNo(c),e,g,!1)}})}),a(".js-Web3D").click(function(){var b=a(this).attr("mode");getModePage(b);var c=a(this).parents(".seriesWindow").find(".viewWrapper").first().find(".js-info-SeNo").attr("data-seriesId"),d=dvStruct.findSeries(c),e=d.dicomArr[0].imageId,d=(dvStruct.viewer.findOriInfoByIds(e,c),dvStruct.findSeries(c)),f=[];d.dicomArr.forEach(function(a){var b=a.dataSet.blob,c=new File([new Blob([b])],a.imageId.split("/").slice(-1)[0]);f.push(c)});var g=document.querySelector(".web3D-container");itkVtkViewer.processParameters(g,{fullscreen:!0,filesToLoad:f})}),a(".web3D-close-btn").click(function(a){getModePage("viewer")}),a(".series").click(function(){a(".series").removeClass("seriesCheck"),a(this).addClass("seriesCheck"),a(this).parents(".study").addClass("studyCheck").siblings().removeClass("studyCheck"),checkAndSynByWinId(a(this).attr("id")),a(".js-reference").find(".btn").hasClass("btnActive")&&(a(".js-reference").click(),a(".js-reference").click())}),a(".js-scrollAll").click(function(){a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive"),dvStruct.viewer.scrollAll=~dvStruct.viewer.scrollAll,a(this).hasClass("checked")?a(this).removeClass("checked"):a(this).addClass("checked")}),a(".js-syn").click(function(){if(a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive"),dvStruct.synposition.enable=!dvStruct.synposition.enable,dvStruct.synposition.enable){a(this).addClass("checked");var b=dvStruct.viewer.getCheckedWin();b&&checkAndSynByWinId(b.winId)}else a(this).removeClass("checked")}),a(".js-signInput").change(function(){var b=a(this).is(":checked"),c=a(this).attr("signId"),d=a(this).attr("imageId"),e=a(this).attr("seriesId");b=b?1:0,signAction(e,d,c,b)}),a(".js-refresh").click(function(a){dvStruct.fun.reset()});var u=!0;a(".js-fakecolor").hover(function(){u?a(".fake-color-list").show():u=!0}),a(".fake-color-list").mouseleave(function(){a(".fake-color-list").hide(),u=!1}),a(".fake-color-list li").click(function(){var b=a(this).attr("value");""!=b?dvStruct.fun.changeColormaps(b,!1):dvStruct.fun.changeColormaps("gray",!0)}),a(".fusion").click(function(a){console.log(" PET CT 融合");document.getElementById("colormaps").value;dvStruct.fun.fusion("jet")}),a(".js-fusion").click(function(a){return}),a(".fusion-colormap-btn").hover(function(){a(".fusion-colormap").show()},function(){a(".fusion-colormap").hide()}),a(".fusion-opacity-btn").hover(function(){a(this).find(".fusion-opacity-box").show()},function(){a(this).find(".fusion-opacity-box").hide()}),a(".fusion-opacity").change(function(){var b=(a(this).val()/100).toFixed(1);a(this).parent().find("label").text(b)}),a(".fusion-colormap li").click(function(){var b=a(this).attr("value"),c=a(".fusion-result-box .fusion-viewport").get(0),d=cornerstone.getActiveLayer(c);d.viewport.colormap=b,cornerstone.updateImage(c)}),a(".fusion-visible").click(function(){var b=a(".fusion-result-box .fusion-viewport").get(0),c=cornerstone.getViewport(b);c.voi.windowWidth=128,c.voi.windowCenter=256,cornerstone.setViewport(b,c),cornerstoneTools.wwwc.enable(b,1),cornerstoneTools.wwwc.activate(b,1)}),a(".js-invert").click(function(){dvStruct.fun.invert()}),a(".js-reference").click(function(){cornerstoneTools.handleR=1,a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive"),synchronizer.destroy(),dvStruct.viewer.btnStates.referenceLines.enable?(dvStruct.viewer.btnStates.referenceLines.enable=!1,setAllEle(function(a){dvStruct.fun.disableReferenceLines(a)})):(dvStruct.viewer.btnStates.referenceLines.enable=!0,setAllEle(function(a){synchronizer.add(a)}),setAllEle(function(a){dvStruct.fun.enableReferenceLines(a)}))}),a(document).bind("selectstart",function(){return!1}),a(".js-ccw").click(function(){dvStruct.fun.rotate2()}),a(".js-cw").click(function(){dvStruct.fun.rotate()}),a(".js-vRev").click(function(){dvStruct.fun.rev("v")}),a(".js-hRev").click(function(){dvStruct.fun.rev("h")}),a(".js-magnify").mousedown(function(a){var b=f(a,this);dvStruct.viewer.saveDiyStat("js-magnify",b),dvStruct.viewer.btnStates.magnify.enable=!0,dvStruct.viewer.btnStates.magnify.type=b,dvStruct.viewer.btnStates.magnifyTouchDrag.enable=!0,dvStruct.viewer.btnStates.magnifyTouchDrag.type=b,cornerstoneTools.magnify.setConfiguration(magnifyConfig),setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)})}),a(".tool_btn").click(function(){a(this).hasClass("js-magnify")?a(".set_area").show():a(".set_area").hide()}),a(".js-frameRateFast").click(function(a){dvStruct.frameRate++,console.log(dvStruct.frameRate)}),a(".js-frameRateSlow").click(function(a){dvStruct.frameRate--,dvStruct.frameRate<3&&(dvStruct.frameRate=3),console.log(dvStruct.frameRate)}),a(".js-wwwcRegion").click(function(b){var c="wwwcRegion",d=f(b,this,1);d!=-1&&(dvStruct.viewer.saveDiyStat(c,d),dvStruct.viewer.btnStates[c].enable=!0,dvStruct.viewer.btnStates[c].type=d,setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)}),a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive"))}),a(".js-wwwc").click(function(b){var c="wwwc",d=f(b,this,1);d!=-1&&(dvStruct.viewer.saveDiyStat(c,d),dvStruct.viewer.btnStates[c].enable=!0,dvStruct.viewer.btnStates[c].type=d,setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)}),a(this).find(".btn").hasClass("btnActive")?a(this).find(".btn").removeClass("btnActive"):a(this).find(".btn").addClass("btnActive"))}),a(".img-measure-tool ").mousedown(function(b){var c=a(this).attr("data-measure-type"),d=f(b,this,1,c);d!=-1&&(dvStruct.dragOpt.viewer.show&&("clear"==c?dvStruct.fun.clearToolState():"mouse"==c?e():c&&(dvStruct.viewer.saveDiyStat(c,d),dvStruct.viewer.btnStates[c].enable=!0,dvStruct.viewer.btnStates[c].type=d,setAllEle(function(a){dvStruct.fun.checkAndSetActive(a),a&&"eraser"==c&&(cornerstoneTools.probe.enable(a,1),cornerstoneTools.length.enable(a,1),cornerstoneTools.deviation.enable(a,1),cornerstoneTools.ellipticalRoi.enable(a,1),cornerstoneTools.rectangleRoi.enable(a,1),cornerstoneTools.angle.enable(a,1),cornerstoneTools.simpleAngle.enable(a,1),cornerstoneTools.highlight.enable(a,1),cornerstoneTools.heartScale.enable(a,1),cornerstoneTools.freehand.enable(a,1),cornerstoneTools.eraser.enable(a,1),cornerstoneTools.eraser.activate(a,1))}))),dvStruct.dragOpt.mpr.show&&(a(".mpr-wrapper-box").show(),dvStruct.mpr.mprResize(),"mouse"==c?(dvStruct.viewer.saveDiyStat("js-default",d),a(".mpr-viewport").each(function(){var b=a(this).get(0);dvStruct.fun.checkAndSetActive(b),cornerstoneTools.mouseInput.enable(b),cornerstoneTools.mouseWheelInput.enable(b),cornerstoneTools.wwwc.activate(b,4)}),dvStruct.mpr.mesureMode?(a(".mpr-wrapper-box").hide(),dvStruct.mpr.mesureMode=!1):(a(".mpr-wrapper-box").show(),dvStruct.mpr.mprResize(),dvStruct.mpr.mesureMode=!0)):(dvStruct.mpr.mesureMode=!0,"clear"==c?(dvStruct.fun.clearToolState(),a(".mpr-viewport").each(function(){var b=a(this).get(0);cornerstoneTools.clearToolState(b,"length"),cornerstoneTools.clearToolState(b,"probe"),cornerstoneTools.clearToolState(b,"rectangleRoi"),cornerstoneTools.clearToolState(b,"ellipticalRoi"),cornerstoneTools.clearToolState(b,"length"),cornerstoneTools.clearToolState(b,"deviation"),cornerstoneTools.clearToolState(b,"angle"),cornerstoneTools.clearToolState(b,"simpleAngle"),cornerstoneTools.clearToolState(b,"heartScale"),cornerstoneTools.clearToolState(b,"twolines"),cornerstoneTools.clearToolState(b,"arrowAnnotate"),cornerstoneTools.clearToolState(b,"freehand"),cornerstone.updateImage(b)})):c&&(dvStruct.viewer.saveDiyStat(c,d),dvStruct.viewer.btnStates[c].enable=!0,dvStruct.viewer.btnStates[c].type=d,a(".mpr-viewport").each(function(){var b=a(this).get(0);dvStruct.fun.checkAndSetActive(b),b&&"eraser"==c&&(cornerstoneTools.probe.enable(b,1),cornerstoneTools.length.enable(b,1),cornerstoneTools.deviation.enable(b,1),cornerstoneTools.ellipticalRoi.enable(b,1),cornerstoneTools.rectangleRoi.enable(b,1),cornerstoneTools.angle.enable(b,1),cornerstoneTools.simpleAngle.enable(b,1),cornerstoneTools.highlight.enable(b,1),cornerstoneTools.freehand.enable(b,1),cornerstoneTools.eraser.enable(b,1),cornerstoneTools.eraser.activate(b,1))})))),dvStruct.dragOpt.print.show)}),a(".js-hideLeft").click(function(){var c=a(".js-hideLeft").attr("state");"hide"==c?(a(this).find(".icon").addClass("rotate"),a(this).find(".icon").removeClass("rotate1"),a(".js-hideLeft").attr("state","show"),a(".leftGallery").css("left",-a(".leftGallery").width()),a(".toolV").css("left",0),a(".dvContainer").css("padding-left",0),b(a(".js-topPannel").width()-a(".toolV").width())):(a(this).find(".icon").addClass("rotate1"),a(this).find(".icon").removeClass("rotate"),a(".js-hideLeft").attr("state","hide"),a(".leftGallery").css("left",0),a(".toolV").css("left",a(".leftGallery").width()),a(".dvContainer").css("padding-left",a(".leftGallery").width()),b(a(".js-topPannel").width()-a(".logo").width()))}),a(".js-downloadset").click(function(a){setModeShow("common-download",!0)}),a("#dcmDownload").click(function(){var b=a(".download-params").attr("data-downRange"),c=a(".download-params").attr("data-downStudyId"),d=a(".download-params").attr("data-downSeriesId");dvStruct.localDownload(b,"dcm",{studyId:c,seriesId:d}),a(".jpg-temp-draw-box").empty()}),a("#jpgDownload").click(function(){var b=a(".download-params").attr("data-downRange"),c=a(".download-params").attr("data-downStudyId"),d=a(".download-params").attr("data-downSeriesId");dvStruct.localDownload(b,"jpg",{studyId:c,seriesId:d}),a(".jpg-temp-draw-box").empty()}),a(".download-single-jpg").click(function(){var b=a(".jpg-item").attr("src");const c=document.createElement("a");c.href=b,c.download=b;const d=document.createEvent("MouseEvents");d.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(d)}),a(".widthInput, .centerInput").bind("keypress",function(b){if("13"==b.keyCode){var c=a(".widthInput").val(),d=a(".centerInput").val();isNaN(c)||isNaN(d)||dvStruct.fun.wwwc(c,d),a(".widthInput").blur(),a(".centerInput").blur()}}),a(".js-browseSeries").mousedown(function(b){a(".imgTool").each(function(){a(this).find(".btn").removeClass("btnActive")});var c=f(b,this);dvStruct.viewer.saveDiyStat("js-default",c),setAllEle(function(a){dvStruct.fun.checkAndSetActive(a)}),a(this).find(".btn").hasClass("btnActive")?(a(this).find(".btn").removeClass("btnActive"),v.state=!1,disablePaging()):(a(this).find(".btn").addClass("btnActive"),v.state=!0)});var v={state:!1,start:!1,H:0,imgSliderH:0,imgSliderTop:0,imgSliderBottom:0};a(".viewport canvas").on("mousedown",function(b){if(a(".js-browseSeries").find(".btn").hasClass("btnActive")&&(v.state=!0),v.state){var c=dvStruct.whereIsMouse;if(dvStruct.fun.elementPaging(c),dvStruct.fun.synPagingCheck(c),_.isObject(c))for(var d=0;d<c.col*c.row;d++){var e=c.wrappers[0],f=e.stack,g=e.element,h=f.imageIds[f.currentImageIdIndex];h&&(cornerstone.enable(g),cornerstoneTools.mouseInput.enable(g),cornerstone.loadImage(h).then(function(a){cornerstone.displayImage(g,a),cornerstoneTools.addStackStateManager(g,["stack"]),cornerstoneTools.addToolState(g,"stack",f),cornerstoneTools.stackScroll.activate(g,1)}))}if(!v.start){v.start=!0;var i=a(this).parents(".seriesWindow").find(".imgblock").height(),j=a(this).parents(".seriesWindow").find(".imgSlider").height();v.imgSliderH=j,v.imgSliderBottom=j-i}}}),a(".viewport canvas").on("mousemove",function(b){if(v.state&&v.start){a(this).parents(".seriesWindow").find(".imgSlider").css("opacity","1");var c=parseInt(a(this).parents(".seriesWindow").find(".js-info-nowNo").text().slice(4))-1,d=parseInt(a(this).parents(".seriesWindow").find(".js-info-totalNo").text().slice(1)),e=c/d,f=parseInt(v.imgSliderH*e);f<0&&(f=0),f>v.imgSliderBottom&&(f=v.imgSliderBottom),a(this).parents(".seriesWindow").find(".imgblock").css("top",f)}}),a(".viewport canvas").on("mouseup",function(b){v.start=!1,v.state&&a(this).parents(".seriesWindow").find(".imgSlider").css("opacity","0")}),a(".viewport canvas").on("mouseleave",function(b){v.start=!1,v.state&&a(this).parents(".seriesWindow").find(".imgSlider").css("opacity","0")}),a(".js-play").click(function(){var b=dvStruct.viewer.getCheckedWin();b&&(dvStruct.fun.play(),a(".seriesWindow.seriesCheck").attr("playState","play"),a(".js-play").hide(),a(".js-stop").show(),b.imgObjArr.length>1?a(".seriesWindow.seriesCheck").find(".playcontrol").show():a(".seriesWindow.seriesCheck").find(".playcontrol").hide(),a(".seriesWindow.seriesCheck").find(".playStart").hide(),a(".seriesWindow.seriesCheck").find(".playStop").show())}),a(".js-stop").click(function(){dvStruct.fun.stop(),a(".seriesWindow").attr("playState","stop"),a(".js-play").show(),a(".js-stop").hide(),a(".playStart").show(),a(".playStop").hide(),a(".playcontrol").hide()}),a(document).on("click",".unlock",function(){var b=a(this);b.parent().find(".locked-image").text();b.parent().find(".unlock-state").text("解锁中！"),b.hide(),com.unlockImage(function(a){200==a.status&&b.parent().find(".unlock-state").text("解锁成功，请稍后刷新页面重新加载数据！")},function(a){b.parent().find(".unlock-state").text(a.msg+",解锁失败！"),b.show()})}),a(".close-load-tips").click(function(){a(".load-tips-box").hide(),a(".load-alert").show()}),a(".load-alert").click(function(b){a(".load-tips-box").show(),a(this).hide()}),a(".load-again").click(function(b){a(".cross-origin-box").find(".item").each(function(b,c){a(this).click()})})}})}(jQuery),!dvStruct)var dvStruct={};dvStruct.enableSaveDownloaded=!0,dvStruct.downloadedDcmFiles=[],commEventHandler.addEventListener("dicomDownloaded",function(a){dvStruct.enableSaveDownloaded&&dvStruct.downloadedDcmFiles.push({name:a.name,data:a.data,infoAfterAnalysised:a.infoAfterAnalysised})}),dvStruct.saveDownloaded=function(a,b){dvStruct.share&&($(".tipsText").text("注：分享模式下，无法下载原dicom格式文件，请您选择下载jpg格式文件!"),$("#tipsBoxs").show());for(var c=new JSZip,d=c.folder("dicoms"),e=0,f=dvStruct.seriesArr.length;e<f;e++)for(var g=0,h=dvStruct.seriesArr[e].dicomArr.length;g<h;g++){var i=dvStruct.seriesArr[e].dicomArr[g].dataSet,j=e.toString()+"_"+g.toString()+".dcm";d.file(j,i.byteArray)}if(a){var k;JSZip.support.blob&&c.generateAsync({type:"blob"}).then(function(a){return k=getPrintURL(a,"dicoms.zip"),getUrlFlag=!0,b.push(k.printURL),k.printURL},function(a){console.error(a)})}else if(JSZip.support.blob)return c.generateAsync({type:"blob"}).then(function(a){fileSaveAs(a,"dicoms.zip")},function(a){console.error(a)}),!1},dvStruct.drawJpgForDownload=function(a,b){$(".jpg-temp-draw-box").empty(),dvStruct.seriesArr.forEach(function(c,d){if((c.studyId==b.studyId&&"study"==a||"series"==a&&c.seriesId==b.seriesId)&&c.dicomArr.forEach(function(a,b){if("dicom"==a.imageType){var c=d+"_"+b+"_"+a.imageId.split("/").pop()+".jpg",e=a.infoSet.ImageInfo.Columns.val,f=a.infoSet.ImageInfo.Rows.val,g=$('<div class="jpg-temp"></div>');g.attr("baseName",c),g.width(e),g.height(f),$(".jpg-temp-draw-box").append(g);var h=g.get(0);cornerstone.enable(h);var i=dvStruct.findImgObj(a.imageId);cornerstone.displayImageDraw(h,i)}}),"series"==a&&c.seriesId==b.seriesId)return!1})},dvStruct.localDownload=function(a,b,c){var d=new JSZip,e=c.studyId;"series"==a&&(e=c.studyId+"_"+c.seriesId);var f=d.folder(e);if("jpg"==b?$(".jpg-temp-draw-box").find(".jpg-temp").each(function(){var a=$(this).attr("baseName"),b=$(this).find("canvas").get(0),c=b.toDataURL("image/jpeg"),d=dataURLtoBlob(c);f.file(a,d)}):dvStruct.seriesArr.forEach(function(b,d){if((b.studyId==c.studyId&&"study"==a||"series"==a&&b.seriesId==c.seriesId)&&b.dicomArr.forEach(function(a,b){if("dicom"==a.imageType){var c=d+"_"+b+"_"+a.imageId.split("/").pop(),e=a.dataSet;eSetting.download&&eSetting.download.shield&&eSetting.download.data.forEach(function(a){var b=e.elements[a];if(b)for(var c=b.length,d=0,f=b.dataOffset;d<c;d++)e.byteArray[f+d]=eSetting.download.replaceCharCode}),f.file(c+".dcm",e.byteArray)}}),"series"==a&&b.seriesId==c.seriesId)return!1}),JSZip.support.blob)return d.generateAsync({type:"blob"}).then(function(a){fileSaveAs(a,e+".zip")},function(a){console.error(a)}),!1},cornerstone.registerImageLoader("oridcm",dvLocalLoader),cornerstone.registerImageLoader("series",dvSeriesLoader);var dvStruct=dvStruct||{};dvStruct.fun=dvStruct.fun||{};var synchronizer=new cornerstoneTools.Synchronizer("cornerstonenewimage",cornerstoneTools.updateImageSynchronizer);dvStruct.fun.enableReferenceLines=function(a){cornerstoneTools.referenceLines.tool.enable(a,synchronizer)},dvStruct.fun.disableReferenceLines=function(a){cornerstoneTools.referenceLines.tool.disable(a,synchronizer)},dvStruct.fun.elementIni=function(a,b){enableAllTools(a),synchronizer.add(a),b&&(b.synchronizerWWWC.add(a),b.synchronizerZoomPan.add(a))},dvStruct.fun.removeSync=function(a,b){synchronizer.remove(b),a.synchronizerWWWC.remove(b),a.synchronizerZoomPan.remove(b)},dvStruct.fun.checkAndSetActive=function(a){if(a)for(var b in dvStruct.viewer.btnStates){var c=dvStruct.viewer.btnStates[b].type;dvStruct.viewer.btnStates[b].enable?"referenceLines"==b?cornerstoneTools.referenceLines.tool.enable(a,synchronizer):cornerstoneTools[b].activate(a,c):"referenceLines"==b?cornerstoneTools.referenceLines.tool.disable(a,synchronizer):cornerstoneTools[b].deactivate(a,c)}},dvStruct.whereIsMouse=void 0,dvStruct.init=dvStruct.init||{},dvStruct.init.checkMouseOnViewpoint=function(){var a=$(dvStruct.container).find(".viewer");a.on("mousemove",function(a){var b=a.pageX,c=a.pageY,d=getTargetStd(b,c);d.winNo>=0?dvStruct.whereIsMouse=dvStruct.viewer.getWinByNo(d.winNo):dvStruct.whereIsMouse=void 0}),a.on("mouseleave",function(a){dvStruct.whereIsMouse=void 0})},dvStruct.fun.nextPage=function(){if(dvStruct.viewer.scrollAll)for(var a=dvStruct.viewer.winArr,b=a.length,c=0;c<b;c++)dvStruct.fun.elementPaging(a[c]);else{var d=dvStruct.whereIsMouse;dvStruct.fun.elementPaging(d),dvStruct.fun.synPagingCheck(d)}},dvStruct.fun.prevPage=function(){if(dvStruct.viewer.scrollAll)for(var a=dvStruct.viewer.winArr,b=a.length,c=0;c<b;c++)dvStruct.fun.elementPaging(a[c],"prev");else{var d=dvStruct.whereIsMouse;dvStruct.fun.elementPaging(d,"prev"),dvStruct.fun.synPagingCheck(d)}},dvStruct.fun.imageChange=function(a){if(dvStruct.viewer.scrollAll)for(var b=dvStruct.viewer.winArr,c=b.length,d=0;d<c;d++)dvStruct.fun.elementPaging(b[d],a);else{var e=$(".seriesCheck ").attr("no"),f=dvStruct.viewer.getWinByNo(parseInt(e));dvStruct.fun.elementPaging(f,a),dvStruct.fun.synPagingCheck(f)}},dvStruct.fun.elementPaging=function(a,b){if(_.isObject(a)){var c=a.col*a.row,d=a.wrappers[0].stack.imageIds.length,e=a.wrappers[0].stack.currentImageIdIndex,f=a.wrappers[c-1].stack.currentImageIdIndex;if("prev"==b){if(0==e)return!1}else if("aiState"==b);else if(f==d-1)return!1;a.wrappers.forEach(function(a,c){var e=a.stack;if(d>0){"prev"==b?e.currentImageIdIndex<=0?e.currentImageIdIndex=0:e.currentImageIdIndex--:"aiState"==b||(e.currentImageIdIndex<d-1?e.currentImageIdIndex++:e.currentImageIdIndex=d-1);var f=e.imageIds[e.currentImageIdIndex];if(!f)return!1;var g=cornerstone.getEnabledElement(a.element);cornerstone.loadImage(f).then(function(b){b.columnPixelSpacing!=g.viewport.displayedArea.columnPixelSpacing||b.rowPixelSpacing!=g.viewport.displayedArea.rowPixelSpacing?g.viewport=void 0:b.columns==g.viewport.displayedArea.brhc.x&&b.rows==g.viewport.displayedArea.brhc.y||(g.viewport=void 0),cornerstone.displayImage(a.element,b)}),$("#"+a.wrapperId).find(".js-info-nowNo").text("Im: "+(e.currentImageIdIndex+1)),$("#"+a.wrapperId).find(".js-info-nowNo").attr("title",e.currentImageIdIndex+1);var h=dvStruct.viewer.findOriInfoByIds(f,e.seriesId);$("#"+a.wrapperId).find(".js-sign").find("input").prop("checked",h.isSign),$("#"+a.wrapperId).find(".js-sign").find("input").attr("signId",h.signId),$("#"+a.wrapperId).find(".js-sign").find("input").attr("imageId",f),$("#"+a.wrapperId).find(".js-sign").find("input").attr("seriesId",e.seriesId);var i=$("[class='seriesWindow checked']").find(".js-lungAI-shiyan").attr("type"),j=$("[class='seriesWindow checked']").find(".lungResultBox"),k=$("[class='seriesWindow checked']").attr("seriesIndex");if(void 0!=dvStruct.aiResult.series[k]&&void 0!=dvStruct.aiResult.series[k].data[i]){var l=dvStruct.aiResult.series[k].data[i];if(j.empty(),"0"==i)if(void 0!=l.result[e.currentImageIdIndex]&&l.result[e.currentImageIdIndex].length>0){var m=[];l.result[e.currentImageIdIndex].forEach(function(a,b){var c=a.location.split(","),d={x:c[0],y:c[1],radius:a.diameter};m.push(d);var e=' <div style="width: 100px;"><div>编号:a'+b+"</div><div>位置:("+c[0]+","+c[1]+")</div><div>直径:"+a.diameter+"</div><div>密度:"+a.density+"</div><div>概率:"+a.probability+"%</div></div>";j.append(e)}),j.show(),dvStruct.fun.drawCustomCircle(a.element,m,!1)}else dvStruct.fun.drawCustomCircle(a.element,[],!0),j.hide();else if("1"==i||"2"==i){if(void 0!=l.result[e.currentImageIdIndex]&&l.result[e.currentImageIdIndex].length>0){var n="";n="1"==i?"0"==l.result[e.currentImageIdIndex][0].hasDiabetics?"无糖":"有粮":"0"==l.result[e.currentImageIdIndex][0].diagnosisResult?"诊断正常":"诊断异常";var o=l.result[e.currentImageIdIndex][0].probability,p='<div style="width: 100px;"><div>结果:'+n+"</div> <div>概率:"+o+"%</div></div>";j.show(),j.append(p)}else j.hide();dvStruct.fun.drawCustomCircle(a.element,[],!0)}else j.hide(),dvStruct.fun.drawCustomCircle(a.element,[],!0)}}})}},dvStruct.fun.synPagingCheck=function(a){if(dvStruct.synposition.enable){var b=a.wrappers[0],c=b.stack,d=c.imageIds[c.currentImageIdIndex];dvStruct.synposition.findAndSyn(d,b)}},dvStruct.playSpeed=2,dvStruct.isplaying=!1,dvStruct.savedPlaying=[],dvStruct.fun.play=function(a){if(a&&dvStruct.savedPlaying.length>0)for(var b=0,c=dvStruct.savedPlaying.length;b<c;b++)cornerstoneTools.diy.winPlayClip(dvStruct.savedPlaying[b],dvStruct.playSpeed);else{var d=dvStruct.viewer.getCheckedWin();if(d)cornerstoneTools.diy.winPlayClip(d,dvStruct.playSpeed),dvStruct.savedPlaying.push(d);else for(var e=dvStruct.viewer.winArr,f=dvStruct.viewer.col*dvStruct.viewer.row,b=0;b<f;b++)cornerstoneTools.diy.winPlayClip(e[b],dvStruct.playSpeed),dvStruct.savedPlaying.push(e[b])}dvStruct.isplaying=!0},dvStruct.fun.stop=function(a){for(var b=dvStruct.viewer.winArr,c=dvStruct.viewer.col*dvStruct.viewer.row,d=0;d<c;d++)cornerstoneTools.diy.winStopClip(b[d]);dvStruct.isplaying=!1,a||(dvStruct.savedPlaying=[])},dvStruct.fun.stopCurrent=function(a){var b=dvStruct.viewer.winArr;cornerstoneTools.diy.winStopClip(b[a]),dvStruct.isplaying=!1},dvStruct.fun.invert=function(){var a=dvStruct.viewer.getCheckedWin();if(a){var b=a.wrappers[0];b.stack.imageIds.length>0&&dvStruct.fun.invertEle(b.element)}else for(var c=dvStruct.viewer.winArr,d=c.length,e=0;e<d;e++){var b=c[e].wrappers[0];b.stack.imageIds.length>0&&dvStruct.fun.invertEle(b.element)}},dvStruct.fun.invertEle=function(a){var b=cornerstone.getViewport(a);b&&(b.invert===!0?b.invert=!1:b.invert=!0,cornerstone.setViewport(a,b))},dvStruct.fun.fake=function(){var a=dvStruct.viewer.getCheckedWin();if(a)for(var b=a.wrappers.length,c=0;c<b;c++){var d=a.wrappers[c];d.stack.imageIds.length>0&&dvStruct.fun.fakeEle(d.element)}else for(var e=dvStruct.viewer.winArr,b=dvStruct.viewer.col*dvStruct.viewer.row,c=0;c<b;c++)for(var f=0,g=e[c].wrappers.length;f<g;f++){var d=e[c].wrappers[f];d.stack.imageIds.length>0&&dvStruct.fun.fakeEle(d.element)}},dvStruct.fun.getCustomLookupTable=function(a,b){const c=cornerstone.colors.getColormap("myCustomColorMap");return c.setNumberOfColors(6),c.insertColor(0,[188,252,201,255]),c.insertColor(1,[245,222,179,255]),c.insertColor(2,[255,125,64,255]),c.insertColor(3,[135,38,87,255]),c.insertColor(4,[227,206,87,255]),c.insertColor(5,[51,160,201,255]),c},dvStruct.fun.changeColormaps=function(a){var b=dvStruct.viewer.getCheckedWin();if(b)for(var c=b.wrappers.length,d=0;d<c;d++){var e=b.wrappers[d];e.stack.imageIds.length>0&&dvStruct.fun.changeColormapEle(e.element,a);
}else for(var f=dvStruct.viewer.winArr,g=dvStruct.viewer.col*dvStruct.viewer.row,d=0;d<g;d++)for(var h=0,i=f[d].wrappers.length;h<i;h++){var e=f[d].wrappers[h];e.stack.imageIds.length>0&&dvStruct.fun.changeColormapEle(e.element,a)}},dvStruct.fun.changeColormapEle=function(a,b){var c=cornerstone.getViewport(a);c.colormap=b,cornerstone.setViewport(a,c),cornerstone.updateImage(a,!0)},dvStruct.fun.reset=function(){var a=dvStruct.viewer.getCheckedWin();if(a)for(var b=a.wrappers.length,c=0;c<b;c++){var d=a.wrappers[c];d.stack.imageIds.length>0&&cornerstone.reset(d.element)}else for(var e=dvStruct.viewer.winArr,f=dvStruct.viewer.col*dvStruct.viewer.row,c=0;c<f;c++)for(var g=0,h=e[c].wrappers.length;g<h;g++){var d=e[c].wrappers[g];d.stack.imageIds.length>0&&cornerstone.reset(d.element)}},dvStruct.fun.wwwc=function(a,b){var c=dvStruct.viewer.getCheckedWin();if(c)for(var d=c.wrappers.length,e=0;e<d;e++){var f=c.wrappers[e];if(f.stack.imageIds.length>0){var g=cornerstone.getViewport(f.element);g.voi.windowWidth=a,g.voi.windowCenter=b,cornerstone.setViewport(f.element,g)}}else for(var h=dvStruct.viewer.winArr,i=dvStruct.viewer.col*dvStruct.viewer.row,e=0;e<i;e++)for(var j=0,k=h[e].wrappers.length;j<k;j++){var f=h[e].wrappers[j];if(f.stack.imageIds.length>0){var g=cornerstone.getViewport(f.element);g.voi.windowWidth=a,g.voi.windowCenter=b,cornerstone.setViewport(f.element,g)}}},dvStruct.fun.fakeEle=function(a){var b=cornerstone.getViewport(a);b&&(b.fakeColor===!0?b.fakeColor="printBack":b.fakeColor=!0,cornerstone.setViewport(a,b))},dvStruct.fun.clearToolState=function(){var a=dvStruct.viewer.getCheckedWin();if(a)for(var b=a.wrappers.length,c=0;c<b;c++){var d=a.wrappers[c];if(d.stack.imageIds.length>0){var e=d.element;try{cornerstoneTools.clearToolState(e,"length"),cornerstoneTools.clearToolState(e,"probe"),cornerstoneTools.clearToolState(e,"rectangleRoi"),cornerstoneTools.clearToolState(e,"ellipticalRoi"),cornerstoneTools.clearToolState(e,"length"),cornerstoneTools.clearToolState(e,"angle"),cornerstoneTools.clearToolState(e,"simpleAngle"),cornerstoneTools.clearToolState(e,"heartScale"),cornerstoneTools.clearToolState(e,"deviation"),cornerstoneTools.clearToolState(e,"crossRotation"),cornerstoneTools.clearToolState(e,"twolines"),cornerstoneTools.clearToolState(e,"arrowAnnotate"),cornerstoneTools.clearToolState(e,"freehand")}catch(f){console.error(f)}cornerstone.updateImage(e)}}},dvStruct.fun.rotate=function(){var a=dvStruct.viewer.getCheckedWin();if(a)for(var b=a.wrappers.length,c=0;c<b;c++){var d=a.wrappers[c];if(d.stack.imageIds.length>0){var e=cornerstone.getViewport(d.element);e.rotation=(e.rotation+90)%360,cornerstone.setViewport(d.element,e)}}else for(var f=dvStruct.viewer.winArr,g=dvStruct.viewer.col*dvStruct.viewer.row,c=0;c<g;c++)for(var h=0,i=f[c].wrappers.length;h<i;h++){var d=f[c].wrappers[h];if(d.stack.imageIds.length>0){var e=cornerstone.getViewport(d.element);e.rotation=(e.rotation+90)%360,cornerstone.setViewport(d.element,e)}}},dvStruct.fun.rotate2=function(){var a=dvStruct.viewer.getCheckedWin();if(a)for(var b=a.wrappers.length,c=0;c<b;c++){var d=a.wrappers[c];if(d.stack.imageIds.length>0){var e=cornerstone.getViewport(d.element);e.rotation=(e.rotation-90)%360,cornerstone.setViewport(d.element,e)}}else for(var f=dvStruct.viewer.winArr,g=dvStruct.viewer.col*dvStruct.viewer.row,c=0;c<g;c++)for(var h=0,i=f[c].wrappers.length;h<i;h++){var d=f[c].wrappers[h];if(d.stack.imageIds.length>0){var e=cornerstone.getViewport(d.element);e.rotation=(e.rotation-90)%360,cornerstone.setViewport(d.element,e)}}},dvStruct.fun.rev=function(a){var a=a||"h",b=dvStruct.viewer.getCheckedWin();if(b)for(var c=b.wrappers.length,d=0;d<c;d++){var e=b.wrappers[d];if(e.stack.imageIds.length>0){var f=cornerstone.getViewport(e.element),g=!1;90!=f.rotation&&f.rotation!=-90&&270!=f.rotation&&f.rotation!=-270||(g=!0),"h"==a?g?f.vflip=!f.vflip:f.hflip=!f.hflip:g?f.hflip=!f.hflip:f.vflip=!f.vflip,cornerstone.setViewport(e.element,f)}}else for(var h=dvStruct.viewer.winArr,i=dvStruct.viewer.col*dvStruct.viewer.row,d=0;d<i;d++)for(var j=0,k=h[d].wrappers.length;j<k;j++){var e=h[d].wrappers[j];if(e.stack.imageIds.length>0){var f=cornerstone.getViewport(e.element),g=!1;90!=f.rotation&&f.rotation!=-90&&270!=f.rotation&&f.rotation!=-270||(g=!0),"h"==a?g?f.vflip=!f.vflip:f.hflip=!f.hflip:g?f.hflip=!f.hflip:f.vflip=!f.vflip,cornerstone.setViewport(e.element,f)}}},dvStruct.fun.goToIndex=function(a){var b=dvStruct.whereIsMouse;if(dvStruct.fun.elementPaging(b),dvStruct.fun.synPagingCheck(b),_.isObject(b))for(var c=0,d=b.col*b.row;c<d;c++){var e=b.wrappers[c],f=e.stack,d=f.imageIds.length,g=parseInt(d*a);if(d>0){g<=0?f.currentImageIdIndex=0:g>=d?f.currentImageIdIndex=d-1:f.currentImageIdIndex=g;var h=f.imageIds[f.currentImageIdIndex];cornerstone.loadImage(h).then(function(a){cornerstone.displayImage(e.element,a)})}}},dvStruct.fun.goToImgIndex=function(a,b){var c=dvStruct.viewer.getWinByNo(a);if(_.isObject(c))for(var d=0,e=c.col*c.row;d<e;d++){var f=c.wrappers[d],g=f.stack,e=g.imageIds.length;if(e>0){b<=0?g.currentImageIdIndex=0:b>=e?g.currentImageIdIndex=e-1:g.currentImageIdIndex=b;var h=g.imageIds[g.currentImageIdIndex];cornerstone.loadImage(h).then(function(a){cornerstone.displayImage(f.element,a)})}}dvStruct.fun.elementPaging(c,"aiState"),dvStruct.fun.synPagingCheck(c)},dvStruct.fun.drawAiResult=function(a,b,c){var d=dvStruct.viewer.getCheckedWin();if(d)for(var e=d.wrappers.length,f=0;f<e;f++){var g=d.wrappers[f];if(g.stack.imageIds.length>0){var h=g.stack,i=dvStruct.aiResult.series[a].data[b],j=$("[class='seriesWindow checked']").find(".lungResultBox");if(j.empty(),"0"==b)if(void 0!=i.result[h.currentImageIdIndex]&&i.result[h.currentImageIdIndex].length>0){var k=[];i.result[h.currentImageIdIndex].forEach(function(a,b){var c=a.location.split(","),d={x:c[0],y:c[1],radius:a.diameter};k.push(d);var e=' <div style="width: 100px;"><div>编号:a'+b+"</div><div>位置:("+c[0]+","+c[1]+")</div><div>直径:"+a.diameter+"</div><div>密度:"+a.density+"</div><div>概率:"+a.probability+"%</div></div>";j.append(e)}),j.show(),dvStruct.fun.drawCustomCircle(g.element,k,!1)}else dvStruct.fun.drawCustomCircle(g.element,[],!0),j.hide();else if("1"==b||"2"==b){if(void 0!=i.result[h.currentImageIdIndex]&&i.result[h.currentImageIdIndex].length>0){var l="";l="1"==b?"0"==i.result[h.currentImageIdIndex][0].hasDiabetics?"无糖":"有粮":"0"==i.result[h.currentImageIdIndex][0].diagnosisResult?"诊断正常":"诊断异常";var m=i.result[h.currentImageIdIndex][0].probability,n='<div style="width: 100px;"><div>结果:'+l+"</div> <div>概率:"+m+"%</div></div>";j.show(),j.append(n)}else j.hide();dvStruct.fun.drawCustomCircle(g.element,[],!0)}}}else alert("请选中处理窗口")},dvStruct.fun.drawCustomCircles=function(a,b){var c=dvStruct.viewer.getCheckedWin();if(c)for(var d=c.wrappers.length,e=0;e<d;e++){var f=c.wrappers[e];f.stack.imageIds.length>0&&dvStruct.fun.drawCustomCircle(f.element,a,b)}else alert("请选中处理窗口")},dvStruct.fun.drawCustomCircle=function(a,b,c){var d=cornerstone.getViewport(a);d&&(cornerstoneTools.lungNode.config.circles=b,cornerstoneTools.lungNode.tool.clearLungNodeData(a,"lungNode"),cornerstoneTools.lungNode.tool.addLungNodeData(a,b),c?cornerstoneTools.lungNode.tool.disable(a):cornerstoneTools.lungNode.tool.enable(a))};var renderer=new cornerstoneTools.stackRenderers.FusionRenderer;renderer.findImageFn=function(a,b){var c,d=1,e=cornerstone.metaData.get("imagePlaneModule",b),f=e.imagePositionPatient[2];return a.forEach(function(a){var b=cornerstone.metaData.get("imagePlaneModule",a),e=b.imagePositionPatient[2],g=Math.abs(e-f);g<d&&(d=g,c=a)}),c},dvStruct.fun.fusion=function(a,b,c,d){cornerstone.loadImage(b.imageIds[0]).then(function(d){cornerstone.displayImage(a,d),cornerstoneTools.addStackStateManager(a,["stack"]),cornerstoneTools.addToolState(a,"stack",b),cornerstoneTools.addToolState(a,"stack",c),cornerstoneTools.addToolState(a,"stackRenderer",renderer),renderer.render(a),cornerstoneTools.mouseInput.enable(a),cornerstoneTools.mouseWheelInput.enable(a),cornerstoneTools.wwwc.enable(a,1),cornerstoneTools.wwwc.activate(a,1),cornerstoneTools.pan.activate(a,2),cornerstoneTools.zoom.activate(a,4),cornerstoneTools.stackScrollWheel.activate(a),dvStruct.dragOpt.fusion.data.synchronizer.add(a)})},dvStruct.fun.fusionResize=function(){dvStruct.dragOpt.fusion.show&&$(".fusion-viewport").each(function(){var a=$(this).get(0);a&&(cornerstone.enable(a),cornerstoneTools.wwwc.activate(a,1),cornerstoneTools.pan.activate(a,2),cornerstoneTools.zoom.activate(a,4),cornerstone.resize(a))})},dvStruct.fun.changeFusion=function(a){var b=dvStruct.viewer.winArr[2],c=b.wrappers[0],d=(c.stack,c.element),e=cornerstone.getActiveLayer(d);e.viewport.colormap=a,cornerstone.updateImage(d)},$(function(){function a(a){var b=dvStruct.whereIsMouse;if(dvStruct.fun.elementPaging(b),dvStruct.fun.synPagingCheck(b),_.isObject(b))for(var c=0,d=b.col*b.row;c<d;c++){var e=b.wrappers[c],f=e.stack,d=f.imageIds.length,g=parseInt(d*a);if(d>0){g<=0?f.currentImageIdIndex=0:g>=d?f.currentImageIdIndex=d-1:f.currentImageIdIndex=g;var h=f.imageIds[f.currentImageIdIndex];cornerstone.loadImage(h).then(function(a){cornerstone.displayImage(e.element,a)})}}}var b=1;$(document).on("click",".playFirst",function(b){var c=parseInt($(".seriesWindow.seriesCheck").attr("no"));dvStruct.fun.stopCurrent(c),a(0),dvStruct.fun.play()}),$(document).on("click",".playLast",function(b){var c=parseInt($(".seriesWindow.seriesCheck").attr("no"));dvStruct.fun.stopCurrent(c),a(1),dvStruct.fun.play()}),$(document).on("click",".playFast",function(a){b+=1,b>100&&(b=100),dvStruct.playSpeed=parseInt(b);var c=parseInt($(".seriesWindow.seriesCheck").attr("no"));dvStruct.fun.stopCurrent(c),dvStruct.fun.play(),$(".speedTxt").text("fps:"+dvStruct.playSpeed)}),$(document).on("click",".playSlow",function(a){b-=1,b<1&&(b=1),dvStruct.playSpeed=parseInt(b);var c=parseInt($(".seriesWindow.seriesCheck").attr("no"));dvStruct.fun.stopCurrent(c),dvStruct.fun.play(),$(".speedTxt").text("fps:"+dvStruct.playSpeed)}),$(document).on("click",".playStart",function(a){$(".speedTxt").text("fps:"+dvStruct.playSpeed),dvStruct.fun.play(),$(".seriesWindow.seriesCheck").find(".playStop").show(),$(".seriesWindow.seriesCheck").find(".playStart").hide(),$(".js-play").hide(),$(".js-stop").show()}),$(document).on("click",".playStop",function(a){var b=parseInt($(".seriesWindow.seriesCheck").attr("no"));dvStruct.fun.stopCurrent(b),$(".seriesWindow.seriesCheck").find(".playStop").hide(),$(".seriesWindow.seriesCheck").find(".playStart").show(),$(".js-play").show(),$(".js-stop").hide()})}),dvStruct||(dvStruct={}),dvStruct.viewer||(dvStruct.viewer={}),dvStruct.fun||(dvStruct.fun={}),dvStruct.viewer.btnStates={arrowAnnotate:{enable:0,type:0},wwwc:{enable:0,type:0},wwwcRegion:{enable:0,type:0},pan:{enable:0,type:0},zoom:{enable:0,type:0},magnify:{enable:0,type:1},magnifyTouchDrag:{enable:0,type:1},rotate:{enable:0,type:0},probe:{enable:0,type:0},length:{enable:0,type:0},heartScale:{enable:0,type:0},deviation:{enable:0,type:0},ellipticalRoi:{enable:0,type:0},rectangleRoi:{enable:0,type:0},freehand:{enable:0,type:0},angle:{enable:0,type:0},simpleAngle:{enable:0,type:0},referenceLines:{enable:!1},eraser:{enable:0,type:1}},dvStruct.viewer.leftBtnDisable=function(){disableAllTools(1);for(var a in dvStruct.viewer.btnStates)dvStruct.viewer.btnStates[a].type&&1==dvStruct.viewer.btnStates[a].type&&(dvStruct.viewer.btnStates[a].enable=0)},dvStruct.viewer.middleBtnDisable=function(){disableAllTools(2);for(var a in dvStruct.viewer.btnStates)dvStruct.viewer.btnStates[a].type&&2==dvStruct.viewer.btnStates[a].type&&(dvStruct.viewer.btnStates[a].enable=0)},dvStruct.viewer.rightBtnDisable=function(){disableAllTools(4);for(var a in dvStruct.viewer.btnStates)dvStruct.viewer.btnStates[a].type&&4==dvStruct.viewer.btnStates[a].type&&(dvStruct.viewer.btnStates[a].enable=0)},dvStruct.fun.disableTools=function(a,b){a&&(b||(b=1),cornerstoneTools.arrowAnnotate.deactivate(a,b),cornerstoneTools.arrowAnnotateTouch.deactivate(a),cornerstoneTools.wwwc.deactivate(a,b),cornerstoneTools.wwwcRegion.deactivate(a,b),cornerstoneTools.pan.deactivate(a,b),cornerstoneTools.zoom.deactivate(a,b),cornerstoneTools.rotate.deactivate(a,b),cornerstoneTools.probe.deactivate(a,b),cornerstoneTools.length.deactivate(a,b),cornerstoneTools.eraser.deactivate(a,b),cornerstoneTools.ellipticalRoi.deactivate(a,b),cornerstoneTools.rectangleRoi.deactivate(a,b),cornerstoneTools.simpleAngle.deactivate(a,b),cornerstoneTools.simpleAngleTouch.deactivate(a,b),cornerstoneTools.heartScale.deactivate(a,b),cornerstoneTools.deviation.deactivate(a,b),cornerstoneTools.freehand.deactivate(a,b),cornerstoneTools.magnify.deactivate(a,b),cornerstoneTools.magnifyTouchDrag.deactivate(a,b))},dvStruct.fun.checkAndSetActive1=function(a){cornerstoneTools.mouseInput.enable(a);for(var b in dvStruct.viewer.btnStates){var c=dvStruct.viewer.btnStates[b].type;dvStruct.viewer.btnStates[b].enable?"referenceLines"==b?cornerstoneTools.referenceLines.tool.enable(a,synchronizer):cornerstoneTools[b]&&cornerstoneTools[b].activate(a,c):"referenceLines"==b?cornerstoneTools.referenceLines.tool.disable(a,synchronizer):cornerstoneTools[b]&&cornerstoneTools[b].deactivate(a,c)}},(dvStruct.viewer.getBtnDiy=function(){if("undefined"!=localStorage.getItem("btnDiyStat")&&localStorage.getItem("btnDiyStat")){var a=JSON.parse(localStorage.getItem("btnDiyStat")),b=!1;a["default"]||(a["default"]={enable:0,type:0,cls:"js-default"}),a.wwwc||(a.wwwc={enable:0,type:0,cls:"wwwc"}),a.wwwcRegion||(a.wwwc={enable:0,type:0,cls:"wwwcRegion"}),a.pan||(a.pan={enable:0,type:0,cls:"pan"}),a.zoom||(a.zoom={enable:0,type:0,cls:"zoom"}),a.zoom||(a.zoom={enable:0,type:0,cls:"magnify"}),a.probe||(a.probe={enable:0,type:0,cls:"probe"}),a.probeUnSave||(a.probeUnSave={enable:0,type:0,cls:"probeUnSave"}),a.length||(a.length={enable:0,type:0,cls:"length"}),a.crossRotation||(a.crossRotation={enable:0,type:0,cls:"crossRotation"}),a.heartScale||(a.heartScale={enable:0,type:0,cls:"heartScale"}),a.deviation||(a.deviation={enable:0,type:0,cls:"deviation"}),a.ellipticalRoi||(a.ellipticalRoi={enable:0,type:0,cls:"ellipticalRoi"}),a.rectangleRoi||(a.rectangleRoi={enable:0,type:0,cls:"rectangleRoi"}),a.freehand||(a.freehand={enable:0,type:0,cls:"freehand"}),a.angle||(a.angle={enable:0,type:0,cls:"angle"}),a.arrowAnnotate||(a.arrowAnnotate={enable:0,type:0,cls:"arrowAnnotate"}),a.simpleAngle||(a.sampleAngle={enable:0,type:0,cls:"simpleAngle"}),b&&localStorage.setItem("btnDiyStat",JSON.stringify(a))}else localStorage.setItem("btnDiyStat",JSON.stringify({"default":{enable:1,type:4,cls:"js-default"},arrowAnnotate:{enable:1,type:1,cls:"arrowAnnotate"},wwwc:{enable:1,type:1,cls:"wwwc"},pan:{enable:0,type:0,cls:"pan"},zoom:{enable:0,type:0,cls:"zoom"},magnify:{enable:0,type:0,cls:"magnify"},probe:{enable:0,type:0,cls:"probe"},probeUnSave:{enable:0,type:0,cls:"probeUnSave"},length:{enable:0,type:0,cls:"length"},heartScale:{enable:0,type:0,cls:"heartScale"},deviation:{enable:0,type:0,cls:"deviation"},crossRotation:{enable:0,type:0,cls:"crossRotation"},ellipticalRoi:{enable:0,type:0,cls:"ellipticalRoi"},rectangleRoi:{enable:0,type:0,cls:"rectangleRoi"},angle:{enable:0,type:0,cls:"angle"},simpleAngle:{enable:0,type:0,cls:"simpleAngle"}}));return JSON.parse(localStorage.getItem("btnDiyStat"))})(),dvStruct.viewer.initBtnDiy=function(){var a=dvStruct.viewer.getBtnDiy();$(".js-topPannel .btnArea").removeClass("leftBtnActive").removeClass("rightBtnActive").removeClass("middleBtnActive");for(var b in a)if(a[b].enable){for(var c in dvStruct.viewer.btnStates)b==c&&(dvStruct.viewer.btnStates[c].type=a[b].type,dvStruct.viewer.btnStates[c].enable=a[b].enable);switch(a[b].type){case 1:$("."+a[b].cls).addClass("leftBtnActive");break;case 2:$("."+a[b].cls).addClass("middleBtnActive");break;case 4:$("."+a[b].cls).addClass("rightBtnActive")}}},dvStruct.viewer.saveDiyStat=function(a,b){var c=dvStruct.viewer.getBtnDiy();for(var d in c)c[d].type==b&&(c[d].type=0,c[d].enable=0),c[d].cls==a&&(c[d].type=b,c[d].enable=1);localStorage.setItem("btnDiyStat",JSON.stringify(c))};var dvStruct=dvStruct||{};dvStruct.dragToCanv={seriesId:void 0,seriesLength:0,imageId:void 0,multipiece:!1,clear:function(){var a=dvStruct.dragToCanv;a.seriesId=void 0;var b=a.getDiv();$(b).css("visibility","hidden")},pos:{top:0,left:0,x:0,y:0,lastX:0,lastY:0},divSize:{w:0,h:0},on:function(a,b,c,d){if(a.length>0){var e=a[0].imageId,f=a[0].seriesId,g=a[0].studyId,h=dvStruct.findSeries(f);dvStruct.dragToCanv.imageId=e;var i=dvStruct.dragToCanv;i.multipiece=d,i.seriesId=f,i.dragArr=a,i.studyId=g,i.seriesLength=h.dicomArr.length;var j=i.getDiv();$(j).width();i.pos.top=b.top,i.pos.left=b.left,i.pos.x=c.pageX,i.pos.y=c.pageY,i.pos.lastX=i.pos.x,i.pos.lastY=i.pos.y,$(j).css({top:b.top+"px",left:b.left+"px"}),$(j).css("visibility","visible"),dvStruct.dragToCanv.drawDiv(e,f),i.dragOn()}},getDiv:function(){var a;return function(){return a||function(){var b='<div style="visibility: hidden" id="js-dragToCanvDiv" class="dragToCanvDiv"></div>';$(document.body).append(b),a=document.getElementById("js-dragToCanvDiv");var c=dvStruct.dragToCanv,d=c.divSize;return d.w=$(a).outerWidth(),d.h=$(a).outerHeight(),a}()}}(),drawDiv:function(a,b){var c=$("#js-dragToCanvDiv").get(0);if(void 0!=a&&(cornerstone.disable(c),cornerstone.enable(c),cornerstoneTools.mouseInput.enable(c),cornerstone.loadImage(a).then(function(a){cornerstone.displayImage(c,a)}),dvStruct.dragOpt.mpr.show)){var d=dvStruct.viewer.findOriInfoByIds(a,b);mprLoadSeries(b,d)}},dragOn:function(){$(document.body).on("mousemove",function(a){var b=a.pageX,c=a.pageY,d=dvStruct.dragToCanv.pos,e=dvStruct.dragToCanv.getDiv();$(e).css({top:c-$(e).height()-10+"px",left:b-$(e).width()-10+"px"}),d.lastX=b,d.lastY=c}),$(document.body).on("mouseup mouseleave",function(a){try{$(document.body).off("mouseleave"),$(document.body).off("mousemove"),$(document.body).off("mouseup");var b=dvStruct.dragToCanv;if(dvStruct.dragOpt.viewer.show){var c=b.checkOn(a);c&&dvStruct.viewer.bindSeries(c,dvStruct.dragToCanv.seriesId,dvStruct.dragToCanv.seriesLength,!b.multipiece&&b.imageId)}else if(dvStruct.dragOpt.mpr.show)mprLoadSeries(dvStruct.dragToCanv.seriesId);else if(dvStruct.dragOpt.print.show){var d=a.target.id||$(a.target).parents(".atom").attr("id")||$(a.target).parents(".join-img-box").attr("id");d.indexOf("atom")>=0?(darg2atom(d,dvStruct.dragToCanv),$(".series-scan-check").removeClass("series-scan-check"),$(".instance-scan-check").removeClass("instance-scan-check")):d.indexOf("joinImgBox")>=0&&dragIn(dvStruct.dragToCanv.imageId,dvStruct.dragToCanv.seriesId)}else if(dvStruct.dragOpt.fusion.show){var e=a.target.id||$(a.target).parents(".src-box").attr("id");if("ctBox"==e){var f={imageIds:[],currentImageIdIndex:0,options:{opacity:.5,visible:!0,name:"CT"}};dvStruct.dragOpt.fusion.data.ctSrc=b.dragArr,b.dragArr.forEach(function(a){f.imageIds.push(a.imageId)}),dvStruct.dragOpt.fusion.data.ctStack=f;var g=$(".ct-box .fusion-viewport").get(0);cornerstone.disable(g),cornerstone.enable(g),cornerstone.loadImage(f.imageIds[0]).then(function(a){cornerstone.displayImage(g,a),cornerstoneTools.mouseInput.enable(g),cornerstoneTools.mouseWheelInput.enable(g),cornerstoneTools.wwwc.activate(g,1),cornerstoneTools.stackScrollWheel.activate(g),cornerstoneTools.addStackStateManager(g,["stack"]),cornerstoneTools.addToolState(g,"stack",f),cornerstoneTools.addToolState(g,"stack",h),dvStruct.dragOpt.fusion.data.synchronizer.add(g)})}else if("petBox"==e){var h={imageIds:[],currentImageIdIndex:0,options:{opacity:.7,visible:!0,viewport:{colormap:"jet",voi:{windowWidth:1600,windowCenter:500}},name:"PET"}};b.dragArr.forEach(function(a){h.imageIds.push(a.imageId)}),dvStruct.dragOpt.fusion.data.petStack=h,dvStruct.dragOpt.fusion.data.petSrc=b.dragArr;var i=$(".pet-box .fusion-viewport").get(0);cornerstone.disable(i),cornerstone.enable(i),cornerstone.loadImage(h.imageIds[0]).then(function(a){cornerstone.displayImage(i,a),cornerstoneTools.mouseInput.enable(i),cornerstoneTools.mouseWheelInput.enable(i),cornerstoneTools.wwwc.activate(i,1),cornerstoneTools.stackScrollWheel.activate(i),cornerstoneTools.addStackStateManager(i,["stack"]),cornerstoneTools.addToolState(i,"stack",h),cornerstoneTools.addToolState(i,"stack",f),dvStruct.dragOpt.fusion.data.synchronizer.add(i)})}if(dvStruct.dragOpt.fusion.data.petSrc.length>0&&dvStruct.dragOpt.fusion.data.ctSrc.length>0){var j=$(".fusion-result-box .fusion-viewport").get(0);cornerstone.enable(j),dvStruct.fun.fusion(j,dvStruct.dragOpt.fusion.data.ctStack,dvStruct.dragOpt.fusion.data.petStack,"jet")}}b.clear()}catch(a){b.clear()}})},checkOn:function(a){var b=dvStruct.dragToCanv.pos;if(Math.abs(b.lastX-b.x)<4&&Math.abs(b.lastY-b.y)<4){var c=dvStruct.viewer.getCheckedWin();if(c)return c}else{var d=dvStruct.dragToCanv.getDiv(),e=$(d).offset(),f=$(d).outerWidth(),g=$(d).outerHeight(),h=e.left,i=e.top,j=e.left+f,k=e.top+g,l=(h+j)/2,m=(i+k)/2,n=getTargetStd(l,m);if(n.studyNo!=-1)return dvStruct.viewer.getWinByNo(n.winNo)}}};var hotKeyMap=new Array;hotKeyMap.joinDirect="blank",hotKeyMap.rapidWwwc="blank",hotKeyMap.shiftDown=null,hotKeyMap.ctrlDown=null,hotKeyMap.altDown=null,hotKeyMap.pageChange="current",hotKeyMap.imageChange=null,$(function(){document.onkeydown=function(a){var b=a||window.event||arguments.callee.caller.arguments[0],c=null;dvStruct.dragOpt.print.join.show&&((b.shiftKey&&37==b.keyCode||b.shiftKey&&65==b.keyCode)&&(hotKeyMap.direct="left",c="joinDirect"),(b.shiftKey&&38==b.keyCode||b.shiftKey&&87==b.keyCode)&&(hotKeyMap.direct="up",c="joinDirect"),(b.shiftKey&&39==b.keyCode||b.shiftKey&&68==b.keyCode)&&(hotKeyMap.direct="right",c="joinDirect"),(b.shiftKey&&40==b.keyCode||b.shiftKey&&83==b.keyCode)&&(hotKeyMap.direct="down",c="joinDirect")),(dvStruct.dragOpt.print.show||dvStruct.dragOpt.mpr.show||dvStruct.dragOpt.viewer.show)&&((b.altKey&&48==b.keyCode||b.altKey&&96==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+0",c="rapidWwwc"),(b.altKey&&49==b.keyCode||b.altKey&&97==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+1",c="rapidWwwc"),(b.altKey&&50==b.keyCode||b.altKey&&98==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+2",c="rapidWwwc"),(b.altKey&&51==b.keyCode||b.altKey&&99==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+3",c="rapidWwwc"),(b.altKey&&52==b.keyCode||b.altKey&&100==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+4",c="rapidWwwc"),(b.altKey&&53==b.keyCode||b.altKey&&101==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+5",c="rapidWwwc"),(b.altKey&&54==b.keyCode||b.altKey&&102==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+6",c="rapidWwwc"),(b.altKey&&55==b.keyCode||b.altKey&&103==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+7",c="rapidWwwc"),(b.altKey&&56==b.keyCode||b.altKey&&104==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+8",c="rapidWwwc"),(b.altKey&&57==b.keyCode||b.altKey&&105==b.keyCode)&&(hotKeyMap.rapidWwwc="Alt+9",c="rapidWwwc"),33==b.keyCode||38==b.keyCode?(hotKeyMap.imageChange="prev",c="imageChange"):34!=b.keyCode&&40!=b.keyCode||(hotKeyMap.imageChange="next",c="imageChange"),37==b.keyCode?(hotKeyMap.changeWwwc="ww",c="changeWwwc"):39==b.keyCode&&(hotKeyMap.changeWwwc="wc",c="changeWwwc")),dvStruct.dragOpt.print.show&&!dvStruct.dragOpt.print.join.show?b.shiftKey&&16==b.keyCode||b.ctrlKey&&17==b.keyCode||b.altKey&&18==b.keyCode?(hotKeyMap.shiftDown=!!b.shiftKey,hotKeyMap.ctrlDown=!!b.ctrlKey,hotKeyMap.altDown=!!b.altKey,c="printMultiSelec"):33==b.keyCode||38==b.keyCode?(c="layoutChange",$("input[type=text][name=layout-rows]").is(":focus")?hotKeyMap.layoutChange={name:"rows",action:"add"}:$("input[type=text][name=layout-cols]").is(":focus")?hotKeyMap.layoutChange={name:"cols",action:"add"}:(hotKeyMap.pageChange="prev",c="pageChange")):34==b.keyCode||40==b.keyCode?(c="layoutChange",$("input[type=text][name=layout-rows]").is(":focus")?hotKeyMap.layoutChange={name:"rows",action:"minus"}:$("input[type=text][name=layout-cols]").is(":focus")?hotKeyMap.layoutChange={name:"cols",action:"minus"}:(hotKeyMap.pageChange="next",c="pageChange")):37==b.keyCode?(hotKeyMap.layout="rows",c="layout"):39==b.keyCode&&(hotKeyMap.layout="cols",c="layout"):(hotKeyMap.shiftDown=!1,hotKeyMap.ctrlDown=!1,hotKeyMap.altDown=!1),responseHotKey(c)},document.onkeyup=function(a){var b=a||window.event||arguments.callee.caller.arguments[0];hotKeyMap.shiftDown=!!b.shiftKey,hotKeyMap.ctrlDown=!!b.ctrlKey,hotKeyMap.altDown=!!b.altKey}}),$(function(){$(".drag-box-4 .drag").each(function(a){$(this).myDrag({randomPosition:!0,direction:"all",handler:".handler"})})});