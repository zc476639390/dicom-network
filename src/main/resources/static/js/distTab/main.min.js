/*!ipacs4.0 - 1.0.0-2021-06-22 */
function initWebEngine(){new AjaxRequest({type:"get",url:"dicom/getByStudyId",param:{studyId:commonStudyId},isShowLoader:!0,dataType:"",callBack:function(a){200==a.status?($(".jpg-thumbnail-container").find(".thumbnail").empty(),$(".dicom-thumbnail-container").find(".thumbnail").empty(),ViewerTab=new ViewerTab(a,engineConfig)):alert(a.msg)}})}$(function(){function a(){$(".dicom-thumbnail-container").find(".series-img-box").each(function(){var a=$(this).get(0);cornerstone.resize(a)})}$(".show-jpg").on("touchstart",function(){$(".jpg-viewer").show().siblings().hide();new Swiper(".jpg-img-container",{pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},onSlideChangeEnd:function(){return!1}})}),$(".hide-jpg,.hide-mpr,.mpr-hide").on("touchstart",function(){$(".main-menu").show(),$(".dicom-viewer").show().siblings().hide(),a()}),$(".show-mpr").on("touchstart",function(){$(".main-menu").hide(),ViewerTab.activeWin=ViewerTab.viewer.getActiveWin();var a=ViewerTab.activeWin.series.seriesId;ViewerTab.series.loadDelayDcm(a,function(){var b=ViewerTab.series.findSeries(a),c=b.dicomArr;$(".mpr-viewer").show().siblings().hide(),mprLoadSeries(c)})}),$(".show-default").on("touchstart",function(){ViewerTab.tools.setAllElement(function(a){cornerstone.reset(a)})}),$(".menu-btn").on("touchstart",function(){$(this).hasClass("menu-btn-check")?$(this).removeClass("menu-btn-check"):$(this).addClass("menu-btn-check").siblings().removeClass("menu-btn-check");var b=$(this).attr("data-box");if("order"==b){$(".series-preview-dcm").width(),$(".dicom-thumbnail-container").width();$(".second-menu-box").hide();var c=$(".thumbnail-container");c.each(function(){$(this).parent(".viewer").is(":visible")&&($(this).is(":hidden")?($(this).show(),a()):$(this).hide())})}else{var c=$(".thumbnail-container");c.each(function(){$(this).parent(".viewer").is(":visible")&&$(this).is(":visible")&&$(this).hide()})}if("measure"==b||"tool"==b||"more"==b||"tiaochuang"==b){var d=$(".second-menu-box");d.is(":hidden")||$(".second-menu-box").find("."+b).is(":hidden")?(d.show(),$(".second-menu-box").find("."+b).addClass("second-menu-check").siblings().removeClass("second-menu-check")):d.hide(),"tiaochuang"==b&&$(".second-menu-box").find("."+b).removeClass("second-menu-check")}});new Swiper(".swiper-container-dcm",{slidesPerView:"auto",freeMode:!0,initialSlide:0,observer:!0,observeParents:!0});$(".menu-btn").on("touchstart",function(){var a=$(this).attr("data-box");if("tiaochuang"==a||"order"==a||"more"==a)ViewerTab.tools.setAllElement(function(a){cornerstoneTools.wwwcTouchDrag.activate(a),ViewerTab.tools.toolsState.forEach(function(b){cornerstoneTools[b].deactivate(a)})});else if("measure"==a||"tool"==a){var b=$(".second-menu-check").find(".tool-btn-check").attr("data-box");ViewerTab.tools.setAllElement(function(a){cornerstoneTools.wwwcTouchDrag.deactivate(a),ViewerTab.tools.toolsState.forEach(function(c){b==c?cornerstoneTools[c].activate(a):cornerstoneTools[c].deactivate(a)})})}}),$(".tool-btn").on("touchstart",function(){var a=this,b=$(this).attr("data-box");"referenceLine"==b&&($(a).hasClass("tool-btn-check")?($(a).removeClass("tool-btn-check"),ViewerTab.tools.setAllElement(function(a){ViewerTab.tools.synchronizer.remove(a)})):($(a).addClass("tool-btn-check"),ViewerTab.tools.setAllElement(function(a){ViewerTab.tools.synchronizer.add(a)})),ViewerTab.tools.setAllElement(function(a){ViewerTab.tools.referenceLine(a,!0)})),($(this).hasClass("measure-tool")||$(this).hasClass("operate-tool"))&&ViewerTab.tools.setAllElement(function(c){cornerstoneTools.touchInput.enable(c),"clear"==b?(cornerstoneTools.clearToolState(c,"probe"),cornerstoneTools.clearToolState(c,"length"),cornerstoneTools.clearToolState(c,"angle"),cornerstoneTools.clearToolState(c,"rectangleRoi"),cornerstoneTools.clearToolState(c,"ellipticalRoi"),cornerstone.updateImage(c)):"reset"==b?cornerstone.reset(c):($(a).addClass("tool-btn-check").siblings().removeClass("tool-btn-check"),ViewerTab.tools.toolsState.forEach(function(a){a==b?cornerstoneTools[a].activate(c):cornerstoneTools[a].deactivate(c)}))})}),$(".layout").on("touchstart",function(){$(this).addClass("layout-check").siblings().removeClass("layout-check");var a=$(this).attr("data-row"),b=$(this).attr("data-col"),c=100/b,d=100/a;ViewerTab.viewer.winCount=b*a,ViewerTab.viewer.winIndex=b*a,$(".wrapper").css({height:c+"%",width:d+"%"}),$(".viewport").each(function(){var a=$(this).get(0);cornerstone.resize(a)})}),$(".start,.stop").on("touchstart",function(){$(this).hide().siblings().show(),$(this).hasClass("start")?ViewerTab.tools.play(ViewerTab.activeWin):ViewerTab.tools.stop(ViewerTab.activeWin)}),$(".speed").on("touchstart",function(){$(this).addClass("speed-active")}).on("touchend",function(){$(this).removeClass("speed-active")}),$(".js-slow").on("touchstart",function(){ViewerTab.activeWin||(ViewerTab.activeWin=ViewerTab.viewer.getActiveWin()),ViewerTab.tools.prevPage(ViewerTab.activeWin),BtnController.goToIndex(ViewerTab.activeWin.stack.currentImageIdIndex,ViewerTab.activeWin.stack.imageIds.length)}).on("touchend",function(){}),$(".js-fast").on("touchstart",function(){ViewerTab.activeWin||(ViewerTab.activeWin=ViewerTab.viewer.getActiveWin()),ViewerTab.tools.nextPage(ViewerTab.activeWin),BtnController.goToIndex(ViewerTab.activeWin.stack.currentImageIdIndex,ViewerTab.activeWin.stack.imageIds.length)}).on("touchend",function(){});var b,c,d,e,f,g,h,i;$(".rectBox").on("touchstart",function(a){b=a.originalEvent.changedTouches[0].pageX,c=a.originalEvent.changedTouches[0].pageY;var d=$(".rectBox").css("left");h=parseInt(d.substring(0,d.length-2)),i=$(".scrollBar").width()-$(".rectBox").width()+1}),$(".rectBox").on("touchmove",function(a){d=a.originalEvent.changedTouches[0].pageX,e=a.originalEvent.changedTouches[0].pageY,f=d-b,g=e-c;var j=h+f;j<-1&&(j=-1),j>i&&(j=i),$(".rectBox").css("left",j+"px");var k=Math.abs(j/i);k=k>1?1:k,ViewerTab.activeWin=ViewerTab.viewer.getActiveWin(),ViewerTab.tools.goToIndex(ViewerTab.activeWin,k),Math.abs(f)>Math.abs(g)&&f>0}),$(".wrapper").on("touchstart",function(){$(this).addClass("wrapper-check").siblings().removeClass("wrapper-check"),ViewerTab.activeWin=ViewerTab.viewer.getActiveWin(),BtnController.goToIndex(ViewerTab.activeWin.stack.currentImageIdIndex,ViewerTab.activeWin.stack.imageIds.length),$(".more-tool[data-box='referenceLine']").hasClass("tool-btn-check")&&(ViewerTab.tools.setAllElement(function(a){ViewerTab.tools.synchronizer.add(a)}),ViewerTab.tools.setAllElement(function(a){ViewerTab.tools.referenceLine(a,!0)}))}),$(document).on("click",".unlock",function(){var a=$(this),b=a.parent().find(".locked-image").text();a.parent().find(".unlock-state").text("解锁中！"),a.hide(),new AjaxRequest({type:"GET",url:"dicom/unlockImage",param:{studyId:b},isShowLoader:!0,dataType:"",callBack:function(b){200==b.status&&a.parent().find(".unlock-state").text("解锁成功，请稍后刷新页面重新加载数据！")},errorBack:function(b){a.parent().find(".unlock-state").text(b.msg+",解锁失败！"),a.show()}})}),$(".load-alert").click(function(){$(".load-tips-box").show()}),$(".close-load-tips").click(function(){$(".load-tips-box").hide()}),$(".load-again").click(function(a){$(".cross-origin-box").find(".item").each(function(a,b){$(this).click()})})});var commonStudyId=GetUrlParam("studyId"),ViewerTab;BtnController={showPlay:function(a){a?($(".start").show().siblings().hide(),$(".start").attr("state",!1)):($(".stop").show().siblings().hide(),$(".start").attr("state",!0))},goToIndex:function(a,b){var c=a/b,d=$(".scroll-line").width()-$(".rectBox").width(),e=d*c;$(".rectBox").css("left",e+"px")}};var toolbarObj,ViewerTab=function(a,b){"use strict";function c(a,b,c,e){var f=c.name.lastIndexOf("."),g=c.name.substring(f,c.name.length);if(".zip"!=g.toLowerCase()){var h=a+"."+c.name,i=b.file(c.name).async("uint8array");i.then(function(a){var b="byteArray:"+h;cornerstone.loadByteArrayImage(b,a).then(function(a){console.log("imageId",b);var c=guid(8,"sign");o.imageObjArr[b]=a;var d=p.getDicomInfo(a.data),e=s.findSeries(d.UIDS.SeriesUID.val),f=1;e&&(f=e.dicomArr.length+1);var g={studyId:commonStudyId,studyDateTime:d.StudyInfo.StudyDate.val+d.StudyInfo.StudyTime.val,seriesNo:d.SeriesInfo.SeriesNo.val,seriesId:d.UIDS.SeriesUID.val,url:h,index:parseInt(d.SeriesInfo.SeriesNo.val),imageType:"dicom",signId:c,isSign:!1,instanceNo:parseInt(d.InstanceInfo.InstanceNumber.val),imageId:b,totalCount:f,detail:{urlMode:!0}};d.signId=c,d.isSign=!1,d.studyId=commonStudyId;var i={dataSet:a.data,infoSet:d,imageId:b,instanceNo:parseInt(d.InstanceInfo.InstanceNumber.val),signId:c,imageType:"dicom"};s.addDcm(i,g)})["catch"](function(a){console.log("zip中包含非法文件"+c.name)})})}else d(c,e)}function d(a,b){var d=new JSZip,e=d.loadAsync(a._data.compressedContent);e.then(function(a){for(var d in a.files){var e=a.files[d];e.dir||c(a,e,b)}})}function e(a){var b=$.Deferred(),d=new XMLHttpRequest;return d.open("get",a,!0),d.responseType="arraybuffer",d.onreadystatechange=function(e){if(4===d.readyState)if(200===d.status){var f=d.response,h=a.split("/"),j=(h[h.length-1],{}),k=new JSZip,l=k.loadAsync(f);l.then(function(b){for(var d in b.files){var e=b.files[d];e.dir||c(a,b,e,j)}})["catch"](function(c){var e={studyId:commonStudyId,studyDateTime:new Date,seriesNo:0,seriesId:new Date,url:a,imageType:"dicom",signId:0,isSign:!1,instanceNo:0,index:0,imageId:a,totalCount:1,detail:{urlMode:!0}};g(e).then(function(a){a.isSuccess||(a.hasOwnProperty("statusText")&&i(a),b.reject(d.response))})["catch"](function(a){b.reject(d.response)})})}else"Forbidden"==d.statusText,b.reject(d.response)},d.onprogress=function(a){if(a.lengthComputable){var b=a.loaded,c=a.total;Math.round(b/c*100)}},d.send(),b.promise()}function f(a){var b=p.verify(a.msg);if(b.state){r.initWinArr(),$(".series-preview-home").empty();var c=a.data.data,d=a.data.fileType,f={total:0,initData:[],leftData:[]};c&&Array.isArray(c)?(f.total+=c.length,c.forEach(function(a,b){if(d&&"zip"==d)e(a);else{var c={studyId:"",studyDateTime:new Date,seriesNo:0,seriesId:new Date,url:a,imageType:"dicom",signId:b,isSign:!1,instanceNo:b,index:b,imageId:a,totalCount:1,detail:{urlMode:!0}};g(c).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)})}})):c&&"object"==typeof c&&Object.keys(c).forEach(function(a){Object.keys(c[a]).forEach(function(b){Object.keys(c[a][b]).forEach(function(d){c[a][b][d].forEach(function(e,j){var k={seriesCode:a+" "+b+" "+d,studyId:a,studyDateTime:b,seriesNo:d,seriesId:e.seriesId,url:e.url,imageType:e.imageType,signId:e.id,isSign:1==e.flag,inatanceNo:j,imageId:e.url,seriesLen:c[a][b][d].length,detail:{urlMode:!1}};"dicom"==e.imageType&&(j<q?g(k).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)}):s.addDelayDcm(k),0==j?(f.initData.push(k),f.total+=c[a][b][d].length):j>0&&j<q?f.leftData.push(k):s.addDelayDcm(k)),"jpg"==e.imageType&&(0==j&&(f.total+=c[a][b][d].length),h(k).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)}))})})})})}else jqalert({title:"提示",content:b.text,yestext:"确定",notext:"取消"})}function g(a){var b=new Promise(function(b,c){cornerstoneWADOImageLoader.wadouri.dataSetCacheManager.load(a.url,cornerstoneWADOImageLoader.internal.xhrRequest).then(function(c){var d=c.intString("x00280008");if(!d||d<2){var e="wadouri:"+a.url;cornerstone.loadAndCacheImage(e).then(function(c){if(n.isObject(c)&&n.isObject(c.data)){o.imageObjArr[e]=c;var d=p.getDicomInfo(c.data);d.signId=a.signId,d.isSign=a.isSign;var f={dataSet:c.data,infoSet:d,imageId:c.imageId,instanceNo:d.InstanceInfo.InstanceNumber.val,signId:a.signId,imageType:a.imageType};a.instanceNo=d.InstanceInfo.InstanceNumber.val,""!=d.SeriesInfo.SeriesNo.val&&(a.seriesNo=d.SeriesInfo.SeriesNo.val),1==a.detail.urlMode&&(a.seriesId=d.UIDS.SeriesUID.val,a.studyDateTime=d.StudyInfo.StudyDate.val+d.StudyInfo.StudyTime.val,a.studyId=d.UIDS.StudyUID.val),a.image=c,s.addDcm(f,a),b({isSuccess:!0,data:a,e:null})}else b({isSuccess:!1,txt:"图像解析后有误",image:c,data:a})})["catch"](function(c){b({isSuccess:!1,txt:"图像加载解析报错",error:c,data:a})})}else{for(var f=c.intString("x00180040"),g=[],h="wadouri:"+a.url,i=0;i<d;i++){var e=h+"?frame="+i;g.push(e)}var j={currentImageIdIndex:0,imageIds:g};g.forEach(function(c){cornerstone.loadAndCacheImage(c).then(function(d){cornerstoneWADOImageLoader.wadors.metaDataManager.add(c,d),d.stack=j,d.cineRate=f,o.imageObjArr[c]=d;var e=p.getDicomInfo(d.data);e.signId=a.signId,e.isSign=a.isSign;var g={stack:j,dataSet:d.data,infoSet:e,imageId:d.imageId,instanceNo:e.InstanceInfo.InstanceNumber.val};a.image=d,""!=e.SeriesInfo.SeriesNo.val&&(a.seriesNo=e.SeriesInfo.SeriesNo.val),s.addDcm(g,a),b({isSuccess:!0,data:a,e:null})},function(c){b({isSuccess:!1,txt:"多帧加载问题",error:c,data:a})})})}})["catch"](function(c){b({isSuccess:!1,txt:"图像资源访问失败",error:c,data:a,statusText:c.statusText})})});return b}function h(a){var b=new Promise(function(b,c){var d=new XMLHttpRequest;d.responseType="arraybuffer",d.onreadystatechange=function(c){4==d.readyState&&0!=d.status&&b({isSuccess:!1,txt:"jpg加载问题",xhr:d,data:a,statusText:d.statusText})},d.open("get",a.url,!0),d.send(),$(".show-jpg").show(),s.addJpg(a),b({isSuccess:!0,data:a,e:null,xhr:d})});return b}function i(a){if($(".load-alert").show(),!a.isSuccess){var b=a.data;switch(a.statusText){case"Not Found":$(".not-exit-box").show();var c='  <div class="item"><div  class="txt">URL:</div><div class=" val locked-image"  >'+b.url+"</div> </div>";$(".not-exit-box .item-box").append(c);break;case"Forbidden":if($('div[lockedId="'+b.studyId+'"]').length<1){var c='  <div class="item"><div  class="txt">检查号:</div><div class=" val locked-image" lockedId="'+b.studyId+'">'+b.studyId+'</div><div class="unlock">解锁</div><div class="unlock-state"></div></div>';$(".locked-box").show(),$(".locked-box .item-box").append(c)}break;default:$(".cross-origin-box").show();var d=guid(8,"reload");if($("#"+d).length<1){var c='  <div class="item"  id="'+d+'" ><div  class="txt">URL:</div><div class=" val locked-image" >'+b.url+"</div></div>";$(".cross-origin-box .item-box").append(c),$("#"+d).click(function(){"dicom"==b.imageType?g(b).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)}):"jpg"==b.imageType&&h(b).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)})})}}}}function j(a,b){if(a){cornerstone.enable(a);var c=cornerstone.getEnabledElement(a);try{cornerstone.loadImage(b).then(function(b){!c.viewport||b.columnPixelSpacing==c.viewport.displayedArea.columnPixelSpacing&&b.rowPixelSpacing==c.viewport.displayedArea.rowPixelSpacing||(c.viewport=void 0),cornerstone.displayImage(a,b),b.hasOwnProperty("stack")&&(cornerstoneTools.addStackStateManager(a,["stack","playClip"]),cornerstoneTools.addToolState(a,"stack",b.stack),cornerstoneTools.playClip(a,b.cineRate))})}catch(d){console.error(d)}}}var k=iconv,l={},m={toolsState:["probeTouch","lengthTouch","angleTouch","rectangleRoiTouch","ellipticalRoiTouch","panTouchDrag","zoomTouchDrag"],intervalId:null,framesPerSecond:b.framesPerSecond,setAllElement:function(a){for(var b=0;b<r.winCount;b++)r.winArr[b].series&&a(r.winArr[b].element)},goToIndex:function(a,b){if(a){var c=a.stack,d=c.imageIds.length,e=parseInt(d*b);if(d>0){e<=0?c.currentImageIdIndex=0:e>=d?c.currentImageIdIndex=d-1:c.currentImageIdIndex=e;var f=c.imageIds[c.currentImageIdIndex],g=cornerstone.getEnabledElement(a.element);cornerstone.loadImage(f).then(function(b){b.columnPixelSpacing==g.viewport.displayedArea.columnPixelSpacing&&b.rowPixelSpacing==g.viewport.displayedArea.rowPixelSpacing||(g.viewport=void 0),cornerstone.displayImage(a.element,b)})}}},play:function(a){var b=this;a||(a=ViewerTab.viewer.getActiveWin()),this.intervalId=setInterval(function(){b.framesPerSecond>0&&(b.nextPage(a),BtnController.goToIndex(a.stack.currentImageIdIndex,a.stack.imageIds.length),a.stack.currentImageIdIndex==a.stack.imageIds.length&&(a.stack.currentImageIdIndex=-1))},1e3/Math.abs(b.framesPerSecond))},stop:function(){clearInterval(this.intervalId),this.intervalId=void 0},reset:function(){},invert:function(){},firstPage:function(a){this.pageChange(a,"first")},prevPage:function(a){this.pageChange(a,"prev")},nextPage:function(a){this.pageChange(a,"next")},pageChange:function(a,b){if(a){var c=a.stack,d=c.imageIds.length;if(d=a.series.dicomArr.length,d>0){"prev"==b?c.currentImageIdIndex<=0?c.currentImageIdIndex=0:c.currentImageIdIndex--:"next"==b?c.currentImageIdIndex<d-1?c.currentImageIdIndex++:c.currentImageIdIndex=d-1:"first"==b&&(c.currentImageIdIndex=0);var e=c.imageIds[c.currentImageIdIndex];if(e||(e=a.series.dicomArr[c.currentImageIdIndex].imageId),e){var f=cornerstone.getEnabledElement(a.element);cornerstone.loadImage(e).then(function(b){b.columnPixelSpacing!=f.viewport.displayedArea.columnPixelSpacing||b.rowPixelSpacing!=f.viewport.displayedArea.rowPixelSpacing?f.viewport=void 0:b.columns==f.viewport.displayedArea.brhc.x&&b.rows==f.viewport.displayedArea.brhc.y||(f.viewport=void 0),cornerstone.displayImage(a.element,b)})}}}},synchronizer:new cornerstoneTools.Synchronizer("cornerstonenewimage",cornerstoneTools.updateImageSynchronizer),referenceLine:function(a,b){var c=this;b?cornerstoneTools.referenceLines.tool.enable(a,c.synchronizer):cornerstoneTools.referenceLines.tool.disable(a,c.synchronizer)}},n={isObject:function(a){return"object"==typeof a}},o={imageObjArr:[],seriesArr:[],seriesDelayArr:[],JpgSeriesArr:[]},p={getDicomInfo:function(a){var b={},c=void 0!=a.string("x00080005")?a.string("x00080005"):"ISO_IR 100";if(c=c?c.toUpperCase():void 0,"ISO_IR 192"==c||"ISO 10646-1"==c||"ISO 10646-2"==c)return p.infoDecode(a,b,"UTF-8"),b;if(n.isObject(jschardet)){if(c&&c.indexOf("GB")<0){var d=a.string("x00100010"),e=a.string("x00080080"),f=a.string("x00081030"),g=jschardet.detect(d+e+f);c=n.isObject(g)&&g.confidence>.5?g.encoding.toUpperCase():"GB18030"}}else c="GB18030";return c&&k.encodingExists(c)?p.infoDecode(a,b,c):c&&c.indexOf("GB")>-1?(c="GB18030",p.infoDecode(a,b,c)):(console.log("没有特别编码  或者为 不能识别的编码方式"),c="GB18030",p.infoDecode(a,b,c)),b},matchDict:function(a){var b=a.tag;b&&(b="("+b.substr(1,4).toUpperCase()+","+b.substr(5,4).toUpperCase()+")",TAG_DICT[b]&&n.isObject(TAG_DICT[b])&&(a.des=TAG_DICT[b].name))},infoDecode:function(a,b,c){b.PatientInfo={PatientName:{tag:"x00100010",val:"",des:"",type:"data-dicom"},PatientID:{tag:"x00100020",val:"",des:"",type:"data-dicom"},PatientBirthDate:{tag:"x00100030",val:"",des:"",type:"data-dicom"},PatientBirthTime:{tag:"x00100032",val:"",des:"",type:"data-dicom"},PatientsAge:{tag:"x00101010",val:"",des:"",type:"data-dicom"},PatientSex:{tag:"x00100040",val:"",des:"",type:"data-dicom"},PatientWeight:{tag:"x00101030",val:"",des:"",type:"data-dicom"},PregnancyStatus:{tag:"x001021c0",val:"",des:"",type:"data-dicom"},AccessionNumber:{tag:"x00080050",val:"",des:"",type:"data-dicom"},PatientPosition:{tag:"x00185100",val:"",des:"",type:"data-dicom"}},b.StudyInfo={StudyDescription:{tag:"x00081030",val:"",des:"",type:"data-dicom"},ProtocolName:{tag:"x00181030",val:"",des:"",type:"data-dicom"},Accession:{tag:"x00080050",val:"",des:"",type:"data-dicom"},StudyId:{tag:"x00200010",val:"",des:"",type:"data-dicom"},StudyDate:{tag:"x00080020",val:"",des:"",type:"data-dicom"},StudyTime:{tag:"x00080030",val:"",des:"",type:"data-dicom"},ModalitiesInStudy:{tag:"x00080061",val:"",des:"",type:"data-dicom"}},b.SeriesInfo={SeriesDescription:{tag:"x0008103e",val:"",des:"",type:"data-dicom"},SeriesNo:{tag:"x00200011",val:"",des:"",type:"data-dicom"},Modality:{tag:"x00080060",val:"",des:"",type:"data-dicom"},BodyPart:{tag:"x00180015",val:"",des:"",type:"data-dicom"},SeriesDate:{tag:"x00080021",val:"",des:"",type:"data-dicom"},SeriesTime:{tag:"x00080031",val:"",des:"",type:"data-dicom"},SliceThickness:{tag:"x00180050",val:"",des:"",type:"data-dicom"},SpacingBetweenSlices:{tag:"x00180088",val:"",des:"",type:"data-dicom"},SliceLocation:{tag:"x00201041",val:"",des:"",type:"data-dicom"},MRAcquisition:{tag:"x00180023",val:"",des:"",type:"data-dicom"},FlipAngle:{tag:"x00181314",val:"",des:"",type:"data-dicom"}},b.InstanceInfo={InstanceNumber:{tag:"x00200013",val:"",des:"",type:"data-dicom"},ContentDate:{tag:"x00080023",val:"",des:"",type:"data-dicom"},ContentTime:{tag:"x00080033",val:"",des:"",type:"data-dicom"},AcquisitionNumber:{tag:"x00200012",val:"",des:"",type:"data-dicom"},AcquisitionDate:{tag:"x00080022",val:"",des:"",type:"data-dicom"},AcquisitionTime:{tag:"x00080032",val:"",des:"",type:"data-dicom"}},b.ImageInfo={Rows:{tag:"x00280010",val:"",des:"",type:"data-dicomUint"},Columns:{tag:"x00280011",val:"",des:"",type:"data-dicomUint"},PhotometricInterpretation:{tag:"x00280004",val:"",des:"",type:"data-dicom"},ImageType:{tag:"x00080008",val:"",des:"",type:"data-dicom"},FramesNumber:{tag:"x00280008",val:"",des:"",type:"data-dicom"},BitsAllocated:{tag:"x00280100",val:"",des:"",type:"data-dicomUint"},BitsStored:{tag:"x00280101",val:"",des:"",type:"data-dicomUint"},HighBit:{tag:"x00280102",val:"",des:"",type:"data-dicomUint"},PixelRepresentation:{tag:"x00280103",val:"",des:"",type:"data-dicomUint"},RescaleSlope:{tag:"x00281053",val:"",des:"",type:"data-dicom"},RescaleIntercept:{tag:"x00281052",val:"",des:"",type:"data-dicom"},ImagePositionPatient:{tag:"x00200032",val:"",des:"",type:"data-dicom"},ImageOrientationPatient:{tag:"x00200037",val:"",des:"",type:"data-dicom"},PixelSpacing:{tag:"x00280030",val:"",des:"",type:"data-dicom"},ImagerPixelSpacing:{tag:"x00181164",val:"",des:"",type:"data-dicom"},SamplesPerPixel:{tag:"x00280002",val:"",des:"",type:"data-dicomUint"},WindowCenter:{tag:"x00281050",val:"",des:"",type:"data-dicomUint"},WindowWidth:{tag:"x00281051",val:"",des:"",type:"data-dicomUint"},RescaleType:{tag:"x00281054",val:"",des:"",type:"data-dicomUint"},FieldofView:{tag:"x00180094",val:"",des:"",type:"data-dicom"}},b.EquipmentInfo={Manufacturer:{tag:"x00080070",val:"",des:"",type:"data-dicom"},Model:{tag:"x00081090",val:"",des:"",type:"data-dicom"},StationName:{tag:"x00081010",val:"",des:"",type:"data-dicom"},AETitle:{tag:"x00020016",val:"",des:"",type:"data-dicom"},InstitutionName:{tag:"x00080080",val:"",des:"",type:"data-dicom"},SoftwareVersion:{tag:"x00181020",val:"",des:"",type:"data-dicom"},ImplementationVersionNam:{tag:"x00020013",val:"",des:"",type:"data-dicom"}},b.UIDS={StudyUID:{tag:"x0020000d",val:"",des:"",type:"data-dicom"},SeriesUID:{tag:"x0020000e",val:"",des:"",type:"data-dicom"},InstanceUID:{tag:"x00080018",val:"",des:"",type:"data-dicom"},SOPClassUID:{tag:"x00080016",val:"",des:"",type:"data-dicom"},TransferSyntaxUID:{tag:"x00020010",val:"",des:"",type:"data-dicom"},FrameOfReferenceUID:{tag:"x00200052",val:"",des:"",type:"data-dicom"}},b.SomeUsefulInfo={MagneticFieldStrength:{tag:"x00180087",val:"",des:"",type:"data-dicom"},RepetitionTime:{tag:"x00180080",val:"",des:"",type:"data-dicom"},EchoTime:{tag:"x00180081",val:"",des:"",type:"data-dicom"},kvp:{tag:"x00180060",val:"",des:"",type:"data-dicom"},mA:{tag:"x00181151",val:"",des:"",type:"data-dicom"},ww:{tag:"x00281051",val:"",des:"",type:"data-dicom"},wc:{tag:"x00281050",val:"",des:"",type:"data-dicom"},minPixelValue:{tag:"x00280106",val:"",des:"",type:"data-dicom"},maxPixelValue:{tag:"x00280107",val:"",des:"",type:"data-dicom"}};var d={};for(var e in a.elements){var f=a.elements[e].tag,g=!0;for(var h in b){var i=b[h];for(var j in i)if(i[j].tag==f){g=!1;break}}g&&(d[e]={tag:f,val:"",des:"",type:"data-dicom"})}b.others=d;try{for(var e in b){var i=b[e];for(var h in i){var l=i[h];if(!(h>"x7fe00010"||"x7fe00010"==l.tag)){p.matchDict(l);var f=l.tag;if("data-dicom"==l.type){var m=a.elements[f],n="";if(void 0!==m){var o=a.string(f);if(void 0!==o)if(c)if("UTF-8"==c)n=k.decode(o,c);else{for(var q=new Uint8Array(o.length),j=0;j<q.length;j++){var r=o.charCodeAt(j);q[j]=r}n=k.decode(q,c)}else n=o}l.val=n}else if("data-dicomUint"==l.type){var m=a.elements[f],n="";void 0!==m&&(2===m.length?n+=a.uint16(f):4===m.length&&(n+=a.uint32(f))),l.val=n}}}}}catch(s){console.error("infoSet iconv error"),console.error(s)}},unFiling:function(a){},verify:function(a){return{state:!0}}},q=b.loadCountTH,r={maxWinNo:4,winCount:1,winIndex:1,winArr:[],initWinArr:function(){var a=this;return $(".wrapper").each(function(){var b=$(this).attr("id"),c=$(this).find(".viewport").attr("id"),d=$(this).attr("data-winNo"),e=$(this).find(".viewport").get(0);cornerstone.enable(e),cornerstoneTools.touchInput.enable(e);var f={winNo:d,wrapperId:b,viewportId:c,imgObjArr:[],element:e,seriesId:void 0,stack:{currentImageIdIndex:0,imageIds:[]}};a.winArr.push(f),e.addEventListener("cornerstoneimagerendered",a.onViewportUpdated)}),a.winArr[0]},getActiveWin:function(){var a=this,b=parseInt($(".wrapper-check").attr("data-winNo"));if(a.winArr[b].series){var c=[];a.winArr[b].series.dicomArr.forEach(function(a){c.push(a.imageId)}),a.winArr[b].stack.imageIds=c}return a.winArr[b]},onViewportUpdated:function(a){var b=a.target;if(b){var c=$(b).attr("id"),d=parseInt($("#"+c).parents(".wrapper").attr("data-winno"));r.fillInfo(r.winArr[d])}},isInSameWin:function(a,b){return $(a).parents(".wrapper").get(0)==$(b).parents(".wrapper").get(0)},isInWin:function(a,b){var c=b.element;return a==c},fillInfo:function(a){var b=a.viewportId,c=a.stack.currentImageIdIndex,d=a.series.dicomArr.length,e=a.series.dicomArr[c].infoSet,f=[];e.EquipmentInfo.InstitutionName.val&&f.push({"class":"institutionName-item",text:"机构："+e.EquipmentInfo.InstitutionName.val}),f.push({"class":"index-item",text:"图像号："+(c+1)+"/"+d}),e.StudyInfo.StudyId.val&&f.push({"class":"studyId-item",text:"检查ID："+e.StudyInfo.StudyId.val}),e.PatientInfo.PatientID.val&&f.push({"class":"patientId-item",text:"病人ID："+e.PatientInfo.PatientID.val}),e.PatientInfo.PatientName.val&&f.push({"class":"patientName-item",text:"姓名："+e.PatientInfo.PatientName.val}),e.PatientInfo.PatientSex.val&&f.push({"class":"patientSex-item",text:"性别："+e.PatientInfo.PatientSex.val}),e.PatientInfo.PatientsAge.val&&f.push({"class":"patientAge-item",text:"年龄："+e.PatientInfo.PatientsAge.val});var g=[],h=$("#"+b).get(0),i=cornerstone.getViewport(h);g.push({"class":"scale-item",text:"缩放："+i.scale.toFixed(2)}),e.SomeUsefulInfo.kvp.val&&g.push({"class":"kvp-item",text:"电压："+e.SomeUsefulInfo.kvp.val+"kvp"}),e.SomeUsefulInfo.mA.val&&g.push({"class":"ma-item",text:"电流："+e.SomeUsefulInfo.mA.val+"mA"}),e.SeriesInfo.SliceThickness.val&&g.push({"class":"sliceThickness-item",text:"层厚："+e.SeriesInfo.SliceThickness.val+"mm"}),g.push({"class":"wwwc-item",text:"窗位/窗宽："+parseInt(i.voi.windowCenter)+"/"+parseInt(i.voi.windowWidth)}),$("#"+a.wrapperId).find(".info-overlay").remove(),$("#"+a.wrapperId).append(template("infoLayTemp",{ltIfoObj:f,lbIfoObj:g}))},emptyInfo:function(a){}},s={findSeriesByElement:function(a){var b=$(a).parents(".wrapper").attr("id"),c=_.find(r.winArr,function(a){return a.winId==b});if(!_.isUndefined(c)){var d=c.seriesId,e=dvStruct.findSeries(d);return e}},findSeries:function(a){return _.find(o.seriesArr,function(b){return b.seriesId==a})},findDelaySeries:function(a){return o.seriesDelayArr[a]},insertDicom:function(){},addJpg:function(a){var b=this,c=o.JpgSeriesArr[a.seriesCode];if(c)c.push(a);else{c=[],c.push(a);var d=$(template("jpgPreviewTemp",{seriesCode:a.seriesCode,url:a.url,seriesNo:a.seriesNo,seriesLen:a.seriesLen}));$(".jpg-thumbnail-container").find(".thumbnail").append(d),o.JpgSeriesArr[a.seriesCode]=c,b.bindJpgSeriesImport(d)}var e=$(".jpg-img-box").find(".swiper-slide").length+1;$(".jpg-img-box").append(template("jpgScanTemp",{url:a.url,index:e}));new Swiper(".swiper-container-jpg",{slidesPerView:"auto",freeMode:!1}),new Swiper(".jpg-img-container",{pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},onSlideChangeEnd:function(){return!1}})},addDelayDcm:function(a){var b=this.findDelaySeries(a.seriesId);b||(b=[]),b.push(a),o.seriesDelayArr[a.seriesId]=b},loadDelayDcm:function(a,b){var c=this,d=c.findDelaySeries(a);d&&d.length>0?jqalert({title:"数据加载提示",prompt:"是否加载完该序列的全部数据",yestext:"确定加载",notext:"暂不加载",yesfn:function(){for(;d.length>0;)d.forEach(function(a,b){a&&(g(a).then(function(a){a.isSuccess||a.hasOwnProperty("statusText")&&i(a)}),d.splice(b,1))});b()},nofn:function(){b()},click_bg:!1}):b()},addDcm:function(a,b){var c=this,d=b.seriesId,e=c.findSeries(d);e?c.dicomInsert(e,a):(e=c.addSeries(d,a,b),r.winIndex<=r.maxWinNo&&0!=r.winIndex&&c.bindSeries(r.winArr[--r.winIndex],d)),c.dicomAdded(d,a,e,b)},addSeries:function(a,b,c){var d={seriesId:a,dicomArr:[],sNo:b.infoSet.SeriesInfo.SeriesNo.val,sideImageIds:[]};return this.insertSeries(d),d.dicomArr.push(b),d.sideImageIds.push({farsideImageId:b.imageId,nearsideImageId:b.imageId}),d.offset=void 0,d},insertSeries:function(a){if(0==o.seriesArr.length)return void o.seriesArr.push(a);for(var b=0;b<o.seriesArr.length;b++)if(!firstIsBigger(a.seriesId,o.seriesArr[b].seriesId))return void o.seriesArr.splice(b,0,a);o.seriesArr.push(a)},dicomInsert:function(a,b){if(0==a.dicomArr.length)return void a.dicomArr.push(b);for(var c=0;c<a.dicomArr.length;c++)if(parseInt(b.instanceNo)<parseInt(a.dicomArr[c].instanceNo))return a.dicomArr.splice(c,0,b),!1;a.dicomArr.push(b)},dicomAdded:function(a,b,c,d){var e=b.infoSet.SeriesInfo.SeriesNo.val,f=this,g=$(".dicom-thumbnail-container"),h=guid(8,"preview"),i=guid(8,"preEle");g.find(".series-preview-dcm[data-seriesId='"+a+"']").length<1&&($(".series-preview-dcm").length>0&&$(".series-preview-dcm[data-seriesId='"+a+"']").length<1&&$(".series-preview-dcm").each(function(){var b=$(this).attr("data-seriesNo");if(parseInt(b)>parseInt(e))return $(this).before(template("seriesPreviewTemp",{seriesId:a,seriesNo:e,id2:i,id1:h,total:d.seriesLen,instanceNo:d.instanceNo})),!1}),$(".series-preview-dcm[data-seriesId='"+a+"']").length<1&&g.find(".thumbnail").append(template("seriesPreviewTemp",{seriesId:a,seriesNo:e,id2:i,id1:h,total:d.seriesLen,instanceNo:d.instanceNo})));var k=g.find(".series-preview-dcm[data-seriesId='"+a+"']").find(".series-img-box").get(0);if(k){var l=$(k).attr("instanceNo");if(parseInt(d.instanceNo)<=parseInt(l)){j(k,b.imageId);var m=parseInt($(".wrapper[data-seriesId='"+a+"']").attr("data-winNo"));f.bindSeriesImport($("#"+h)),ViewerTab.tools.firstPage(ViewerTab.viewer.winArr[m]),$(k).attr("instanceNo",d.instanceNo)}$(".wrapper[data-seriesId='"+a+"']").find("div[data-itemName=index-item]").text("图像号：1/"+c.dicomArr.length)}if(1==d.detail.urlMode){var c=f.findSeries(a);$(".series-preview-dcm[data-seriesId='"+a+"']").find(".series-num").text(e+"--"+c.dicomArr.length)}},bindSeriesImport:function(a){var b=this;a.swipe({click:function(){$(".series-preview-dcm").removeClass("series-preview-check"),$(this).addClass("series-preview-check");var a=$(this).attr("data-seriesId"),c=parseInt($(".wrapper-check").attr("data-winNo")),d=r.winArr[c];b.loadDelayDcm(a,function(){b.bindSeries(d,a)})}})},bindJpgSeriesImport:function(a){a.swipe({click:function(){console.log("import jpg series"),$(this).addClass("series-preview-check").siblings().removeClass("series-preview-check");var a=$(this).attr("data-seriesCode"),b=o.JpgSeriesArr[a],c=$(".jpg-img-box");c.empty(),b.forEach(function(a,b){c.append(template("jpgScanTemp",{url:a.url,index:b+1}))});new Swiper(".jpg-img-container",{pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},onSlideChangeEnd:function(){return!1}})}})},bindSeries:function(a,b){if(a){var c=this;$(".wrapper-check").attr("data-seriesId",b);var d=a.element,e=c.findSeries(b);a.series=e,a.stack.currentImageIdIndex=0;var f=e.dicomArr[0].imageId;cornerstone.disable(d),cornerstone.enable(d);try{cornerstone.loadImage(f).then(function(b){cornerstone.displayImage(d,b),cornerstoneTools.wwwcTouchDrag.activate(d),b.hasOwnProperty("stack")&&(cornerstoneTools.addStackStateManager(d,["stack","playClip"]),cornerstoneTools.addToolState(d,"stack",b.stack),cornerstoneTools.playClip(d,b.cineRate)),r.fillInfo(a)})}catch(g){console.error(g)}}}},t={activeWin:void 0,datas:o,sets:l,tools:m,loaders:p,loading:f(a),viewer:r,series:s,
typeCheck:n};return t};